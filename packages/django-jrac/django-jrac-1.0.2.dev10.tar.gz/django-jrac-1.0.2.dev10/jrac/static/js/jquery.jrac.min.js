!function(i){i.fn.jrac=function(t){var o={crop_width:200,crop_height:100,crop_x:0,crop_y:0,crop_resize:!0,crop_aspect_ratio:null,image_width:null,image_height:null,zoom_min:100,zoom_max:3e3,zoom_label:"",viewport_image_surrounding:!1,viewport_width:null,viewport_height:null,viewport_resize:!0,viewport_content_left:0,viewport_content_top:0,viewport_onload:null};return this.each(function(){if(i(this).is("img")){var e=!1;"object"==typeof t?i.extend(o,t):"destroy"==t&&(e=!0);var r=i(this),a=!1;if(r.parent().hasClass("jrac_viewport")&&(a=!0),a&&e?(r.draggable("destroy"),r.parent().find(".jrac_crop").remove(),r.parent().parent().find(".jrac_zoom_slider").remove(),r.parent().append(r.data("original")),r.parent().unwrap(),r.unwrap(),r.remove()):r.data("original",r.clone()),!e){a||r.hide().css("position","absolute").wrap('<div class="jrac_container"><div class="jrac_viewport"></div></div>');var n=r.parent(),s=n.parent(),_=i('<div class="jrac_loading" />');n.append(_);var c=function(){if(i.extend(r,{scale_proportion_locked:!0,originalWidth:r.width(),originalHeight:r.height()}),r.width(o.image_width).height(o.image_height),o.viewport_image_surrounding?n.width(r.width()).height(r.height()):n.width(o.viewport_width).height(o.viewport_height),r.css({left:o.viewport_content_left,top:o.viewport_content_top}),!a){if(o.zoom_label){var t=i('<div class="jrac_zoom_slider_label">'+o.zoom_label+"</div>");s.append(t)}var e=i('<div class="jrac_zoom_slider"><div class="ui-slider-handle"></div></div>').slider({value:r.width(),min:o.zoom_min,max:o.zoom_max,start:function(t,o){i.extend(e,{on_start_width_value:o.value,on_start_height_value:r.height()})},slide:function(i,t){var o=Math.round(e.on_start_height_value*t.value/e.on_start_width_value);r.height(o),r.width(t.value),n.observator.notify("jrac_image_height",o),n.observator.notify("jrac_image_width",t.value)}});s.append(e),o.viewport_resize&&n.resizable(),r.draggable({drag:function(i,t){t.position.left!=t.originalPosition.left&&n.observator.notify("jrac_crop_x",n.observator.crop_position_x()),t.position.top!=t.originalPosition.top&&n.observator.notify("jrac_crop_y",n.observator.crop_position_y())}});var c=i('<div class="jrac_crop"><div class="jrac_crop_drag_handler"></div></div>').css({width:o.crop_width,height:o.crop_height,left:o.crop_x+o.viewport_content_left,top:o.crop_y+o.viewport_content_top}).draggable({containment:n,handle:"div.jrac_crop_drag_handler",drag:function(i,t){t.position.left!=t.originalPosition.left&&n.observator.notify("jrac_crop_x",n.observator.crop_position_x()),t.position.top!=t.originalPosition.top&&n.observator.notify("jrac_crop_y",n.observator.crop_position_y())}});o.crop_resize&&c.resizable({containment:n,aspectRatio:o.crop_aspect_ratio,resize:function(i,t){t.size.width!=t.originalSize.width&&n.observator.notify("jrac_crop_width",c.width()),t.size.height!=t.originalSize.height&&n.observator.notify("jrac_crop_height",c.height())}}),n.append(c)}i.extend(n,{$container:s,$image:r,$crop:c,$zoom_widget:e,observator:{items:{},register:function(i,t,o){i&&t&&(this.items[i]={element:t,callback:o})},unregister:function(i){delete this.items[i]},notify:function(t,o){if(this.items[t]){var e=this.items[t].element,a=this.items[t].callback;e.trigger(t,[n,o]),i.isFunction(a)&&a.call(n,t,e,o)}r.trigger("jrac_events",[n])},notify_all:function(){this.notify("jrac_crop_x",this.crop_position_x()),this.notify("jrac_crop_y",this.crop_position_y()),this.notify("jrac_crop_width",c.width()),this.notify("jrac_crop_height",c.height()),this.notify("jrac_image_width",r.width()),this.notify("jrac_image_height",r.height())},crop_position_x:function(){return c.position().left-r.position().left},crop_position_y:function(){return c.position().top-r.position().top},crop_consistent:function(){return this.crop_position_x()>=0&&this.crop_position_y()>=0&&this.crop_position_x()+c.width()+2*parseInt(c.css("border-width"),10)<=r.width()&&this.crop_position_y()+c.height()+2*parseInt(c.css("border-width"),10)<=r.height()},set_property:function(i,t){if(t=parseInt(t),!isNaN(t)){switch(i){case"jrac_crop_x":c.css("left",t+r.position().left);break;case"jrac_crop_y":c.css("top",t+r.position().top);break;case"jrac_crop_width":c.width(t);break;case"jrac_crop_height":c.height(t);break;case"jrac_image_width":if(r.scale_proportion_locked){var o=Math.round(r.height()*t/r.width());r.height(o),this.notify("jrac_image_height",o)}r.width(t),e.slider("value",t);break;case"jrac_image_height":if(r.scale_proportion_locked){var a=Math.round(r.width()*t/r.height());r.width(a),this.notify("jrac_image_width",a),e.slider("value",a)}r.height(t)}this.notify(i,t)}}}}),_.hide(),_.remove(),r.show(),i.isFunction(o.viewport_onload)&&(o.viewport_onload.call(n),n.observator.notify_all())},h=r.attr("src");/^data:image/.test(h)?c():(h=h+(h.search(/\?/)<0?"?":"&")+"jracrandom="+(new Date).getTime(),i("<img>").attr("src",h).load(c))}}})}}(jQuery);
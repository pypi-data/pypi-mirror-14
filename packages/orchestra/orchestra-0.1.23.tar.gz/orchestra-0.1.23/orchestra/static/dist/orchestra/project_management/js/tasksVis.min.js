!function(){"use strict";var t=angular.module("orchestra.project_management.services");t.factory("tasksVis",["$modal","dataService","orchestraApi","visUtils","assignmentsVis","crosshair","axis",function(t,e,a,s,n,r,i){var o=function(t){var e={step:t.task.step_slug,change:t.change,assignments:{}};return t.assignments.forEach(function(t){e.assignments[t.assignment.worker.username]={change:t.change,snapshots:t.snapshots}}),e},l=function(t,e){for(var a,s=0;s<e.length&&!(a=t.classed(e[s]));s++);return a};return{reverting:!1,draw:function(){var t=this,a=s.parentContainer.selectAll(".task-view").data(e.timeSortedSlugs,function(t){return t});a.exit().remove();var r=a.enter().append("div").attr("class","task-view"),o=r.append("svg").attr("class","task-svg").style("margin-left",s.params.marginLeft+"px");a.selectAll(".task-svg").attr("width",s.getSvgWidth()),a.style("width",s.getSvgWidth()+s.params.marginLeft+"px");var c=o.append("g").attr("class","task");a.selectAll(".task").transition().attr({transform:function(t){var a=e.taskFromKey(t);return s.translateString(i.getOffset(a.start_datetime),s.params.lanePadding.top)}}),t.drawRevertFlags(),n.draw();c.append("rect").attr({"class":"task-rect",height:s.params.barHeight,"fill-opacity":0,stroke:"black"});a.selectAll(".task-rect").transition().attr("width",function(t){var a=e.taskFromKey(t);return i.getOffset(e.taskEnd(a))-i.getOffset(a.start_datetime)}).each(function(a){e.taskFromKey(a);t.expand(d3.select(t.parentNode))}),a.on("click",function(a){var s=(e.taskFromKey(a),d3.select(d3.event.target)),n=["task-view","task-svg","task-rect"];if(l(s,n)){var r=(e.taskFromKey(a),e.taskMeta(a,"expandAssignments"));e.taskMeta(a,"expandAssignments",!r),t.distribute()}}),this.drawMeta(),this.drawBackgrounds(),t.distribute()},drawMeta:function(){var t=this,a=d3.select(".task-names").selectAll(".task-name").data(e.timeSortedSlugs,function(t){return t});a.exit().remove();var s=a.enter().append("div").attr("class","task-name");s.append("span").attr("class","step-slug");var n=s.append("div").attr("class","task-action-wrapper"),r=a.selectAll(".task-action-wrapper").selectAll(".skip-task").data(function(t){return"Complete"!=e.taskFromKey(t).status?[t]:[]});r.exit().remove(),r.enter().append("button").attr("class","skip-task task-action btn btn-danger btn-xs").text("Skip task").on("click",function(a){t.completeAndSkipTask(e.taskFromKey(a))}),n.append("a").attr({href:function(t){return e.taskFromKey(t).admin_url},target:"_blank","class":"task-action"}).append("button").attr("class","btn btn-default btn-xs").text("View in admin"),s.append("span").attr("class","step-status"),a.selectAll(".step-slug").text(function(t){var a=e.taskFromKey(t);return a.step_slug}),a.selectAll(".step-status").text(function(t){var a=e.taskFromKey(t);return a.status})},drawBackgrounds:function(){d3.selectAll(".task-name").style("background-color",function(t,e,a){return e%2==0?"#eee":"white"}),s.parentContainer.selectAll(".task-view").style("background-color",function(t,e){return e%2==0?"#eee":"white"})},drawRevertFlags:function(){var t=this,a=s.parentContainer.selectAll(".task"),n=a.selectAll(".revert-group").data(function(t){var a=e.taskFromKey(t),s=[];return a.assignments.forEach(function(t){t.iterations&&t.iterations.forEach(function(t){s.push({datetime:new Date(t.start_datetime),taskKey:a.step_slug})})}),e.inProgressAssignment(a)||s.push({datetime:new Date(e.taskEnd(a)),taskKey:a.step_slug}),s},function(t){return t.datetime});n.exit().remove();var o=n.enter().append("g").attr("class","revert-group");o.append("line").attr({"class":"revert-line",stroke:"rgb(0, 121, 191)"}),o.append("path").attr({d:"M0,0 V4 L-2,2 Z",fill:"rgb(0, 121, 191)",transform:s.translateString(0,-s.params.lanePadding.top/2)+" scale(3, 3)"}).style("cursor","pointer").on("mouseenter",function(e){t.reverting||(r.move(e.datetime),r.show())}).on("mouseleave",function(e){t.reverting||r.hide()}).on("click",function(a){var s=e.taskFromKey(a.taskKey).id;t.revertTask(s,a.datetime)}),n.transition().attr({transform:function(t){var a=e.taskFromKey(t.taskKey).start_datetime;return s.translateString(i.timeScale(t.datetime)-i.getOffset(a),0)}}),n.selectAll(".revert-line").transition().attr({y1:-s.params.lanePadding.top/2,y2:function(t){var a=t.taskKey,n=e.taskFromKey(a);return e.taskMeta(a,"expandAssignments")?(n.assignments.length+1)*s.params.barHeight+1:s.params.barHeight+1}})},expand:function(){var t=d3.selectAll(".task-view");t.selectAll(".assignments").transition().attr("transform",function(t){var a=e.taskMeta(t,"expandAssignments");s.translateString(0,a?s.params.barHeight:0)}),t.selectAll(".assignment").transition().attr({transform:function(t,a){var n=e.assignmentFromKey(t),r=e.keyFromTask(n.task),i=e.taskMeta(r,"expandAssignments");return s.translateString(0,i?s.params.barHeight*(a+1):0)}}),t.selectAll(".assignment-meta").transition().style({position:"absolute",top:function(t,a){var n=e.assignmentFromKey(t),r=e.keyFromTask(n.task),i=e.taskMeta(r,"expandAssignments");return i?s.params.barHeight*(a+1)+s.params.lanePadding.top+4+"px":s.params.lanePadding.top+"px"},right:function(t){var a=e.assignmentFromKey(t);return s.getSvgWidth()-i.getOffset(a.task.start_datetime)+10+"px"},display:function(t,a){var s=e.assignmentFromKey(t),n=e.keyFromTask(s.task),r=e.taskMeta(n,"expandAssignments");return r?"inherit":"none"}}),t.selectAll(".active-assignment").attr("display",function(t){var a=e.assignmentFromKey(t),s=e.keyFromTask(a.task),n=e.taskMeta(s,"expandAssignments");return n?"inherit":"none"})},distribute:function(){s.parentContainer.selectAll(".task-svg").transition().attr({height:function(t){var a=e.taskFromKey(t);return s.getTaskHeight(a)}});var t=d3.selectAll(".task-names").style("margin-top",s.params.scaleHeight+"px");t.selectAll(".task-name").transition().style({height:function(t,a){var n=e.taskFromKey(t);return s.getTaskHeight(n)+"px"},"padding-top":s.params.lanePadding.top/2+"px"});this.drawRevertFlags(),this.expand()},completeAndSkipTask:function(t){confirm("Are you sure you want to skip this task and mark it as complete? This might leave the project in a corrupted/unrecoverable state.")&&a.completeAndSkipTask(t).then(function(){e.updateData()},function(t){var e="Error skipping task.";400===t.status&&(e=t.data.message),alert(e)})},revertTask:function(s,n){var i=this;i.reverting||(i.reverting=!0,a.revertTask(s,n,!0).then(function(l){var c=t.open({templateUrl:"/static/orchestra/project_management/partials/revert_modal.html",controller:["$scope",function(t){t.audit=o(l.data),t.cancel=c.close,t.confirmRevert=function(){a.revertTask(s,n,!1).then(function(){e.updateData()},function(t){var e="Could not revert task.";400===t.status&&(e=t.data.message),alert(e)})["finally"](function(){c.close()})}}]});c.result["finally"](function(){i.reverting=!1,r.hide()})},function(t){var e="Could not generate revert information.";400===t.status&&(e=t.data.message),alert(e)}))}}}])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvdGFza3NWaXMuanMiXSwibmFtZXMiOlsic2VydmljZU1vZHVsZSIsImFuZ3VsYXIiLCJtb2R1bGUiLCJmYWN0b3J5IiwiJG1vZGFsIiwiZGF0YVNlcnZpY2UiLCJvcmNoZXN0cmFBcGkiLCJ2aXNVdGlscyIsImFzc2lnbm1lbnRzVmlzIiwiY3Jvc3NoYWlyIiwiYXhpcyIsIl9odW1hbml6ZUF1ZGl0IiwiYXVkaXQiLCJodW1hbkF1ZGl0Iiwic3RlcCIsInRhc2siLCJzdGVwX3NsdWciLCJjaGFuZ2UiLCJhc3NpZ25tZW50cyIsImZvckVhY2giLCJhc3NpZ25tZW50QXVkaXQiLCJhc3NpZ25tZW50Iiwid29ya2VyIiwidXNlcm5hbWUiLCJzbmFwc2hvdHMiLCJfaGFzT25lQ2xhc3NGcm9tIiwidGFyZ2V0IiwiY2xhc3NlcyIsImNscyIsImkiLCJsZW5ndGgiLCJjbGFzc2VkIiwicmV2ZXJ0aW5nIiwiZHJhdyIsInRhc2tzVmlzIiwidGhpcyIsInRhc2tWaWV3cyIsInBhcmVudENvbnRhaW5lciIsInNlbGVjdEFsbCIsImRhdGEiLCJ0aW1lU29ydGVkU2x1Z3MiLCJzbHVnIiwiZXhpdCIsInJlbW92ZSIsInRhc2tWaWV3c0VudGVyIiwiZW50ZXIiLCJhcHBlbmQiLCJhdHRyIiwidGFza1N2Z3NFbnRlciIsInN0eWxlIiwicGFyYW1zIiwibWFyZ2luTGVmdCIsImdldFN2Z1dpZHRoIiwidGFza3NFbnRlciIsInRyYW5zaXRpb24iLCJ0cmFuc2Zvcm0iLCJ0YXNrS2V5IiwidGFza0Zyb21LZXkiLCJ0cmFuc2xhdGVTdHJpbmciLCJnZXRPZmZzZXQiLCJzdGFydF9kYXRldGltZSIsImxhbmVQYWRkaW5nIiwidG9wIiwiZHJhd1JldmVydEZsYWdzIiwiY2xhc3MiLCJoZWlnaHQiLCJiYXJIZWlnaHQiLCJmaWxsLW9wYWNpdHkiLCJzdHJva2UiLCJ0YXNrRW5kIiwiZWFjaCIsImV4cGFuZCIsImQzIiwic2VsZWN0IiwicGFyZW50Tm9kZSIsIm9uIiwiZXZlbnQiLCJleHBhbmRBc3NpZ25tZW50cyIsInRhc2tNZXRhIiwiZGlzdHJpYnV0ZSIsImRyYXdNZXRhIiwiZHJhd0JhY2tncm91bmRzIiwidGFza05hbWVzIiwidGFza05hbWVzRW50ZXIiLCJ0YXNrQWN0aW9uV3JhcHBlcnMiLCJhY3Rpb25zIiwic3RhdHVzIiwidGV4dCIsImNvbXBsZXRlQW5kU2tpcFRhc2siLCJocmVmIiwiYWRtaW5fdXJsIiwiaiIsInRhc2tzIiwicmV2ZXJ0R3JvdXBzIiwiZGF0ZXRpbWVzIiwiaXRlcmF0aW9ucyIsIml0ZXJhdGlvbiIsInB1c2giLCJkYXRldGltZSIsIkRhdGUiLCJpblByb2dyZXNzQXNzaWdubWVudCIsInJldmVydEdyb3Vwc0VudGVyIiwiZCIsImZpbGwiLCJkYXRldGltZUluZm8iLCJtb3ZlIiwic2hvdyIsImhpZGUiLCJ0YXNrSWQiLCJpZCIsInJldmVydFRhc2siLCJ0YXNrU3RhcnREYXRldGltZSIsInRpbWVTY2FsZSIsInkxIiwieTIiLCJhc3NpZ25tZW50S2V5IiwiYXNzaWdubWVudEZyb21LZXkiLCJrZXlGcm9tVGFzayIsInBvc2l0aW9uIiwicmlnaHQiLCJkaXNwbGF5IiwiZ2V0VGFza0hlaWdodCIsInRhc2tOYW1lc1dyYXBwZXIiLCJzY2FsZUhlaWdodCIsInBhZGRpbmctdG9wIiwiY29uZmlybSIsInRoZW4iLCJ1cGRhdGVEYXRhIiwicmVzcG9uc2UiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwiYWxlcnQiLCJtb2RhbEluc3RhbmNlIiwib3BlbiIsInRlbXBsYXRlVXJsIiwiY29udHJvbGxlciIsIiRzY29wZSIsImNhbmNlbCIsImNsb3NlIiwiY29uZmlybVJldmVydCIsInJlc3VsdCJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQUVBLElBQUlBLEdBQWlCQyxRQUFRQyxPQUFPLHdDQUVwQ0YsR0FBY0csUUFBUSxZQUFBLFNBQUEsY0FBQSxlQUFBLFdBQUEsaUJBQUEsWUFBQSxPQUFZLFNB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RixTQUUvQkMsTUFBTUYiLCJmaWxlIjoib3JjaGVzdHJhL3Byb2plY3RfbWFuYWdlbWVudC9qcy90YXNrc1Zpcy5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICB2YXIgc2VydmljZU1vZHVsZSA9ICBhbmd1bGFyLm1vZHVsZSgnb3JjaGVzdHJhLnByb2plY3RfbWFuYWdlbWVudC5zZXJ2aWNlcycpO1xuXG4gIHNlcnZpY2VNb2R1bGUuZmFjdG9yeSgndGFza3NWaXMnLCBmdW5jdGlvbigkbW9kYWwsIGRhdGFTZXJ2aWNlLCBvcmNoZXN0cmFBcGksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzVXRpbHMsIGFzc2lnbm1lbnRzVmlzLCBjcm9zc2hhaXIsIGF4aXMpIHtcbiAgICAvKipcbiAgICAgKiBTZXJ2aWNlIHRvIG1vZHVsYXJpemUgdGFzayB2aXN1YWxpemF0aW9uIGFuZCBtYW5pcHVsYXRpb24gd2l0aGluXG4gICAgICogdGhlIHByb2plY3QgbWFuYWdlbWVudCB2aWV3LlxuICAgICAqL1xuICAgIHZhciB0YXNrc1ZpcztcblxuICAgIHZhciBfaHVtYW5pemVBdWRpdCA9IGZ1bmN0aW9uKGF1ZGl0KSB7XG4gICAgICAvKipcbiAgICAgICAqIFNlbGVjdGl2ZWx5IHJlbmRlciBhIHJldmVydCBhdWRpdCBpbiBhIGh1bWFuLXJlYWRhYmxlIHdheS5cbiAgICAgICAqL1xuICAgICAgdmFyIGh1bWFuQXVkaXQgPSB7XG4gICAgICAgICdzdGVwJzogYXVkaXQudGFzay5zdGVwX3NsdWcsXG4gICAgICAgICdjaGFuZ2UnOiBhdWRpdC5jaGFuZ2UsXG4gICAgICAgICdhc3NpZ25tZW50cyc6IHt9LFxuICAgICAgfTtcbiAgICAgIGF1ZGl0LmFzc2lnbm1lbnRzLmZvckVhY2goZnVuY3Rpb24oYXNzaWdubWVudEF1ZGl0KSB7XG4gICAgICAgIGh1bWFuQXVkaXQuYXNzaWdubWVudHNbYXNzaWdubWVudEF1ZGl0LmFzc2lnbm1lbnQud29ya2VyLnVzZXJuYW1lXSA9IHtcbiAgICAgICAgICAnY2hhbmdlJzogYXNzaWdubWVudEF1ZGl0LmNoYW5nZSxcbiAgICAgICAgICAnc25hcHNob3RzJzogYXNzaWdubWVudEF1ZGl0LnNuYXBzaG90c1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBodW1hbkF1ZGl0XG4gICAgfVxuXG4gICAgdmFyIF9oYXNPbmVDbGFzc0Zyb20gPSBmdW5jdGlvbih0YXJnZXQsIGNsYXNzZXMpIHtcbiAgICAgIC8qKlxuICAgICAgICogRGV0ZXJtaW5lIGlmIGEgZDMgc2VsZWN0aW9uIGhhcyBhdCBsZWFzdCBvbmUgY2xhc3MgZnJvbSBhIGdpdmVuIGxpc3QuXG4gICAgICAgKi9cbiAgICAgIHZhciBjbHM7XG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY2xzID0gdGFyZ2V0LmNsYXNzZWQoY2xhc3Nlc1tpXSk7XG4gICAgICAgIGlmIChjbHMpIHsgYnJlYWs7IH1cbiAgICAgIH07XG4gICAgICByZXR1cm4gY2xzO1xuICAgIH07XG5cblxuICAgIHJldHVybiB7XG4gICAgICByZXZlcnRpbmc6IGZhbHNlLFxuICAgICAgZHJhdzogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEcmF3cy91cGRhdGVzIHRhc2tzIHdpdGhpbiBwcm9qZWN0IG1hbmFnZW1lbnQgdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrc1ZpcyA9IHRoaXM7XG4gICAgICAgIHZhciB0YXNrVmlld3MgPSB2aXNVdGlscy5wYXJlbnRDb250YWluZXIuc2VsZWN0QWxsKCcudGFzay12aWV3JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5kYXRhKGRhdGFTZXJ2aWNlLnRpbWVTb3J0ZWRTbHVncywgZnVuY3Rpb24oc2x1Zykge3JldHVybiBzbHVnfSk7XG4gICAgICAgIHRhc2tWaWV3cy5leGl0KCkucmVtb3ZlKCk7XG4gICAgICAgIHZhciB0YXNrVmlld3NFbnRlciA9IHRhc2tWaWV3cy5lbnRlcigpLmFwcGVuZCgnZGl2JylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAndGFzay12aWV3Jyk7XG5cbiAgICAgICAgdmFyIHRhc2tTdmdzRW50ZXIgPSB0YXNrVmlld3NFbnRlci5hcHBlbmQoJ3N2ZycpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3Rhc2stc3ZnJylcbiAgICAgICAgICAuc3R5bGUoJ21hcmdpbi1sZWZ0JywgdmlzVXRpbHMucGFyYW1zLm1hcmdpbkxlZnQgKyAncHgnKTtcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcudGFzay1zdmcnKS5hdHRyKCd3aWR0aCcsIHZpc1V0aWxzLmdldFN2Z1dpZHRoKCkpO1xuICAgICAgICB0YXNrVmlld3Muc3R5bGUoJ3dpZHRoJywgdmlzVXRpbHMuZ2V0U3ZnV2lkdGgoKSArIHZpc1V0aWxzLnBhcmFtcy5tYXJnaW5MZWZ0ICsgJ3B4Jyk7XG5cbiAgICAgICAgdmFyIHRhc2tzRW50ZXIgPSB0YXNrU3Znc0VudGVyLmFwcGVuZCgnZycpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3Rhc2snKTtcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcudGFzaycpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSk7XG4gICAgICAgICAgICAgIHJldHVybiB2aXNVdGlscy50cmFuc2xhdGVTdHJpbmcoYXhpcy5nZXRPZmZzZXQodGFzay5zdGFydF9kYXRldGltZSksIHZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3ApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KVxuXG4gICAgICAgIHRhc2tzVmlzLmRyYXdSZXZlcnRGbGFncygpO1xuXG4gICAgICAgIGFzc2lnbm1lbnRzVmlzLmRyYXcoKTtcblxuICAgICAgICB2YXIgdGFza1JlY3QgPSB0YXNrc0VudGVyLmFwcGVuZCgncmVjdCcpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2NsYXNzJzogJ3Rhc2stcmVjdCcsXG4gICAgICAgICAgICAnaGVpZ2h0JzogdmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCxcbiAgICAgICAgICAgICdmaWxsLW9wYWNpdHknOiAwLFxuICAgICAgICAgICAgJ3N0cm9rZSc6ICdibGFjaycsXG4gICAgICAgICAgfSlcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcudGFzay1yZWN0JylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoJ3dpZHRoJywgZnVuY3Rpb24oc2x1Zykge1xuICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICAgIHJldHVybiBheGlzLmdldE9mZnNldChkYXRhU2VydmljZS50YXNrRW5kKHRhc2spKSAtIGF4aXMuZ2V0T2Zmc2V0KHRhc2suc3RhcnRfZGF0ZXRpbWUpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAuZWFjaChmdW5jdGlvbihzbHVnKSB7XG4gICAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHNsdWcpO1xuICAgICAgICAgICAgdGFza3NWaXMuZXhwYW5kKGQzLnNlbGVjdCh0YXNrc1Zpcy5wYXJlbnROb2RlKSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza1ZpZXdzLm9uKCdjbGljaycsIGZ1bmN0aW9uKHRhc2tLZXkpIHtcbiAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpO1xuICAgICAgICAgIHZhciB0YXJnZXQgPSBkMy5zZWxlY3QoZDMuZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgICB2YXIgY2xhc3NlcyA9IFsndGFzay12aWV3JywgJ3Rhc2stc3ZnJywgJ3Rhc2stcmVjdCddO1xuICAgICAgICAgIGlmICghX2hhc09uZUNsYXNzRnJvbSh0YXJnZXQsIGNsYXNzZXMpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSk7XG4gICAgICAgICAgdmFyIGV4cGFuZEFzc2lnbm1lbnRzID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJywgIWV4cGFuZEFzc2lnbm1lbnRzKVxuICAgICAgICAgIHRhc2tzVmlzLmRpc3RyaWJ1dGUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5kcmF3TWV0YSgpO1xuICAgICAgICB0aGlzLmRyYXdCYWNrZ3JvdW5kcygpO1xuICAgICAgICB0YXNrc1Zpcy5kaXN0cmlidXRlKCk7XG4gICAgICB9LFxuICAgICAgZHJhd01ldGE6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogRHJhd3MgdGFzayBzdGVwIHNsdWdzLCBzdGF0dXNlcywgYW5kIGFjdGlvbiBidXR0b25zIHRvIHRoZSBsZWZ0IG9mXG4gICAgICAgICAqIHRoZSBtYWluIHByb2plY3QgbWFuYWdlbWVudCB2aXN1YWxpemF0aW9uLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHRhc2tzVmlzID0gdGhpcztcbiAgICAgICAgdmFyIHRhc2tOYW1lcyA9IGQzLnNlbGVjdCgnLnRhc2stbmFtZXMnKS5zZWxlY3RBbGwoJy50YXNrLW5hbWUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmRhdGEoZGF0YVNlcnZpY2UudGltZVNvcnRlZFNsdWdzLCBmdW5jdGlvbihzbHVnKSB7cmV0dXJuIHNsdWd9KTtcbiAgICAgICAgdGFza05hbWVzLmV4aXQoKS5yZW1vdmUoKTtcbiAgICAgICAgdmFyIHRhc2tOYW1lc0VudGVyID0gdGFza05hbWVzLmVudGVyKCkuYXBwZW5kKCdkaXYnKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICd0YXNrLW5hbWUnKTtcbiAgICAgICAgdGFza05hbWVzRW50ZXIuYXBwZW5kKCdzcGFuJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnc3RlcC1zbHVnJylcbiAgICAgICAgdmFyIHRhc2tBY3Rpb25XcmFwcGVycyA9IHRhc2tOYW1lc0VudGVyLmFwcGVuZCgnZGl2JykuYXR0cignY2xhc3MnLCAndGFzay1hY3Rpb24td3JhcHBlcicpO1xuICAgICAgICB2YXIgYWN0aW9ucyA9IHRhc2tOYW1lcy5zZWxlY3RBbGwoJy50YXNrLWFjdGlvbi13cmFwcGVyJykuc2VsZWN0QWxsKCcuc2tpcC10YXNrJylcbiAgICAgICAgICAuZGF0YShmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSkuc3RhdHVzICE9ICdDb21wbGV0ZScgPyBbdGFza0tleV0gOiBbXTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgYWN0aW9ucy5leGl0KCkucmVtb3ZlKClcbiAgICAgICAgYWN0aW9ucy5lbnRlcigpLmFwcGVuZCgnYnV0dG9uJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnc2tpcC10YXNrIHRhc2stYWN0aW9uIGJ0biBidG4tZGFuZ2VyIGJ0bi14cycpXG4gICAgICAgICAgLnRleHQoJ1NraXAgdGFzaycpXG4gICAgICAgICAgLm9uKCdjbGljaycsIGZ1bmN0aW9uKHRhc2tLZXkpIHtcbiAgICAgICAgICAgIHRhc2tzVmlzLmNvbXBsZXRlQW5kU2tpcFRhc2soZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSkpO1xuICAgICAgICAgIH0pXG4gICAgICAgIHRhc2tBY3Rpb25XcmFwcGVycy5hcHBlbmQoJ2EnKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICdocmVmJzogZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgICAgICByZXR1cm4gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSkuYWRtaW5fdXJsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3RhcmdldCc6ICdfYmxhbmsnLFxuICAgICAgICAgICAgJ2NsYXNzJzogJ3Rhc2stYWN0aW9uJ1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmFwcGVuZCgnYnV0dG9uJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnYnRuIGJ0bi1kZWZhdWx0IGJ0bi14cycpXG4gICAgICAgICAgLnRleHQoJ1ZpZXcgaW4gYWRtaW4nKTtcblxuICAgICAgICB0YXNrTmFtZXNFbnRlci5hcHBlbmQoJ3NwYW4nKS5hdHRyKCdjbGFzcycsICdzdGVwLXN0YXR1cycpO1xuXG4gICAgICAgIHRhc2tOYW1lcy5zZWxlY3RBbGwoJy5zdGVwLXNsdWcnKS50ZXh0KGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHNsdWcpO1xuICAgICAgICAgIHJldHVybiB0YXNrLnN0ZXBfc2x1ZztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza05hbWVzLnNlbGVjdEFsbCgnLnN0ZXAtc3RhdHVzJykudGV4dChmdW5jdGlvbihzbHVnKSB7XG4gICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICByZXR1cm4gdGFzay5zdGF0dXM7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGRyYXdCYWNrZ3JvdW5kczogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZW5kZXJzIGVhY2ggdGFzayBcInN3aW0gbGFuZVwiIHdpdGggYW4gYWx0ZXJuYXRpbmcgY29sb3IuXG4gICAgICAgICAqL1xuICAgICAgICBkMy5zZWxlY3RBbGwoJy50YXNrLW5hbWUnKVxuICAgICAgICAgIC5zdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIGZ1bmN0aW9uKHNsdWcsIGksIGopIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGkgJSAyID09IDAgPyAnI2VlZScgOiAnd2hpdGUnO1xuICAgICAgICAgIH0pXG4gICAgICAgIHZpc1V0aWxzLnBhcmVudENvbnRhaW5lci5zZWxlY3RBbGwoJy50YXNrLXZpZXcnKVxuICAgICAgICAgIC5zdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIGZ1bmN0aW9uKHNsdWcsIGkpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGkgJSAyID09IDAgPyAnI2VlZScgOiAnd2hpdGUnO1xuICAgICAgICAgIH0pXG4gICAgICB9LFxuICAgICAgZHJhd1JldmVydEZsYWdzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIERyYXdzIHRoZSBmbGFncyBjb3JyZXNwb25kaW5nIHRvIHN1aXRhYmxlIHRhc2sgcmV2ZXJ0IHRpbWVzLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHRhc2tzVmlzID0gdGhpcztcbiAgICAgICAgdmFyIHRhc2tzID0gdmlzVXRpbHMucGFyZW50Q29udGFpbmVyLnNlbGVjdEFsbCgnLnRhc2snKTtcbiAgICAgICAgdmFyIHJldmVydEdyb3VwcyA9IHRhc2tzLnNlbGVjdEFsbCgnLnJldmVydC1ncm91cCcpLmRhdGEoZnVuY3Rpb24oc2x1Zykge1xuICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoc2x1Zyk7XG4gICAgICAgICAgdmFyIGRhdGV0aW1lcyA9IFtdO1xuICAgICAgICAgIHRhc2suYXNzaWdubWVudHMuZm9yRWFjaChmdW5jdGlvbihhc3NpZ25tZW50KSB7XG4gICAgICAgICAgICBpZiAoYXNzaWdubWVudC5pdGVyYXRpb25zKSB7XG4gICAgICAgICAgICAgIGFzc2lnbm1lbnQuaXRlcmF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGRhdGV0aW1lcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICdkYXRldGltZSc6IG5ldyBEYXRlKGl0ZXJhdGlvbi5zdGFydF9kYXRldGltZSksXG4gICAgICAgICAgICAgICAgICAndGFza0tleSc6IHRhc2suc3RlcF9zbHVnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgaWYgKCFkYXRhU2VydmljZS5pblByb2dyZXNzQXNzaWdubWVudCh0YXNrKSkge1xuICAgICAgICAgICAgZGF0ZXRpbWVzLnB1c2goe1xuICAgICAgICAgICAgICAnZGF0ZXRpbWUnOiBuZXcgRGF0ZShkYXRhU2VydmljZS50YXNrRW5kKHRhc2spKSxcbiAgICAgICAgICAgICAgJ3Rhc2tLZXknOiB0YXNrLnN0ZXBfc2x1Z1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBkYXRldGltZXM7XG4gICAgICAgIH0sIGZ1bmN0aW9uKGRhdGV0aW1lKSB7cmV0dXJuIGRhdGV0aW1lLmRhdGV0aW1lfSk7XG4gICAgICAgIHJldmVydEdyb3Vwcy5leGl0KCkucmVtb3ZlKCk7XG4gICAgICAgIHZhciByZXZlcnRHcm91cHNFbnRlciA9IHJldmVydEdyb3Vwcy5lbnRlcigpLmFwcGVuZCgnZycpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3JldmVydC1ncm91cCcpO1xuXG4gICAgICAgIHJldmVydEdyb3Vwc0VudGVyLmFwcGVuZCgnbGluZScpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2NsYXNzJzogJ3JldmVydC1saW5lJyxcbiAgICAgICAgICAgICdzdHJva2UnOiAncmdiKDAsIDEyMSwgMTkxKScsXG4gICAgICAgICAgfSlcblxuICAgICAgICAvLyBSZXZlcnQgZmxhZ3NcbiAgICAgICAgcmV2ZXJ0R3JvdXBzRW50ZXIuYXBwZW5kKCdwYXRoJylcbiAgICAgICAgICAuYXR0cih7XG4gICAgICAgICAgICAnZCc6ICdNMCwwIFY0IEwtMiwyIFonLFxuICAgICAgICAgICAgJ2ZpbGwnOiAncmdiKDAsIDEyMSwgMTkxKScsXG4gICAgICAgICAgICAndHJhbnNmb3JtJzogdmlzVXRpbHMudHJhbnNsYXRlU3RyaW5nKDAsIC12aXNVdGlscy5wYXJhbXMubGFuZVBhZGRpbmcudG9wIC8gMikgKyAnIHNjYWxlKDMsIDMpJyxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5zdHlsZSgnY3Vyc29yJywgJ3BvaW50ZXInKVxuICAgICAgICAgIC5vbignbW91c2VlbnRlcicsIGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgaWYgKCF0YXNrc1Zpcy5yZXZlcnRpbmcpIHtcbiAgICAgICAgICAgICAgY3Jvc3NoYWlyLm1vdmUoZGF0ZXRpbWVJbmZvLmRhdGV0aW1lKTtcbiAgICAgICAgICAgICAgY3Jvc3NoYWlyLnNob3coKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5vbignbW91c2VsZWF2ZScsIGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgaWYgKCF0YXNrc1Zpcy5yZXZlcnRpbmcpIHtcbiAgICAgICAgICAgICAgY3Jvc3NoYWlyLmhpZGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5vbignY2xpY2snLCBmdW5jdGlvbihkYXRldGltZUluZm8pIHtcbiAgICAgICAgICAgIHZhciB0YXNrSWQgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShkYXRldGltZUluZm8udGFza0tleSkuaWQ7XG4gICAgICAgICAgICB0YXNrc1Zpcy5yZXZlcnRUYXNrKHRhc2tJZCwgZGF0ZXRpbWVJbmZvLmRhdGV0aW1lKTtcbiAgICAgICAgICB9KVxuXG4gICAgICAgIHJldmVydEdyb3Vwcy50cmFuc2l0aW9uKCkuYXR0cih7XG4gICAgICAgICAgJ3RyYW5zZm9ybSc6IGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgdmFyIHRhc2tTdGFydERhdGV0aW1lID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoZGF0ZXRpbWVJbmZvLnRhc2tLZXkpLnN0YXJ0X2RhdGV0aW1lO1xuICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnRyYW5zbGF0ZVN0cmluZyhcbiAgICAgICAgICAgICAgYXhpcy50aW1lU2NhbGUoZGF0ZXRpbWVJbmZvLmRhdGV0aW1lKSAtIGF4aXMuZ2V0T2Zmc2V0KHRhc2tTdGFydERhdGV0aW1lKSwgMFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICB9KVxuXG4gICAgICAgIHJldmVydEdyb3Vwcy5zZWxlY3RBbGwoJy5yZXZlcnQtbGluZScpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICd5MSc6IC12aXNVdGlscy5wYXJhbXMubGFuZVBhZGRpbmcudG9wIC8gMixcbiAgICAgICAgICAgICd5Mic6IGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGV0aW1lSW5mby50YXNrS2V5O1xuICAgICAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpO1xuICAgICAgICAgICAgICBpZiAoZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKHRhc2suYXNzaWdubWVudHMubGVuZ3RoICsgMSkgKiB2aXNVdGlscy5wYXJhbXMuYmFySGVpZ2h0ICsgMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCArIDE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSlcbiAgICAgIH0sXG4gICAgICBleHBhbmQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogVG9nZ2xlcyBleHBhbnNpb24gb2Ygc2VsZWN0ZWQgdGFza3MgdG8gc2hvdyBtb3JlIGRldGFpbGVkIGFzc2lnbm1lbnRcbiAgICAgICAgICogZGF0YSBhbmQgYWN0aW9ucy5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrVmlld3MgPSBkMy5zZWxlY3RBbGwoJy50YXNrLXZpZXcnKTtcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcuYXNzaWdubWVudHMnKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuYXR0cigndHJhbnNmb3JtJywgZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgICAgdmFyIGV4cGFuZCA9IGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycpO1xuICAgICAgICAgICAgdmlzVXRpbHMudHJhbnNsYXRlU3RyaW5nKDAsIGV4cGFuZCA/IHZpc1V0aWxzLnBhcmFtcy5iYXJIZWlnaHQgOiAwKVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy5hc3NpZ25tZW50JylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXksIGkpIHtcbiAgICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBkYXRhU2VydmljZS5hc3NpZ25tZW50RnJvbUtleShhc3NpZ25tZW50S2V5KTtcbiAgICAgICAgICAgICAgdmFyIHRhc2tLZXkgPSBkYXRhU2VydmljZS5rZXlGcm9tVGFzayhhc3NpZ25tZW50LnRhc2spO1xuICAgICAgICAgICAgICB2YXIgZXhwYW5kID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgICAgIHJldHVybiB2aXNVdGlscy50cmFuc2xhdGVTdHJpbmcoMCwgZXhwYW5kID8gKHZpc1V0aWxzLnBhcmFtcy5iYXJIZWlnaHQgKiAoaSArIDEpKSA6IDApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KVxuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy5hc3NpZ25tZW50LW1ldGEnKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuc3R5bGUoe1xuICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJyxcbiAgICAgICAgICAgICd0b3AnOiBmdW5jdGlvbihhc3NpZ25tZW50S2V5LCBpKSB7XG4gICAgICAgICAgICAgIHZhciBhc3NpZ25tZW50ID0gZGF0YVNlcnZpY2UuYXNzaWdubWVudEZyb21LZXkoYXNzaWdubWVudEtleSk7XG4gICAgICAgICAgICAgIHZhciB0YXNrS2V5ID0gZGF0YVNlcnZpY2Uua2V5RnJvbVRhc2soYXNzaWdubWVudC50YXNrKTtcbiAgICAgICAgICAgICAgdmFyIGV4cGFuZCA9IGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycpO1xuICAgICAgICAgICAgICBpZiAoZXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICh2aXNVdGlscy5wYXJhbXMuYmFySGVpZ2h0ICogKGkgKyAxKSArIHZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3AgKyA0KSArICdweCc7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3AgKyAncHgnO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdyaWdodCc6IGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXkpIHtcbiAgICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBkYXRhU2VydmljZS5hc3NpZ25tZW50RnJvbUtleShhc3NpZ25tZW50S2V5KVxuICAgICAgICAgICAgICByZXR1cm4gKHZpc1V0aWxzLmdldFN2Z1dpZHRoKCkgLSBheGlzLmdldE9mZnNldChhc3NpZ25tZW50LnRhc2suc3RhcnRfZGF0ZXRpbWUpICsgMTApICsgJ3B4JztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnZGlzcGxheSc6IGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXksIGkpIHtcbiAgICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBkYXRhU2VydmljZS5hc3NpZ25tZW50RnJvbUtleShhc3NpZ25tZW50S2V5KTtcbiAgICAgICAgICAgICAgdmFyIHRhc2tLZXkgPSBkYXRhU2VydmljZS5rZXlGcm9tVGFzayhhc3NpZ25tZW50LnRhc2spO1xuICAgICAgICAgICAgICB2YXIgZXhwYW5kID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgICAgIHJldHVybiBleHBhbmQgPyAnaW5oZXJpdCcgOiAnbm9uZSc7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLmFjdGl2ZS1hc3NpZ25tZW50JylcbiAgICAgICAgICAuYXR0cignZGlzcGxheScsIGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXkpIHtcbiAgICAgICAgICAgIHZhciBhc3NpZ25tZW50ID0gZGF0YVNlcnZpY2UuYXNzaWdubWVudEZyb21LZXkoYXNzaWdubWVudEtleSk7XG4gICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGFTZXJ2aWNlLmtleUZyb21UYXNrKGFzc2lnbm1lbnQudGFzayk7XG4gICAgICAgICAgICB2YXIgZXhwYW5kID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgICByZXR1cm4gZXhwYW5kID8gJ2luaGVyaXQnIDogJ25vbmUnO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGRpc3RyaWJ1dGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogVmVydGljYWxseSBkaXN0cmlidXRlIHRhc2sgdmlzdWFsaXphdGlvbnMgaW5zaWRlIHRoZWlyIGNvbnRhaW5lci5cbiAgICAgICAgICovXG4gICAgICAgIHZpc1V0aWxzLnBhcmVudENvbnRhaW5lci5zZWxlY3RBbGwoJy50YXNrLXN2ZycpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICdoZWlnaHQnOiBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSk7XG4gICAgICAgICAgICAgIHJldHVybiB2aXNVdGlscy5nZXRUYXNrSGVpZ2h0KHRhc2spO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KVxuXG4gICAgICAgIHZhciB0YXNrTmFtZXNXcmFwcGVyID0gZDMuc2VsZWN0QWxsKCcudGFzay1uYW1lcycpLnN0eWxlKCdtYXJnaW4tdG9wJywgdmlzVXRpbHMucGFyYW1zLnNjYWxlSGVpZ2h0ICsgJ3B4Jyk7XG4gICAgICAgIHZhciB0YXNrTmFtZXMgPSB0YXNrTmFtZXNXcmFwcGVyLnNlbGVjdEFsbCgnLnRhc2stbmFtZScpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5zdHlsZSh7XG4gICAgICAgICAgICAnaGVpZ2h0JzogZnVuY3Rpb24oc2x1ZywgaSkge1xuICAgICAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHNsdWcpO1xuICAgICAgICAgICAgICByZXR1cm4gdmlzVXRpbHMuZ2V0VGFza0hlaWdodCh0YXNrKSArICdweCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3BhZGRpbmctdG9wJzogdmlzVXRpbHMucGFyYW1zLmxhbmVQYWRkaW5nLnRvcCAvIDIgKyAncHgnXG4gICAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmRyYXdSZXZlcnRGbGFncygpO1xuICAgICAgICB0aGlzLmV4cGFuZCgpO1xuICAgICAgfSxcbiAgICAgIGNvbXBsZXRlQW5kU2tpcFRhc2s6IGZ1bmN0aW9uKHRhc2spIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEhhbmRsZXMgdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgb3JjaGVzdHJhQXBpLmNvbXBsZXRlQW5kU2tpcFRhc2tcbiAgICAgICAgICogaW4gdGhlIHZpc3VhbGl6YXRpb24uXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIWNvbmZpcm0oJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBza2lwIHRoaXMgdGFzayBhbmQgbWFyayBpdCAnICtcbiAgICAgICAgICAgICAgICAgICAgICdhcyBjb21wbGV0ZT8gVGhpcyBtaWdodCBsZWF2ZSB0aGUgcHJvamVjdCBpbiBhICcgK1xuICAgICAgICAgICAgICAgICAgICAgJ2NvcnJ1cHRlZC91bnJlY292ZXJhYmxlIHN0YXRlLicpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIG9yY2hlc3RyYUFwaS5jb21wbGV0ZUFuZFNraXBUYXNrKHRhc2spXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBkYXRhU2VydmljZS51cGRhdGVEYXRhKCk7XG4gICAgICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAnRXJyb3Igc2tpcHBpbmcgdGFzay4nO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAwKSB7XG4gICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlLmRhdGEubWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFsZXJ0KGVycm9yTWVzc2FnZSk7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgcmV2ZXJ0VGFzazogZnVuY3Rpb24odGFza0lkLCBkYXRldGltZSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogRGlzcGxheXMgYSBtb2RhbCBjb250YWluaW5nIHRoZSBhdWRpdCB0cmFpbCBvZiBpdGVtcyB0byBiZSByZXZlcnRlZC5cbiAgICAgICAgICogSGFuZGxlcyB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBvcmNoZXN0cmFBcGkucmV2ZXJ0VGFzayBpbiB0aGVcbiAgICAgICAgICogdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrc1ZpcyA9IHRoaXM7XG4gICAgICAgIGlmICh0YXNrc1Zpcy5yZXZlcnRpbmcpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGFza3NWaXMucmV2ZXJ0aW5nID0gdHJ1ZTtcbiAgICAgICAgb3JjaGVzdHJhQXBpLnJldmVydFRhc2sodGFza0lkLCBkYXRldGltZSwgdHJ1ZSlcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgdmFyIG1vZGFsSW5zdGFuY2UgPSAkbW9kYWwub3Blbih7XG4gICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnL3N0YXRpYy9vcmNoZXN0cmEvcHJvamVjdF9tYW5hZ2VtZW50L3BhcnRpYWxzL3JldmVydF9tb2RhbC5odG1sJyxcbiAgICAgICAgICAgICAgY29udHJvbGxlcjogZnVuY3Rpb24oJHNjb3BlKSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmF1ZGl0ID0gX2h1bWFuaXplQXVkaXQocmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmNhbmNlbCA9IG1vZGFsSW5zdGFuY2UuY2xvc2U7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmNvbmZpcm1SZXZlcnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgIG9yY2hlc3RyYUFwaS5yZXZlcnRUYXNrKHRhc2tJZCwgZGF0ZXRpbWUsIGZhbHNlKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICBkYXRhU2VydmljZS51cGRhdGVEYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yTWVzc2FnZSA9ICdDb3VsZCBub3QgcmV2ZXJ0IHRhc2suJztcbiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlLmRhdGEubWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgYWxlcnQoZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmZpbmFsbHkoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbW9kYWxJbnN0YW5jZS5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBtb2RhbEluc3RhbmNlLnJlc3VsdC5maW5hbGx5KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICB0YXNrc1Zpcy5yZXZlcnRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgY3Jvc3NoYWlyLmhpZGUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICB2YXIgZXJyb3JNZXNzYWdlID0gJ0NvdWxkIG5vdCBnZW5lcmF0ZSByZXZlcnQgaW5mb3JtYXRpb24uJztcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMCkge1xuICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSByZXNwb25zZS5kYXRhLm1lc3NhZ2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhbGVydChlcnJvck1lc3NhZ2UpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICB9XG4gIH0pO1xufSkoKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

!function(){"use strict";function e(e,t){return{restrict:"E",scope:{data:"=",imagePrefix:"=?",readonly:"=",uploadLimitMb:"=?"},link:function(i,r,o){function n(e){if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items[0],r=t.getAsFile();d(r,i.editor.getSelection(),e)}}function a(e){for(var t=e.dataTransfer.files,i=t.length-1;i>=0;i--){var r=t[i],o=l(e);d(r,{start:o,end:o},e)}}function l(e){function t(e,t){var i;if(document.caretPositionFromPoint){var r=document.caretPositionFromPoint(e,t);return{offset:r.offset,node:r.offsetNode}}return document.caretRangeFromPoint?(i=document.caretRangeFromPoint(e,t),{offset:i.startOffset,node:i.startContainer}):void document.body.createTextRange}function r(e){for(var t=[e],i=[];t.length;){var r=t.pop();r.childNodes&&(t=t.concat(Array.prototype.slice.call(r.childNodes))),i.push(r)}return i.reverse()}function o(e){var t=3,i=r(e),o=i.filter(function(e){return e.nodeType===t||!e.firstChild});return o}var n=t(e.clientX,e.clientY);if(!n)return i.editor.getLength();var a=o(c.getElementsByClassName("ql-editor")[0]),l=a.indexOf(n.node),d=i.editor.getContents();return d.ops=d.ops.slice(0,l),d.length()+n.offset}function d(t,r,o){var n="/orchestra/api/interface/upload_image/",a=["image/jpeg","image/png","image/gif"];if(-1===a.indexOf(t.type))return void alert("Files type "+t.type+" not supported.");if(o&&o.preventDefault(),null===r){var l=i.editor.getLength();r={start:l,end:l}}var d=new FileReader;d.onload=function(o){var a=o.target.result,l=a.substring(a.indexOf(",")+1,a.length),d=3*l.length/4;return d>i.uploadLimitMb*Math.pow(10,6)?void alert("Files larger than "+i.uploadLimitMb+"MB cannot be uploaded"):void e.post(n,{image_data:l,image_type:t.type,prefix:i.imagePrefix}).then(function(e,t,o,n){i.editor.deleteText(r),i.editor.insertEmbed(r.start,"image",e.data.url,"user")})},d.readAsDataURL(t)}i.uploadLimitMb=i.uploadLimitMb||5,i.imagePrefix=i.imagePrefix||"";var c=r.find(".orchestra-quill-editor").get(0),s=r.find(".orchestra-quill-toolbar").get(0);if(i.editor=new Quill(c,{modules:{toolbar:{container:s},"link-tooltip":!0},theme:"snow"}),i.$watch("data",function(e,t){i.data&&i.data!=i.editor.getHTML()&&i.editor.setHTML(i.data)}),i.readonly)return i.editor.editor.disable(),void s.remove();i.editor.on("text-change",function(){t(function(){i.data=i.editor.getHTML(),i.$apply()},0,!1)}),i.fileSelector=document.createElement("input"),i.fileSelector.setAttribute("type","file"),i.fileSelector.setAttribute("accept","image/*");var u=r.find(".orchestra-quill-toolbar .ql-image").get(0);i.fileSelector.onchange=function(e){i.editor.focus();for(var t=i.fileSelector.files,r=t.length-1;r>=0;r--)null!==t[r]&&d(t[r],i.editor.getSelection())},u.onclick=function(){return i.fileSelector.click(),!1},c.addEventListener("paste",n,!0),c.addEventListener("drop",a,!0)},templateUrl:"/static/orchestra/common/components/quill/partials/quill.html"}}angular.module("orchestra.common.components.directives").directive("orchestraQuill",["$http","$timeout",e])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9jb21tb24vY29tcG9uZW50cy9xdWlsbC9qcy9kaXJlY3RpdmVzLmpzIl0sIm5hbWVzIjpbIm9yY2hlc3RyYVF1aWxsIiwiJGh0dHAiLCIkdGltZW91dCIsInJlc3RyaWN0Iiwic2NvcGUiLCJkYXRhIiwiaW1hZ2VQcmVmaXgiLCJyZWFkb25seSIsInVwbG9hZExpbWl0TWIiLCJsaW5rIiwiZWwiLCJhdHRyIiwicGFzdGVJbWFnZSIsImUiLCJjbGlwYm9hcmREYXRhIiwiaXRlbXMiLCJjb3BpZWREYXRhIiwiaW1hZ2VGaWxlIiwiZ2V0QXNGaWxlIiwidXBsb2FkSW1hZ2UiLCJlZGl0b3IiLCJnZXRTZWxlY3Rpb24iLCJkcm9wSW1hZ2UiLCJmaWxlcyIsImRhdGFUcmFuc2ZlciIsImkiLCJsZW5ndGgiLCJmaWxlIiwiZHJvcE9mZnNldCIsImdldERyb3BJbmRleE9mZnNldCIsInN0YXJ0IiwiZW5kIiwiZHJvcEV2ZW50IiwiZ2V0RHJvcENoYXJPZmZzZXQiLCJ4IiwieSIsInJhbmdlIiwiZG9jdW1lbnQiLCJjYXJldFBvc2l0aW9uRnJvbVBvaW50IiwicG9zIiwib2Zmc2V0Iiwibm9kZSIsIm9mZnNldE5vZGUiLCJjYXJldFJhbmdlRnJvbVBvaW50Iiwic3RhcnRPZmZzZXQiLCJzdGFydENvbnRhaW5lciIsImJvZHkiLCJjcmVhdGVUZXh0UmFuZ2UiLCJnZXRBbGxDaGlsZE5vZGVzIiwicGFyZW50IiwiYmZzU3RhY2siLCJub2RlcyIsImN1cnJlbnROb2RlIiwicG9wIiwiY2hpbGROb2RlcyIsImNvbmNhdCIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwicHVzaCIsInJldmVyc2UiLCJnZXRMZWFmTm9kZXMiLCJ0ZXh0Tm9kZVR5cGUiLCJsZWFmTm9kZXMiLCJmaWx0ZXIiLCJlbGVtIiwibm9kZVR5cGUiLCJmaXJzdENoaWxkIiwiY2FyZXRQb3NpdGlvbiIsImNsaWVudFgiLCJjbGllbnRZIiwiZ2V0TGVuZ3RoIiwibGVhdmVzIiwiZWRpdG9yQ29udGFpbmVyIiwiZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSIsIm9wSW5kZXgiLCJpbmRleE9mIiwiY29udGVudHMiLCJnZXRDb250ZW50cyIsIm9wcyIsInVwbG9hZEFQSUVuZHBvaW50Iiwic3VwcG9ydGVkVHlwZXMiLCJ0eXBlIiwiYWxlcnQiLCJwcmV2ZW50RGVmYXVsdCIsImVuZEluZGV4IiwicmVhZGVyIiwiRmlsZVJlYWRlciIsIm9ubG9hZCIsInJhd0RhdGEiLCJ0YXJnZXQiLCJyZXN1bHQiLCJpbWFnZURhdGEiLCJzdWJzdHJpbmciLCJpbWFnZVNpemUiLCJNYXRoIiwicG93IiwicG9zdCIsImltYWdlX2RhdGEiLCJpbWFnZV90eXBlIiwicHJlZml4IiwidGhlbiIsInJlc3BvbnNlIiwic3RhdHVzIiwiaGVhZGVycyIsImNvbmZpZyIsImRlbGV0ZVRleHQiLCJpbnNlcnRFbWJlZCIsInVybCIsInJlYWRBc0RhdGFVUkwiLCJmaW5kIiwiZ2V0IiwidG9vbGJhckNvbnRhaW5lciIsIlF1aWxsIiwibW9kdWxlcyIsInRvb2xiYXIiLCJjb250YWluZXIiLCJsaW5rLXRvb2x0aXAiLCJ0aGVtZSIsIiR3YXRjaCIsIm5vdyIsImJlZm9yZSIsImdldEhUTUwiLCJzZXRIVE1MIiwiZGlzYWJsZSIsInJlbW92ZSIsIm9uIiwiJGFwcGx5IiwiZmlsZVNlbGVjdG9yIiwiY3JlYXRlRWxlbWVudCIsInNldEF0dHJpYnV0ZSIsImltYWdlU2VsZWN0b3IiLCJvbmNoYW5nZSIsImZvY3VzIiwib25jbGljayIsImNsaWNrIiwiYWRkRXZlbnRMaXN0ZW5lciIsInRlbXBsYXRlVXJsIiwiYW5ndWxhciIsIm1vZHVsZSIsImRpcmVjdGl2ZSJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQU1BLFNBQVNBLEdBQWVDLEVBQU9DLEdBQzdCLE9BQ0VDLFNBQVUsSUFDVkMsT0FDRUMsS0FBUSxJQUNSQyxZQUFlLEtBQ2ZDLFNBQVksSUFDWkMsY0FBaUIsTUFFbkJDLEtBQU0sU0FBU0wsRUFBT00sRUFB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QUFhMUcsTUFDdEJFLEVBQUlGLEVBQU1HLE9BQVMsRUFBR0QsR0FBSyxFQUFHQSxJQUNwQixPQUFiRixFQUFNRSxJQUNSTixFQUFZSSxFQUFNRSxHQUFJckIsRUFBTWdCLE9BQU9DLGlCQUl6QytHLEVBQWNHLFFBQVUsV0FFdEIsTUFEQW5JLEdBQU02SCxhQUFhTyxTQUNaLEdBTVQ5RCxFQUFnQitELGlCQUFpQixRQUFTN0gsR0FBWSxHQVV0RDhELEVBQWdCK0QsaUJBQWlCLE9BQVFuSCxHQUFXLElBOEh0RG9ILFlBQWEsaUVBek5qQkMsUUFDR0MsT0FBTywwQ0FDUEMsVUFBVSxrQkFBbUIsUUFBUyxXQUFZN0kiLCJmaWxlIjoib3JjaGVzdHJhL2NvbW1vbi9jb21wb25lbnRzL3F1aWxsL2pzL2RpcmVjdGl2ZXMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdvcmNoZXN0cmEuY29tbW9uLmNvbXBvbmVudHMuZGlyZWN0aXZlcycpXG4gICAgLmRpcmVjdGl2ZSgnb3JjaGVzdHJhUXVpbGwnLCBbJyRodHRwJywgJyR0aW1lb3V0Jywgb3JjaGVzdHJhUXVpbGxdKTtcblxuICBmdW5jdGlvbiBvcmNoZXN0cmFRdWlsbCgkaHR0cCwgJHRpbWVvdXQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcmVzdHJpY3Q6ICdFJyxcbiAgICAgIHNjb3BlOiB7XG4gICAgICAgICdkYXRhJzogJz0nLFxuICAgICAgICAnaW1hZ2VQcmVmaXgnOiAnPT8nLFxuICAgICAgICAncmVhZG9ubHknOiAnPScsXG4gICAgICAgICd1cGxvYWRMaW1pdE1iJzogJz0/JyxcbiAgICAgIH0sXG4gICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWwsIGF0dHIpIHtcbiAgICAgICAgLy8gU3VnZ2VzdGVkIGxpbWl0IGZvciBpbWFnZSB1cGxvYWQgc2l6ZSBpcyA1IE1CLlxuICAgICAgICBzY29wZS51cGxvYWRMaW1pdE1iID0gc2NvcGUudXBsb2FkTGltaXRNYiB8fCA1O1xuXG4gICAgICAgIC8vIERlZmF1bHQgaW1hZ2UgcHJlZml4IGlzIGFuIGVtcHR5IHN0cmluZy5cbiAgICAgICAgc2NvcGUuaW1hZ2VQcmVmaXggPSBzY29wZS5pbWFnZVByZWZpeCB8fCAnJztcblxuICAgICAgICAvLyBDb250YWluZXJzIHdpdGhpbiBkaXJlY3RpdmUgdGVtcGxhdGUgZm9yIFF1aWxsIGVkaXRvclxuICAgICAgICB2YXIgZWRpdG9yQ29udGFpbmVyID0gZWwuZmluZCgnLm9yY2hlc3RyYS1xdWlsbC1lZGl0b3InKS5nZXQoMCk7XG4gICAgICAgIHZhciB0b29sYmFyQ29udGFpbmVyID0gZWwuZmluZCgnLm9yY2hlc3RyYS1xdWlsbC10b29sYmFyJykuZ2V0KDApO1xuXG4gICAgICAgIHNjb3BlLmVkaXRvciA9IG5ldyBRdWlsbChlZGl0b3JDb250YWluZXIsIHtcbiAgICAgICAgICBtb2R1bGVzOiB7XG4gICAgICAgICAgICAndG9vbGJhcic6IHtjb250YWluZXI6IHRvb2xiYXJDb250YWluZXJ9LFxuICAgICAgICAgICAgLy8gSW1hZ2UgdG9vbHRpcCByZW1vdmVkIGluIGZhdm9yIG9mIGZpbGUgc2VsZWN0b3IgZGlhbG9nXG4gICAgICAgICAgICAnbGluay10b29sdGlwJzogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZW1lOiAnc25vdydcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIHR3by13YXkgbGluayBiZXR3ZWVuIHF1aWxsIGFuZCBwYXJlbnQgc2NvcGUgYXR0cmlidXRlIHBhc3NlZFxuICAgICAgICAvLyBpbiBieSBkaXJlY3RpdmUgY2FsbGVyXG4gICAgICAgIHNjb3BlLiR3YXRjaCgnZGF0YScsIGZ1bmN0aW9uKG5vdywgYmVmb3JlKSB7XG4gICAgICAgICAgaWYgKHNjb3BlLmRhdGEgJiYgc2NvcGUuZGF0YSAhPSBzY29wZS5lZGl0b3IuZ2V0SFRNTCgpKSB7XG4gICAgICAgICAgICBzY29wZS5lZGl0b3Iuc2V0SFRNTChzY29wZS5kYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgLy8gRWRpdG9yIHNldCB0byByZWFkLW9ubHkgdXBvbiBpbml0aWFsaXphdGlvbi5cbiAgICAgICAgaWYgKHNjb3BlLnJlYWRvbmx5KSB7XG4gICAgICAgICAgc2NvcGUuZWRpdG9yLmVkaXRvci5kaXNhYmxlKCk7XG4gICAgICAgICAgdG9vbGJhckNvbnRhaW5lci5yZW1vdmUoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBzY29wZS5lZGl0b3Iub24oJ3RleHQtY2hhbmdlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgLy8gU2V0IHRoZSBmb2N1cyBvdXRzaWRlIHRoZSAkZGlnZXN0IGJsb2NrLlxuICAgICAgICAgIC8vIFRha2VuIGZyb20gaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZXJyb3IvJHJvb3RTY29wZS9pbnByb2c/cDA9JGRpZ2VzdC5cbiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICBzY29wZS5kYXRhID0gc2NvcGUuZWRpdG9yLmdldEhUTUwoKTtcbiAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMCwgZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgdmlhIHRoZSB0b29sYmFyIGJ1dHRvblxuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2ZpbGUnKTtcbiAgICAgICAgc2NvcGUuZmlsZVNlbGVjdG9yLnNldEF0dHJpYnV0ZSgnYWNjZXB0JywgJ2ltYWdlLyonKTtcbiAgICAgICAgdmFyIGltYWdlU2VsZWN0b3IgPSBlbC5maW5kKCcub3JjaGVzdHJhLXF1aWxsLXRvb2xiYXIgLnFsLWltYWdlJykuZ2V0KDApO1xuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3Iub25jaGFuZ2UgPSBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgLy8gRm9jdXMgdGhlIGVkaXRvciBzbyB3ZSBjYW4gZ2V0IHRoZSBjdXJyZW50IHNlbGVjdGlvbi5cbiAgICAgICAgICBzY29wZS5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICB2YXIgZmlsZXMgPSBzY29wZS5maWxlU2VsZWN0b3IuZmlsZXM7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IGZpbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICBpZiAoZmlsZXNbaV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgdXBsb2FkSW1hZ2UoZmlsZXNbaV0sIHNjb3BlLmVkaXRvci5nZXRTZWxlY3Rpb24oKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGltYWdlU2VsZWN0b3Iub25jbGljayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBzY29wZS5maWxlU2VsZWN0b3IuY2xpY2soKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUT0RPKGpyYm90cm9zKTogbW92ZSBwYXN0ZS9kcm9wIGZ1bmN0aW9uYWxpdHkgaW50byBhIHF1aWxsanMgZm9ya1xuXG4gICAgICAgIC8vIFVwbG9hZCBpbWFnZSBieSBwYXN0aW5nIGluIGNvcGllZCBpbWFnZSBkYXRhXG4gICAgICAgIGVkaXRvckNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdwYXN0ZScsIHBhc3RlSW1hZ2UsIHRydWUpO1xuICAgICAgICBmdW5jdGlvbiBwYXN0ZUltYWdlKGUpIHtcbiAgICAgICAgICBpZiAoZS5jbGlwYm9hcmREYXRhICYmIGUuY2xpcGJvYXJkRGF0YS5pdGVtcykge1xuICAgICAgICAgICAgdmFyIGNvcGllZERhdGEgPSBlLmNsaXBib2FyZERhdGEuaXRlbXNbMF07XG4gICAgICAgICAgICB2YXIgaW1hZ2VGaWxlID0gY29waWVkRGF0YS5nZXRBc0ZpbGUoKTtcbiAgICAgICAgICAgIHVwbG9hZEltYWdlKGltYWdlRmlsZSwgc2NvcGUuZWRpdG9yLmdldFNlbGVjdGlvbigpLCBlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgYnkgZHJhZyBhbmQgZHJvcFxuICAgICAgICBlZGl0b3JDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGRyb3BJbWFnZSwgdHJ1ZSk7XG4gICAgICAgIGZ1bmN0aW9uIGRyb3BJbWFnZShlKSB7XG4gICAgICAgICAgdmFyIGZpbGVzID0gZS5kYXRhVHJhbnNmZXIuZmlsZXM7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IGZpbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICB2YXIgZmlsZSA9IGZpbGVzW2ldO1xuICAgICAgICAgICAgdmFyIGRyb3BPZmZzZXQgPSBnZXREcm9wSW5kZXhPZmZzZXQoZSk7XG4gICAgICAgICAgICB1cGxvYWRJbWFnZShmaWxlLCB7J3N0YXJ0JzogZHJvcE9mZnNldCwgJ2VuZCc6IGRyb3BPZmZzZXR9LCBlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXREcm9wSW5kZXhPZmZzZXQoZHJvcEV2ZW50KSB7XG4gICAgICAgICAgLyoqXG4gICAgICAgICAgICogR2l2ZW4gYSBkcm9wIGV2ZW50LCBjYWxjdWxhdGUgdGhlIGluZGV4IG9mZnNldCB3aXRoaW4gdGhlXG4gICAgICAgICAgICogUXVpbGwgZWRpdG9yIGJ5OlxuICAgICAgICAgICAqICAgLSBkZXRlcm1pbmluZyB0aGUgY2hhcmFjdGVyIG9mZnNldCBvZiB0aGUgZHJvcCB3aXRoaW4gdGhlIGlubmVyIG5vZGVcbiAgICAgICAgICAgKiAgIC0gZmluZGluZyBhbGwgZWRpdG9yIGxlYWYgbm9kZXMgKHJlaW1wbGVtZW50cyBzb21lIFF1aWxsIGZ1bmN0aW9uYWxpdHkpXG4gICAgICAgICAgICogICAtIGNhbGN1bGF0aW5nIHRoZSBpbmRleCBvZmZzZXQgZnJvbSB0aGUgbGVhZiBub2RlIGxlbmd0aHMgYW5kIGlubmVyIGRyb3Agbm9kZSBvZmZzZXRcbiAgICAgICAgICAgKiBXZSBwbGFuIHRvIHB1c2ggdGhpcyBmdW5jdGlvbmFsaXR5IGludG8gUXVpbGwgaW4gdGhlIGZ1dHVyZS5cbiAgICAgICAgICAgKi9cbiAgICAgICAgICBmdW5jdGlvbiBnZXREcm9wQ2hhck9mZnNldCh4LCB5KSB7XG4gICAgICAgICAgICAvLyBIZWxwZXIgZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIHgteSBjaGFyYWN0ZXIgb2Zmc2V0IG9mIGEgZHJvcFxuICAgICAgICAgICAgLy8gZXZlbnQgaW4gYSBjb250ZW50ZWRpdGFibGUgZmllbGQuXG4gICAgICAgICAgICAvLyBNb2RpZmllZCBmcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzEwNjU5OTkwLlxuICAgICAgICAgICAgdmFyIHJhbmdlO1xuICAgICAgICAgICAgLy8gU3RhbmRhcmRzLWJhc2VkIHdheTsgaW1wbGVtZW50ZWQgb25seSBpbiBGaXJlZm94XG4gICAgICAgICAgICBpZiAoZG9jdW1lbnQuY2FyZXRQb3NpdGlvbkZyb21Qb2ludCkge1xuICAgICAgICAgICAgICAgIHZhciBwb3MgPSBkb2N1bWVudC5jYXJldFBvc2l0aW9uRnJvbVBvaW50KHgsIHkpO1xuICAgICAgICAgICAgICAgIHJldHVybiB7J29mZnNldCc6IHBvcy5vZmZzZXQsICdub2RlJzogcG9zLm9mZnNldE5vZGV9O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5jYXJldFJhbmdlRnJvbVBvaW50KSB7XG4gICAgICAgICAgICAgIC8vIFdlYmtpdFxuICAgICAgICAgICAgICByYW5nZSA9IGRvY3VtZW50LmNhcmV0UmFuZ2VGcm9tUG9pbnQoeCwgeSk7XG4gICAgICAgICAgICAgIHJldHVybiB7J29mZnNldCc6IHJhbmdlLnN0YXJ0T2Zmc2V0LCAnbm9kZSc6IHJhbmdlLnN0YXJ0Q29udGFpbmVyfTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuYm9keS5jcmVhdGVUZXh0UmFuZ2UpIHtcbiAgICAgICAgICAgICAgLy8gSUUgZG9lc24ndCBuYXRpdmVseSBzdXBwb3J0IHJldHJpZXZpbmcgdGhlIGNoYXJhY3RlciBvZmZzZXQsIHNvXG4gICAgICAgICAgICAgIC8vIGluc2VydCBpbWFnZSBhdCBlbmQgb2YgdGV4dFxuICAgICAgICAgICAgICAvLyBUT0RPKGpyYm90cm9zKTogcmV3cml0ZSB3aXRoIGh0dHBzOi8vZ2l0aHViLmNvbS90aW1kb3duL3Jhbmd5XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBmdW5jdGlvbiBnZXRBbGxDaGlsZE5vZGVzKHBhcmVudCkge1xuICAgICAgICAgICAgLy8gUmV0dXJucyBpbi1vcmRlciBsaXN0IG9mIGFsbCBjaGlsZCBub2RlcyBvZiBgcGFyZW50YFxuICAgICAgICAgICAgdmFyIGJmc1N0YWNrID0gW3BhcmVudF07XG4gICAgICAgICAgICB2YXIgbm9kZXMgPSBbXTtcbiAgICAgICAgICAgIHdoaWxlIChiZnNTdGFjay5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gYmZzU3RhY2sucG9wKCk7XG4gICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5jaGlsZE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgLy8gQ29uY2F0IHdpdGggY29weSBvZiBjaGlsZCBOb2RlTGlzdDsgY2FuJ3QgdXNlIHBvcCBvcGVyYXRpb25cbiAgICAgICAgICAgICAgICAvLyBvbiBvcmlnaW5hbFxuICAgICAgICAgICAgICAgIGJmc1N0YWNrID0gYmZzU3RhY2suY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGN1cnJlbnROb2RlLmNoaWxkTm9kZXMpKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBub2Rlcy5wdXNoKGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBub2Rlcy5yZXZlcnNlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjIyODk2NTBcbiAgICAgICAgICBmdW5jdGlvbiBnZXRMZWFmTm9kZXMocGFyZW50KSB7XG4gICAgICAgICAgICAvLyBSZXR1cm5zIGluLW9yZGVyIGxpc3Qgb2YgYWxsIFF1aWxsIGxlYWYgbm9kZXMgb2YgYHBhcmVudGBcbiAgICAgICAgICAgIHZhciB0ZXh0Tm9kZVR5cGUgPSAzO1xuICAgICAgICAgICAgdmFyIG5vZGVzID0gZ2V0QWxsQ2hpbGROb2RlcyhwYXJlbnQpO1xuICAgICAgICAgICAgdmFyIGxlYWZOb2RlcyA9IG5vZGVzLmZpbHRlcihmdW5jdGlvbihlbGVtKSB7XG4gICAgICAgICAgICAgIHJldHVybiBlbGVtLm5vZGVUeXBlID09PSB0ZXh0Tm9kZVR5cGUgfHwgIWVsZW0uZmlyc3RDaGlsZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGxlYWZOb2RlcztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB2YXIgY2FyZXRQb3NpdGlvbiA9IGdldERyb3BDaGFyT2Zmc2V0KGRyb3BFdmVudC5jbGllbnRYLCBkcm9wRXZlbnQuY2xpZW50WSk7XG4gICAgICAgICAgaWYgKCFjYXJldFBvc2l0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gc2NvcGUuZWRpdG9yLmdldExlbmd0aCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB2YXIgbGVhdmVzID0gZ2V0TGVhZk5vZGVzKGVkaXRvckNvbnRhaW5lci5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdxbC1lZGl0b3InKVswXSk7XG4gICAgICAgICAgdmFyIG9wSW5kZXggPSBsZWF2ZXMuaW5kZXhPZihjYXJldFBvc2l0aW9uLm5vZGUpO1xuICAgICAgICAgIHZhciBjb250ZW50cyA9IHNjb3BlLmVkaXRvci5nZXRDb250ZW50cygpXG4gICAgICAgICAgY29udGVudHMub3BzID0gY29udGVudHMub3BzLnNsaWNlKDAsIG9wSW5kZXgpXG4gICAgICAgICAgcmV0dXJuIGNvbnRlbnRzLmxlbmd0aCgpICsgY2FyZXRQb3NpdGlvbi5vZmZzZXQ7XG4gICAgICAgICB9XG5cblxuICAgICAgICAvLyBQb3N0IGltYWdlIGRhdGEgdG8gYW4gQVBJIGVuZHBvaW50IHRoYXQgcmV0dXJucyBhbiBpbWFnZSBVUkwsIHRoZW5cbiAgICAgICAgLy8gYWRkaW5nIGl0IHRvIHRoZSBlZGl0b3IgKHJlcGxhY2luZyB0aGUgZ2l2ZW4gY2hhcmFjdGVyIHJhbmdlKVxuICAgICAgICBmdW5jdGlvbiB1cGxvYWRJbWFnZShmaWxlLCByYW5nZSwgZSkge1xuICAgICAgICAgIHZhciB1cGxvYWRBUElFbmRwb2ludCA9ICcvb3JjaGVzdHJhL2FwaS9pbnRlcmZhY2UvdXBsb2FkX2ltYWdlLydcbiAgICAgICAgICB2YXIgc3VwcG9ydGVkVHlwZXMgPSBbJ2ltYWdlL2pwZWcnLCAnaW1hZ2UvcG5nJywgJ2ltYWdlL2dpZiddXG5cbiAgICAgICAgICBpZiAoc3VwcG9ydGVkVHlwZXMuaW5kZXhPZihmaWxlLnR5cGUpID09PSAtMSkge1xuICAgICAgICAgICAgYWxlcnQoJ0ZpbGVzIHR5cGUgJyArIGZpbGUudHlwZSArICcgbm90IHN1cHBvcnRlZC4nKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH0gZWxzZSBpZiAoZSkge1xuICAgICAgICAgICAgLy8gQ2FuY2VsIGRlZmF1bHQgYnJvd3NlciBhY3Rpb24gb25seSBpZiBmaWxlIGlzIGFjdHVhbGx5IGFuIGltYWdlXG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gSWYgbm90aGluZyBpcyBzZWxlY3RlZCBpbiB0aGUgZWRpdG9yLCBhcHBlbmQgdGhlIGltYWdlIHRvIGl0cyBlbmRcbiAgICAgICAgICBpZiAocmFuZ2UgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHZhciBlbmRJbmRleCA9IHNjb3BlLmVkaXRvci5nZXRMZW5ndGgoKTtcbiAgICAgICAgICAgIHJhbmdlID0geydzdGFydCc6IGVuZEluZGV4LCAnZW5kJzogZW5kSW5kZXh9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgdmFyIHJhd0RhdGEgPSBlLnRhcmdldC5yZXN1bHQ7XG4gICAgICAgICAgICAgIC8vIFJlbW92ZSBwcmVwZW5kZWQgaW1hZ2UgdHlwZSBmcm9tIGRhdGEgc3RyaW5nXG4gICAgICAgICAgICAgIHZhciBpbWFnZURhdGEgPSByYXdEYXRhLnN1YnN0cmluZyhyYXdEYXRhLmluZGV4T2YoXCIsXCIpICsgMSwgcmF3RGF0YS5sZW5ndGgpXG5cbiAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGRhdGEgc2l6ZSBvZiBiNjQtZW5jb2RlZCBzdHJpbmdcbiAgICAgICAgICAgICAgdmFyIGltYWdlU2l6ZSA9IGltYWdlRGF0YS5sZW5ndGggKiAzIC8gNDtcblxuICAgICAgICAgICAgICBpZiAoaW1hZ2VTaXplID4gc2NvcGUudXBsb2FkTGltaXRNYiAqIE1hdGgucG93KDEwLCA2KSkge1xuICAgICAgICAgICAgICAgIGFsZXJ0KCdGaWxlcyBsYXJnZXIgdGhhbiAnICsgc2NvcGUudXBsb2FkTGltaXRNYiArICdNQiBjYW5ub3QgYmUgdXBsb2FkZWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgLy8gUG9zdCBpbWFnZSBkYXRhIHRvIEFQSTsgcmVzcG9uc2Ugc2hvdWxkIGNvbnRhaW4gdGhlIHVwbG9hZGVkIGltYWdlIHVybFxuICAgICAgICAgICAgICAkaHR0cC5wb3N0KHVwbG9hZEFQSUVuZHBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgIHsnaW1hZ2VfZGF0YSc6IGltYWdlRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlX3R5cGUnOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICdwcmVmaXgnOiBzY29wZS5pbWFnZVByZWZpeH0pXG4gICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgICAvLyBSZXBsYWNlIHNlbGVjdGVkIHJhbmdlIHdpdGggbmV3IGltYWdlXG4gICAgICAgICAgICAgICAgICAgICBzY29wZS5lZGl0b3IuZGVsZXRlVGV4dChyYW5nZSk7XG4gICAgICAgICAgICAgICAgICAgICBzY29wZS5lZGl0b3IuaW5zZXJ0RW1iZWQocmFuZ2Uuc3RhcnQsICdpbWFnZScsIHJlc3BvbnNlLmRhdGEudXJsLCAndXNlcicpO1xuICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgdGVtcGxhdGVVcmw6ICcvc3RhdGljL29yY2hlc3RyYS9jb21tb24vY29tcG9uZW50cy9xdWlsbC9wYXJ0aWFscy9xdWlsbC5odG1sJ1xuICAgIH07XG4gIH1cbn0pKCk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=

!function(){"use strict";var e=angular.module("orchestra.task.services");e.factory("autoSaveTask",["$rootScope","$timeout","$http","orchestraService",function(e,a,n,t){var o=new function(){var o=this;o.setup=function(a,n,t){o.saveError=!1,o.saving=!1,o.timeout=1e4,o.taskId=n,o.data=t,o.scope=a;var r=e.$on("task.data:change",function(){o.schedule()});a.$on("$destroy",r),window.onbeforeunload=function(){return o.autoSaveTimer||o.saveError?"Your latest changes haven't been saved.":void 0},a.$on("$locationChangeStart",function(e){(o.autoSaveTimer||o.saveError)&&(confirm("Your latest changes haven't been saved.\n\nAre you sure you want to leave this page?")||(window.onbeforeunload=null,e.preventDefault()))})},o.schedule=function(){o.autoSaveTimer||o.scope.is_read_only||(o.autoSaveTimer=a(function(){o.save()},o.timeout))},o.cancel=function(){a.cancel(o.autoSaveTimer),o.autoSaveTimer=void 0},o.save=function(){return o.scope.is_read_only?void 0:(o.saving=!0,o.saveError=!1,o.cancel(),t.signals.fireSignal("save.before")===!1?void(o.saving=!1):void n.post("/orchestra/api/interface/save_task_assignment/",{task_id:o.taskId,task_data:o.data}).success(function(e,a,n,r){o.lastSaved=Date.now(),o.timeout=1e4,t.signals.fireSignal("save.success")}).error(function(e,a,n,r){o.saveError=!0,t.signals.fireSignal("save.error")})["finally"](function(){t.signals.fireSignal("save.finally"),o.saving=!1,o.saveError&&(o.timeout*=2,o.schedule())}))}};return o}])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS90YXNrL2pzL2F1dG9zYXZlLmpzIl0sIm5hbWVzIjpbInNlcnZpY2VNb2R1bGUiLCJhbmd1bGFyIiwibW9kdWxlIiwiZmFjdG9yeSIsIiRyb290U2NvcGUiLCIkdGltZW91dCIsIiRodHRwIiwib3JjaGVzdHJhU2VydmljZSIsImF1dG9TYXZlVGFzayIsImF1dG9TYXZlciIsInRoaXMiLCJzZXR1cCIsIiRzY29wZSIsInRhc2tJZCIsInRhc2tEYXRhIiwic2F2ZUVycm9yIiwic2F2aW5nIiwidGltZW91dCIsImRhdGEiLCJzY29wZSIsImhhbmRsZXIiLCIkb24iLCJzY2hlZHVsZSIsIndpbmRvdyIsIm9uYmVmb3JldW5sb2FkIiwiYXV0b1NhdmVUaW1lciIsImUiLCJjb25maXJtIiwicHJldmVudERlZmF1bHQiLCJpc19yZWFkX29ubHkiLCJzYXZlIiwiY2FuY2VsIiwidW5kZWZpbmVkIiwic2lnbmFscyIsImZpcmVTaWduYWwiLCJwb3N0IiwidGFza19pZCIsInRhc2tfZGF0YSIsInN1Y2Nlc3MiLCJzdGF0dXMiLCJoZWFkZXJzIiwiY29uZmlnIiwibGFzdFNhdmVkIiwiRGF0ZSIsIm5vdyIsImVycm9yIl0sIm1hcHBpbmdzIjoiQ0FBQSxXQUNFLFlBRUEsSUFBSUEsR0FBaUJDLFFBQVFDLE9BQU8sMEJBRXBDRixHQUFjRyxRQUFRLGdCQUFBLGFBQUEsV0FBQSxRQUFBLG1CQUFnQixTQUFTQyxFQUFZQyxFQUFVQyxFQUFPQyxHQUMxRSxHQUFJQyxHQUFlLEdBQUksWUFDckIsR0FBSUMsR0FBWUMsSUFFaEJELEdBQVVFLE1BQVEsU0FBU0MsRUFBUUMsRUFBUUMsR0FDekNMLEVBQVVNLFdBQVksRUFDdEJOLEVBQVVPLFFBQVMsRUFDbkJQLEVBQVVRLFFBQVUsSUFDcEJSLEVBQVVJLE9BQVNBLEVBQ25CSixFQUFVUyxLQUFPSixFQUNqQkwsRUFBVVUsTUFBUVAsQ0FFbEIsSUFBSVEsR0FBVWhCLEVBQVdpQixJQUFJLG1CQUFvQixXQUMvQ1osRUFBVWEsWUFFWlYsR0FBT1MsSUFBSSxXQUFZRCxHQUd2QkcsT0FBT0MsZUFBaUIsV0FDdEIsTUFBSWYsR0FBVWdCLGVBQWlCaEIsRUFBVU0sVUFDaEMsMENBRFQsUUFNRkgsRUFBT1MsSUFBSSx1QkFBd0IsU0FBU0ssSUFDdENqQixFQUFVZ0IsZUFBaUJoQixFQUFVTSxhQUNsQ1ksUUFBUSwwRkFHWEosT0FBT0MsZUFBaUIsS0FDeEJFLEVBQUVFLHNCQU1WbkIsRUFBVWEsU0FBVyxXQUNkYixFQUFVZ0IsZUFBa0JoQixFQUFVVSxNQUFNVSxlQUMvQ3BCLEVBQVVnQixjQUFnQnBCLEVBQVMsV0FDakNJLEVBQVVxQixRQUNUckIsRUFBVVEsV0FJakJSLEVBQVVzQixPQUFTLFdBQ2pCMUIsRUFBUzBCLE9BQU90QixFQUFVZ0IsZUFDMUJoQixFQUFVZ0IsY0FBZ0JPLFFBRzVCdkIsRUFBVXFCLEtBQU8sV0FDZixNQUFJckIsR0FBVVUsTUFBTVUsYUFBcEIsUUFHQXBCLEVBQVVPLFFBQVMsRUFDbkJQLEVBQVVNLFdBQVksRUFDdEJOLEVBQVVzQixTQUNOeEIsRUFBaUIwQixRQUFRQyxXQUFXLGtCQUFtQixPQUd6RHpCLEVBQVVPLFFBQVMsT0FHckJWLEdBQU02QixLQUFLLGtEQUNMQyxRQUFXM0IsRUFBVUksT0FBUXdCLFVBQWE1QixFQUFVUyxPQUN6RG9CLFFBQVEsU0FBU3BCLEVBQU1xQixFQUFRQyxFQUFTQyxHQUN2Q2hDLEVBQVVpQyxVQUFZQyxLQUFLQyxNQUUzQm5DLEVBQVVRLFFBQVUsSUFDcEJWLEVBQWlCMEIsUUFBUUMsV0FBVyxrQkFFckNXLE1BQU0sU0FBUzNCLEVBQU1xQixFQUFRQyxFQUFTQyxHQUNyQ2hDLEVBQVVNLFdBQVksRUFDdEJSLEVBQWlCMEIsUUFBUUMsV0FBVyxnQkFWdEM1QixXQVlTLFdBQ1BDLEVBQWlCMEIsUUFBUUMsV0FBVyxnQkFDcEN6QixFQUFVTyxRQUFTLEVBQ2ZQLEVBQVVNLFlBRVpOLEVBQVVRLFNBQVcsRUFDckJSLEVBQVVhLGdCQU1sQixPQUFPZCIsImZpbGUiOiJvcmNoZXN0cmEvdGFzay9qcy9hdXRvc2F2ZS5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICB2YXIgc2VydmljZU1vZHVsZSA9ICBhbmd1bGFyLm1vZHVsZSgnb3JjaGVzdHJhLnRhc2suc2VydmljZXMnKTtcblxuICBzZXJ2aWNlTW9kdWxlLmZhY3RvcnkoJ2F1dG9TYXZlVGFzaycsIGZ1bmN0aW9uKCRyb290U2NvcGUsICR0aW1lb3V0LCAkaHR0cCwgb3JjaGVzdHJhU2VydmljZSkge1xuICAgIHZhciBhdXRvU2F2ZVRhc2sgPSBuZXcgZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgYXV0b1NhdmVyID0gdGhpcztcblxuICAgICAgYXV0b1NhdmVyLnNldHVwID0gZnVuY3Rpb24oJHNjb3BlLCB0YXNrSWQsIHRhc2tEYXRhKSB7XG4gICAgICAgIGF1dG9TYXZlci5zYXZlRXJyb3IgPSBmYWxzZTtcbiAgICAgICAgYXV0b1NhdmVyLnNhdmluZyA9IGZhbHNlO1xuICAgICAgICBhdXRvU2F2ZXIudGltZW91dCA9IDEwMDAwO1xuICAgICAgICBhdXRvU2F2ZXIudGFza0lkID0gdGFza0lkO1xuICAgICAgICBhdXRvU2F2ZXIuZGF0YSA9IHRhc2tEYXRhO1xuICAgICAgICBhdXRvU2F2ZXIuc2NvcGUgPSAkc2NvcGU7XG5cbiAgICAgICAgdmFyIGhhbmRsZXIgPSAkcm9vdFNjb3BlLiRvbigndGFzay5kYXRhOmNoYW5nZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGF1dG9TYXZlci5zY2hlZHVsZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBoYW5kbGVyKTtcblxuICAgICAgICAvLyBCcm93c2VyIGNsb3NlIG9yIHJlbG9hZFxuICAgICAgICB3aW5kb3cub25iZWZvcmV1bmxvYWQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICBpZiAoYXV0b1NhdmVyLmF1dG9TYXZlVGltZXIgfHwgYXV0b1NhdmVyLnNhdmVFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuICdZb3VyIGxhdGVzdCBjaGFuZ2VzIGhhdmVuXFwndCBiZWVuIHNhdmVkLidcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBbmd1bGFyIGxvY2F0aW9uIGNoYW5nZVxuICAgICAgICAkc2NvcGUuJG9uKCckbG9jYXRpb25DaGFuZ2VTdGFydCcsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICBpZiAoYXV0b1NhdmVyLmF1dG9TYXZlVGltZXIgfHwgYXV0b1NhdmVyLnNhdmVFcnJvcikge1xuICAgICAgICAgICAgaWYgKCFjb25maXJtKCdZb3VyIGxhdGVzdCBjaGFuZ2VzIGhhdmVuXFwndCBiZWVuIHNhdmVkLlxcblxcbicgK1xuICAgICAgICAgICAgICAgICAgJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBsZWF2ZSB0aGlzIHBhZ2U/JykpIHtcbiAgICAgICAgICAgICAgLy8gRGlzYWJsZSBjb25maXJtIGRpYWxvZyBpZiBuYXZpZ2F0aW5nIGF3YXkgZnJvbSB0YXNrIHZpZXcuXG4gICAgICAgICAgICAgIHdpbmRvdy5vbmJlZm9yZXVubG9hZCA9IG51bGw7XG4gICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBhdXRvU2F2ZXIuc2NoZWR1bGUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKCFhdXRvU2F2ZXIuYXV0b1NhdmVUaW1lciAmJiAhYXV0b1NhdmVyLnNjb3BlLmlzX3JlYWRfb25seSkge1xuICAgICAgICAgIGF1dG9TYXZlci5hdXRvU2F2ZVRpbWVyID0gJHRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBhdXRvU2F2ZXIuc2F2ZSgpO1xuICAgICAgICAgIH0sIGF1dG9TYXZlci50aW1lb3V0KVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGF1dG9TYXZlci5jYW5jZWwgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgJHRpbWVvdXQuY2FuY2VsKGF1dG9TYXZlci5hdXRvU2F2ZVRpbWVyKTtcbiAgICAgICAgYXV0b1NhdmVyLmF1dG9TYXZlVGltZXIgPSB1bmRlZmluZWQ7XG4gICAgICB9XG5cbiAgICAgIGF1dG9TYXZlci5zYXZlID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChhdXRvU2F2ZXIuc2NvcGUuaXNfcmVhZF9vbmx5KSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGF1dG9TYXZlci5zYXZpbmcgPSB0cnVlO1xuICAgICAgICBhdXRvU2F2ZXIuc2F2ZUVycm9yID0gZmFsc2U7XG4gICAgICAgIGF1dG9TYXZlci5jYW5jZWwoKTtcbiAgICAgICAgaWYgKG9yY2hlc3RyYVNlcnZpY2Uuc2lnbmFscy5maXJlU2lnbmFsKCdzYXZlLmJlZm9yZScpID09PSBmYWxzZSkge1xuICAgICAgICAgIC8vIElmIGFueSBvZiB0aGUgcmVnaXN0ZXJlZCBzaWduYWwgaGFuZGxlcnMgcmV0dXJucyBmYWxzZSwgcHJldmVudFxuICAgICAgICAgIC8vIHNhdmUuXG4gICAgICAgICAgYXV0b1NhdmVyLnNhdmluZyA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfTtcbiAgICAgICAgJGh0dHAucG9zdCgnL29yY2hlc3RyYS9hcGkvaW50ZXJmYWNlL3NhdmVfdGFza19hc3NpZ25tZW50LycsXG4gICAgICAgICAgICAgeyd0YXNrX2lkJzogYXV0b1NhdmVyLnRhc2tJZCwgJ3Rhc2tfZGF0YSc6IGF1dG9TYXZlci5kYXRhfSlcbiAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHtcbiAgICAgICAgICBhdXRvU2F2ZXIubGFzdFNhdmVkID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAvLyBSZXNldCB0aW1lb3V0IGNvdW50ZXIgb24gc2F2ZSBzdWNjZXNzXG4gICAgICAgICAgYXV0b1NhdmVyLnRpbWVvdXQgPSAxMDAwMDtcbiAgICAgICAgICBvcmNoZXN0cmFTZXJ2aWNlLnNpZ25hbHMuZmlyZVNpZ25hbCgnc2F2ZS5zdWNjZXNzJyk7XG4gICAgICAgIH0pXG4gICAgICAgIC5lcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykge1xuICAgICAgICAgIGF1dG9TYXZlci5zYXZlRXJyb3IgPSB0cnVlO1xuICAgICAgICAgIG9yY2hlc3RyYVNlcnZpY2Uuc2lnbmFscy5maXJlU2lnbmFsKCdzYXZlLmVycm9yJyk7XG4gICAgICAgIH0pXG4gICAgICAgIC5maW5hbGx5KGZ1bmN0aW9uKCkge1xuICAgICAgICAgIG9yY2hlc3RyYVNlcnZpY2Uuc2lnbmFscy5maXJlU2lnbmFsKCdzYXZlLmZpbmFsbHknKTtcbiAgICAgICAgICBhdXRvU2F2ZXIuc2F2aW5nID0gZmFsc2U7XG4gICAgICAgICAgaWYgKGF1dG9TYXZlci5zYXZlRXJyb3IpIHtcbiAgICAgICAgICAgIC8vIFJldHJ5IHNhdmUgd2l0aCBleHAgYmFja29mZlxuICAgICAgICAgICAgYXV0b1NhdmVyLnRpbWVvdXQgKj0gMjtcbiAgICAgICAgICAgIGF1dG9TYXZlci5zY2hlZHVsZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBhdXRvU2F2ZVRhc2s7XG4gIH0pO1xufSkoKVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

!function(){"use strict";function orchestraQuill($http,$timeout){return{restrict:"E",scope:{data:"=",imagePrefix:"=?",readonly:"=",uploadLimitMb:"=?"},link:function(scope,el,attr){function pasteImage(e){if(e.clipboardData&&e.clipboardData.items){var copiedData=e.clipboardData.items[0],imageFile=copiedData.getAsFile();uploadImage(imageFile,scope.editor.getSelection(),e)}}function dropImage(e){for(var files=e.dataTransfer.files,i=files.length-1;i>=0;i--){var file=files[i],dropOffset=getDropIndexOffset(e);uploadImage(file,{start:dropOffset,end:dropOffset},e)}}function getDropIndexOffset(dropEvent){function getDropCharOffset(x,y){var range;if(document.caretPositionFromPoint){var pos=document.caretPositionFromPoint(x,y);return{offset:pos.offset,node:pos.offsetNode}}return document.caretRangeFromPoint?(range=document.caretRangeFromPoint(x,y),{offset:range.startOffset,node:range.startContainer}):void document.body.createTextRange}function getAllChildNodes(parent){for(var bfsStack=[parent],nodes=[];bfsStack.length;){var currentNode=bfsStack.pop();currentNode.childNodes&&(bfsStack=bfsStack.concat(Array.prototype.slice.call(currentNode.childNodes))),nodes.push(currentNode)}return nodes.reverse()}function getLeafNodes(parent){var textNodeType=3,nodes=getAllChildNodes(parent),leafNodes=nodes.filter(function(elem){return elem.nodeType===textNodeType||!elem.firstChild});return leafNodes}var caretPosition=getDropCharOffset(dropEvent.clientX,dropEvent.clientY);if(!caretPosition)return scope.editor.getLength();var leaves=getLeafNodes(editorContainer.getElementsByClassName("ql-editor")[0]),opIndex=leaves.indexOf(caretPosition.node),contents=scope.editor.getContents();return contents.ops=contents.ops.slice(0,opIndex),contents.length()+caretPosition.offset}function uploadImage(file,range,e){var uploadAPIEndpoint="/orchestra/api/interface/upload_image/",supportedTypes=["image/jpeg","image/png","image/gif"];if(-1===supportedTypes.indexOf(file.type))return void alert("Files type "+file.type+" not supported.");if(e&&e.preventDefault(),null===range){var endIndex=scope.editor.getLength();range={start:endIndex,end:endIndex}}var reader=new FileReader;reader.onload=function(e){var rawData=e.target.result,imageData=rawData.substring(rawData.indexOf(",")+1,rawData.length),imageSize=3*imageData.length/4;return imageSize>scope.uploadLimitMb*Math.pow(10,6)?void alert("Files larger than "+scope.uploadLimitMb+"MB cannot be uploaded"):void $http.post(uploadAPIEndpoint,{image_data:imageData,image_type:file.type,prefix:scope.imagePrefix}).then(function(response,status,headers,config){scope.editor.deleteText(range),scope.editor.insertEmbed(range.start,"image",response.data.url,"user")})},reader.readAsDataURL(file)}scope.uploadLimitMb=scope.uploadLimitMb||5,scope.imagePrefix=scope.imagePrefix||"";var editorContainer=el.find(".orchestra-quill-editor").get(0),toolbarContainer=el.find(".orchestra-quill-toolbar").get(0);if(scope.editor=new Quill(editorContainer,{modules:{toolbar:{container:toolbarContainer},"link-tooltip":!0},theme:"snow"}),scope.$watch("data",function(now,before){scope.data&&scope.data!=scope.editor.getHTML()&&scope.editor.setHTML(scope.data)}),scope.readonly)return scope.editor.editor.disable(),void toolbarContainer.remove();scope.editor.on("text-change",function(){$timeout(function(){scope.data=scope.editor.getHTML(),scope.$apply()},0,!1)}),scope.fileSelector=document.createElement("input"),scope.fileSelector.setAttribute("type","file"),scope.fileSelector.setAttribute("accept","image/*");var imageSelector=el.find(".orchestra-quill-toolbar .ql-image").get(0);scope.fileSelector.onchange=function(e){scope.editor.focus();for(var files=scope.fileSelector.files,i=files.length-1;i>=0;i--)null!==files[i]&&uploadImage(files[i],scope.editor.getSelection())},imageSelector.onclick=function(){return scope.fileSelector.click(),!1},editorContainer.addEventListener("paste",pasteImage,!0),editorContainer.addEventListener("drop",dropImage,!0)},templateUrl:"/static/orchestra/common/components/quill/partials/quill.html"}}angular.module("orchestra.common.components.directives").directive("orchestraQuill",["$http","$timeout",orchestraQuill])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9jb21tb24vY29tcG9uZW50cy9xdWlsbC9qcy9kaXJlY3RpdmVzLmpzIl0sIm5hbWVzIjpbIm9yY2hlc3RyYVF1aWxsIiwiJGh0dHAiLCIkdGltZW91dCIsInJlc3RyaWN0Iiwic2NvcGUiLCJkYXRhIiwiaW1hZ2VQcmVmaXgiLCJyZWFkb25seSIsInVwbG9hZExpbWl0TWIiLCJsaW5rIiwiZWwiLCJhdHRyIiwicGFzdGVJbWFnZSIsImUiLCJjbGlwYm9hcmREYXRhIiwiaXRlbXMiLCJjb3BpZWREYXRhIiwiaW1hZ2VGaWxlIiwiZ2V0QXNGaWxlIiwidXBsb2FkSW1hZ2UiLCJlZGl0b3IiLCJnZXRTZWxlY3Rpb24iLCJkcm9wSW1hZ2UiLCJmaWxlcyIsImRhdGFUcmFuc2ZlciIsImkiLCJsZW5ndGgiLCJmaWxlIiwiZHJvcE9mZnNldCIsImdldERyb3BJbmRleE9mZnNldCIsInN0YXJ0IiwiZW5kIiwiZHJvcEV2ZW50IiwiZ2V0RHJvcENoYXJPZmZzZXQiLCJ4IiwieSIsInJhbmdlIiwiZG9jdW1lbnQiLCJjYXJldFBvc2l0aW9uRnJvbVBvaW50IiwicG9zIiwib2Zmc2V0Iiwibm9kZSIsIm9mZnNldE5vZGUiLCJjYXJldFJhbmdlRnJvbVBvaW50Iiwic3RhcnRPZmZzZXQiLCJzdGFydENvbnRhaW5lciIsImJvZHkiLCJjcmVhdGVUZXh0UmFuZ2UiLCJnZXRBbGxDaGlsZE5vZGVzIiwicGFyZW50IiwiYmZzU3RhY2siLCJub2RlcyIsImN1cnJlbnROb2RlIiwicG9wIiwiY2hpbGROb2RlcyIsImNvbmNhdCIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwicHVzaCIsInJldmVyc2UiLCJnZXRMZWFmTm9kZXMiLCJ0ZXh0Tm9kZVR5cGUiLCJsZWFmTm9kZXMiLCJmaWx0ZXIiLCJlbGVtIiwibm9kZVR5cGUiLCJmaXJzdENoaWxkIiwiY2FyZXRQb3NpdGlvbiIsImNsaWVudFgiLCJjbGllbnRZIiwiZ2V0TGVuZ3RoIiwibGVhdmVzIiwiZWRpdG9yQ29udGFpbmVyIiwiZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSIsIm9wSW5kZXgiLCJpbmRleE9mIiwiY29udGVudHMiLCJnZXRDb250ZW50cyIsIm9wcyIsInVwbG9hZEFQSUVuZHBvaW50Iiwic3VwcG9ydGVkVHlwZXMiLCJ0eXBlIiwiYWxlcnQiLCJwcmV2ZW50RGVmYXVsdCIsImVuZEluZGV4IiwicmVhZGVyIiwiRmlsZVJlYWRlciIsIm9ubG9hZCIsInJhd0RhdGEiLCJ0YXJnZXQiLCJyZXN1bHQiLCJpbWFnZURhdGEiLCJzdWJzdHJpbmciLCJpbWFnZVNpemUiLCJNYXRoIiwicG93IiwicG9zdCIsImltYWdlX2RhdGEiLCJpbWFnZV90eXBlIiwicHJlZml4IiwidGhlbiIsInJlc3BvbnNlIiwic3RhdHVzIiwiaGVhZGVycyIsImNvbmZpZyIsImRlbGV0ZVRleHQiLCJpbnNlcnRFbWJlZCIsInVybCIsInJlYWRBc0RhdGFVUkwiLCJmaW5kIiwiZ2V0IiwidG9vbGJhckNvbnRhaW5lciIsIlF1aWxsIiwibW9kdWxlcyIsInRvb2xiYXIiLCJjb250YWluZXIiLCJsaW5rLXRvb2x0aXAiLCJ0aGVtZSIsIiR3YXRjaCIsIm5vdyIsImJlZm9yZSIsImdldEhUTUwiLCJzZXRIVE1MIiwiZGlzYWJsZSIsInJlbW92ZSIsIm9uIiwiJGFwcGx5IiwiZmlsZVNlbGVjdG9yIiwiY3JlYXRlRWxlbWVudCIsInNldEF0dHJpYnV0ZSIsImltYWdlU2VsZWN0b3IiLCJvbmNoYW5nZSIsImZvY3VzIiwib25jbGljayIsImNsaWNrIiwiYWRkRXZlbnRMaXN0ZW5lciIsInRlbXBsYXRlVXJsIiwiYW5ndWxhciIsIm1vZHVsZSIsImRpcmVjdGl2ZSJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQU1BLFNBQVNBLGdCQUFlQyxNQUFPQyxVQUM3QixPQUNFQyxTQUFVLElBQ1ZDLE9BQ0VDLEtBQVEsSUFDUkMsWUFBZSxLQUNmQyxTQUFZLElBQ1pDLGNBQWlCLE1BRW5CQyxLQUFNLFNBQVNMLE1BQU9NLEdB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bkIsTUFBTTZILGFBQWExRyxNQUN0QkUsRUFBSUYsTUFBTUcsT0FBUyxFQUFHRCxHQUFLLEVBQUdBLElBQ3BCLE9BQWJGLE1BQU1FLElBQ1JOLFlBQVlJLE1BQU1FLEdBQUlyQixNQUFNZ0IsT0FBT0MsaUJBSXpDK0csY0FBY0csUUFBVSxXQUV0QixNQURBbkksT0FBTTZILGFBQWFPLFNBQ1osR0FNVDlELGdCQUFnQitELGlCQUFpQixRQUFTN0gsWUFBWSxHQVd0RDhELGdCQUFnQitELGlCQUFpQixPQUFRbkgsV0FBVyxJQTRJdERvSCxZQUFhLGlFQTFPakJDLFFBQ0dDLE9BQU8sMENBQ1BDLFVBQVUsa0JBQW1CLFFBQVMsV0FBWTdJIiwiZmlsZSI6Im9yY2hlc3RyYS9jb21tb24vY29tcG9uZW50cy9xdWlsbC9qcy9kaXJlY3RpdmVzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGFuZ3VsYXJcbiAgICAubW9kdWxlKCdvcmNoZXN0cmEuY29tbW9uLmNvbXBvbmVudHMuZGlyZWN0aXZlcycpXG4gICAgLmRpcmVjdGl2ZSgnb3JjaGVzdHJhUXVpbGwnLCBbJyRodHRwJywgJyR0aW1lb3V0Jywgb3JjaGVzdHJhUXVpbGxdKTtcblxuICBmdW5jdGlvbiBvcmNoZXN0cmFRdWlsbCgkaHR0cCwgJHRpbWVvdXQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcmVzdHJpY3Q6ICdFJyxcbiAgICAgIHNjb3BlOiB7XG4gICAgICAgICdkYXRhJzogJz0nLFxuICAgICAgICAnaW1hZ2VQcmVmaXgnOiAnPT8nLFxuICAgICAgICAncmVhZG9ubHknOiAnPScsXG4gICAgICAgICd1cGxvYWRMaW1pdE1iJzogJz0/JyxcbiAgICAgIH0sXG4gICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWwsIGF0dHIpIHtcbiAgICAgICAgLy8gU3VnZ2VzdGVkIGxpbWl0IGZvciBpbWFnZSB1cGxvYWQgc2l6ZSBpcyA1IE1CLlxuICAgICAgICBzY29wZS51cGxvYWRMaW1pdE1iID0gc2NvcGUudXBsb2FkTGltaXRNYiB8fCA1O1xuXG4gICAgICAgIC8vIERlZmF1bHQgaW1hZ2UgcHJlZml4IGlzIGFuIGVtcHR5IHN0cmluZy5cbiAgICAgICAgc2NvcGUuaW1hZ2VQcmVmaXggPSBzY29wZS5pbWFnZVByZWZpeCB8fCAnJztcblxuICAgICAgICAvLyBDb250YWluZXJzIHdpdGhpbiBkaXJlY3RpdmUgdGVtcGxhdGUgZm9yIFF1aWxsIGVkaXRvclxuICAgICAgICB2YXIgZWRpdG9yQ29udGFpbmVyID0gZWwuZmluZCgnLm9yY2hlc3RyYS1xdWlsbC1lZGl0b3InKS5nZXQoMCk7XG4gICAgICAgIHZhciB0b29sYmFyQ29udGFpbmVyID0gZWwuZmluZCgnLm9yY2hlc3RyYS1xdWlsbC10b29sYmFyJykuZ2V0KDApO1xuXG4gICAgICAgIHNjb3BlLmVkaXRvciA9IG5ldyBRdWlsbChlZGl0b3JDb250YWluZXIsIHtcbiAgICAgICAgICBtb2R1bGVzOiB7XG4gICAgICAgICAgICAndG9vbGJhcic6IHtcbiAgICAgICAgICAgICAgY29udGFpbmVyOiB0b29sYmFyQ29udGFpbmVyXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gSW1hZ2UgdG9vbHRpcCByZW1vdmVkIGluIGZhdm9yIG9mIGZpbGUgc2VsZWN0b3IgZGlhbG9nXG4gICAgICAgICAgICAnbGluay10b29sdGlwJzogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZW1lOiAnc25vdydcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIHR3by13YXkgbGluayBiZXR3ZWVuIHF1aWxsIGFuZCBwYXJlbnQgc2NvcGUgYXR0cmlidXRlIHBhc3NlZFxuICAgICAgICAvLyBpbiBieSBkaXJlY3RpdmUgY2FsbGVyXG4gICAgICAgIHNjb3BlLiR3YXRjaCgnZGF0YScsIGZ1bmN0aW9uKG5vdywgYmVmb3JlKSB7XG4gICAgICAgICAgaWYgKHNjb3BlLmRhdGEgJiYgc2NvcGUuZGF0YSAhPSBzY29wZS5lZGl0b3IuZ2V0SFRNTCgpKSB7XG4gICAgICAgICAgICBzY29wZS5lZGl0b3Iuc2V0SFRNTChzY29wZS5kYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgLy8gRWRpdG9yIHNldCB0byByZWFkLW9ubHkgdXBvbiBpbml0aWFsaXphdGlvbi5cbiAgICAgICAgaWYgKHNjb3BlLnJlYWRvbmx5KSB7XG4gICAgICAgICAgc2NvcGUuZWRpdG9yLmVkaXRvci5kaXNhYmxlKCk7XG4gICAgICAgICAgdG9vbGJhckNvbnRhaW5lci5yZW1vdmUoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBzY29wZS5lZGl0b3Iub24oJ3RleHQtY2hhbmdlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgLy8gU2V0IHRoZSBmb2N1cyBvdXRzaWRlIHRoZSAkZGlnZXN0IGJsb2NrLlxuICAgICAgICAgIC8vIFRha2VuIGZyb20gaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZXJyb3IvJHJvb3RTY29wZS9pbnByb2c/cDA9JGRpZ2VzdC5cbiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNjb3BlLmRhdGEgPSBzY29wZS5lZGl0b3IuZ2V0SFRNTCgpO1xuICAgICAgICAgICAgc2NvcGUuJGFwcGx5KCk7XG4gICAgICAgICAgfSwgMCwgZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgdmlhIHRoZSB0b29sYmFyIGJ1dHRvblxuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2ZpbGUnKTtcbiAgICAgICAgc2NvcGUuZmlsZVNlbGVjdG9yLnNldEF0dHJpYnV0ZSgnYWNjZXB0JywgJ2ltYWdlLyonKTtcbiAgICAgICAgdmFyIGltYWdlU2VsZWN0b3IgPSBlbC5maW5kKCcub3JjaGVzdHJhLXF1aWxsLXRvb2xiYXIgLnFsLWltYWdlJykuZ2V0KDApO1xuICAgICAgICBzY29wZS5maWxlU2VsZWN0b3Iub25jaGFuZ2UgPSBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgLy8gRm9jdXMgdGhlIGVkaXRvciBzbyB3ZSBjYW4gZ2V0IHRoZSBjdXJyZW50IHNlbGVjdGlvbi5cbiAgICAgICAgICBzY29wZS5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICB2YXIgZmlsZXMgPSBzY29wZS5maWxlU2VsZWN0b3IuZmlsZXM7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IGZpbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICBpZiAoZmlsZXNbaV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgdXBsb2FkSW1hZ2UoZmlsZXNbaV0sIHNjb3BlLmVkaXRvci5nZXRTZWxlY3Rpb24oKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBpbWFnZVNlbGVjdG9yLm9uY2xpY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICBzY29wZS5maWxlU2VsZWN0b3IuY2xpY2soKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gVE9ETyhqcmJvdHJvcyk6IG1vdmUgcGFzdGUvZHJvcCBmdW5jdGlvbmFsaXR5IGludG8gYSBxdWlsbGpzIGZvcmtcblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgYnkgcGFzdGluZyBpbiBjb3BpZWQgaW1hZ2UgZGF0YVxuICAgICAgICBlZGl0b3JDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigncGFzdGUnLCBwYXN0ZUltYWdlLCB0cnVlKTtcblxuICAgICAgICBmdW5jdGlvbiBwYXN0ZUltYWdlKGUpIHtcbiAgICAgICAgICBpZiAoZS5jbGlwYm9hcmREYXRhICYmIGUuY2xpcGJvYXJkRGF0YS5pdGVtcykge1xuICAgICAgICAgICAgdmFyIGNvcGllZERhdGEgPSBlLmNsaXBib2FyZERhdGEuaXRlbXNbMF07XG4gICAgICAgICAgICB2YXIgaW1hZ2VGaWxlID0gY29waWVkRGF0YS5nZXRBc0ZpbGUoKTtcbiAgICAgICAgICAgIHVwbG9hZEltYWdlKGltYWdlRmlsZSwgc2NvcGUuZWRpdG9yLmdldFNlbGVjdGlvbigpLCBlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBVcGxvYWQgaW1hZ2UgYnkgZHJhZyBhbmQgZHJvcFxuICAgICAgICBlZGl0b3JDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGRyb3BJbWFnZSwgdHJ1ZSk7XG5cbiAgICAgICAgZnVuY3Rpb24gZHJvcEltYWdlKGUpIHtcbiAgICAgICAgICB2YXIgZmlsZXMgPSBlLmRhdGFUcmFuc2Zlci5maWxlcztcbiAgICAgICAgICBmb3IgKHZhciBpID0gZmlsZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIHZhciBmaWxlID0gZmlsZXNbaV07XG4gICAgICAgICAgICB2YXIgZHJvcE9mZnNldCA9IGdldERyb3BJbmRleE9mZnNldChlKTtcbiAgICAgICAgICAgIHVwbG9hZEltYWdlKGZpbGUsIHtcbiAgICAgICAgICAgICAgJ3N0YXJ0JzogZHJvcE9mZnNldCxcbiAgICAgICAgICAgICAgJ2VuZCc6IGRyb3BPZmZzZXRcbiAgICAgICAgICAgIH0sIGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldERyb3BJbmRleE9mZnNldChkcm9wRXZlbnQpIHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBHaXZlbiBhIGRyb3AgZXZlbnQsIGNhbGN1bGF0ZSB0aGUgaW5kZXggb2Zmc2V0IHdpdGhpbiB0aGVcbiAgICAgICAgICAgKiBRdWlsbCBlZGl0b3IgYnk6XG4gICAgICAgICAgICogICAtIGRldGVybWluaW5nIHRoZSBjaGFyYWN0ZXIgb2Zmc2V0IG9mIHRoZSBkcm9wIHdpdGhpbiB0aGUgaW5uZXIgbm9kZVxuICAgICAgICAgICAqICAgLSBmaW5kaW5nIGFsbCBlZGl0b3IgbGVhZiBub2RlcyAocmVpbXBsZW1lbnRzIHNvbWUgUXVpbGwgZnVuY3Rpb25hbGl0eSlcbiAgICAgICAgICAgKiAgIC0gY2FsY3VsYXRpbmcgdGhlIGluZGV4IG9mZnNldCBmcm9tIHRoZSBsZWFmIG5vZGUgbGVuZ3RocyBhbmQgaW5uZXIgZHJvcCBub2RlIG9mZnNldFxuICAgICAgICAgICAqIFdlIHBsYW4gdG8gcHVzaCB0aGlzIGZ1bmN0aW9uYWxpdHkgaW50byBRdWlsbCBpbiB0aGUgZnV0dXJlLlxuICAgICAgICAgICAqL1xuICAgICAgICAgIGZ1bmN0aW9uIGdldERyb3BDaGFyT2Zmc2V0KHgsIHkpIHtcbiAgICAgICAgICAgIC8vIEhlbHBlciBmdW5jdGlvbiBmb3IgZ2V0dGluZyB0aGUgeC15IGNoYXJhY3RlciBvZmZzZXQgb2YgYSBkcm9wXG4gICAgICAgICAgICAvLyBldmVudCBpbiBhIGNvbnRlbnRlZGl0YWJsZSBmaWVsZC5cbiAgICAgICAgICAgIC8vIE1vZGlmaWVkIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMTA2NTk5OTAuXG4gICAgICAgICAgICB2YXIgcmFuZ2U7XG4gICAgICAgICAgICAvLyBTdGFuZGFyZHMtYmFzZWQgd2F5OyBpbXBsZW1lbnRlZCBvbmx5IGluIEZpcmVmb3hcbiAgICAgICAgICAgIGlmIChkb2N1bWVudC5jYXJldFBvc2l0aW9uRnJvbVBvaW50KSB7XG4gICAgICAgICAgICAgIHZhciBwb3MgPSBkb2N1bWVudC5jYXJldFBvc2l0aW9uRnJvbVBvaW50KHgsIHkpO1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICdvZmZzZXQnOiBwb3Mub2Zmc2V0LFxuICAgICAgICAgICAgICAgICdub2RlJzogcG9zLm9mZnNldE5vZGVcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuY2FyZXRSYW5nZUZyb21Qb2ludCkge1xuICAgICAgICAgICAgICAvLyBXZWJraXRcbiAgICAgICAgICAgICAgcmFuZ2UgPSBkb2N1bWVudC5jYXJldFJhbmdlRnJvbVBvaW50KHgsIHkpO1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICdvZmZzZXQnOiByYW5nZS5zdGFydE9mZnNldCxcbiAgICAgICAgICAgICAgICAnbm9kZSc6IHJhbmdlLnN0YXJ0Q29udGFpbmVyXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LmJvZHkuY3JlYXRlVGV4dFJhbmdlKSB7XG4gICAgICAgICAgICAgIC8vIElFIGRvZXNuJ3QgbmF0aXZlbHkgc3VwcG9ydCByZXRyaWV2aW5nIHRoZSBjaGFyYWN0ZXIgb2Zmc2V0LCBzb1xuICAgICAgICAgICAgICAvLyBpbnNlcnQgaW1hZ2UgYXQgZW5kIG9mIHRleHRcbiAgICAgICAgICAgICAgLy8gVE9ETyhqcmJvdHJvcyk6IHJld3JpdGUgd2l0aCBodHRwczovL2dpdGh1Yi5jb20vdGltZG93bi9yYW5neVxuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZnVuY3Rpb24gZ2V0QWxsQ2hpbGROb2RlcyhwYXJlbnQpIHtcbiAgICAgICAgICAgIC8vIFJldHVybnMgaW4tb3JkZXIgbGlzdCBvZiBhbGwgY2hpbGQgbm9kZXMgb2YgYHBhcmVudGBcbiAgICAgICAgICAgIHZhciBiZnNTdGFjayA9IFtwYXJlbnRdO1xuICAgICAgICAgICAgdmFyIG5vZGVzID0gW107XG4gICAgICAgICAgICB3aGlsZSAoYmZzU3RhY2subGVuZ3RoKSB7XG4gICAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IGJmc1N0YWNrLnBvcCgpO1xuICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuY2hpbGROb2Rlcykge1xuICAgICAgICAgICAgICAgIC8vIENvbmNhdCB3aXRoIGNvcHkgb2YgY2hpbGQgTm9kZUxpc3Q7IGNhbid0IHVzZSBwb3Agb3BlcmF0aW9uXG4gICAgICAgICAgICAgICAgLy8gb24gb3JpZ2luYWxcbiAgICAgICAgICAgICAgICBiZnNTdGFjayA9IGJmc1N0YWNrLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChjdXJyZW50Tm9kZS5jaGlsZE5vZGVzKSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbm9kZXMucHVzaChjdXJyZW50Tm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbm9kZXMucmV2ZXJzZSgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIyMjg5NjUwXG4gICAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZk5vZGVzKHBhcmVudCkge1xuICAgICAgICAgICAgLy8gUmV0dXJucyBpbi1vcmRlciBsaXN0IG9mIGFsbCBRdWlsbCBsZWFmIG5vZGVzIG9mIGBwYXJlbnRgXG4gICAgICAgICAgICB2YXIgdGV4dE5vZGVUeXBlID0gMztcbiAgICAgICAgICAgIHZhciBub2RlcyA9IGdldEFsbENoaWxkTm9kZXMocGFyZW50KTtcbiAgICAgICAgICAgIHZhciBsZWFmTm9kZXMgPSBub2Rlcy5maWx0ZXIoZnVuY3Rpb24oZWxlbSkge1xuICAgICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gdGV4dE5vZGVUeXBlIHx8ICFlbGVtLmZpcnN0Q2hpbGQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBsZWFmTm9kZXM7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIGNhcmV0UG9zaXRpb24gPSBnZXREcm9wQ2hhck9mZnNldChkcm9wRXZlbnQuY2xpZW50WCwgZHJvcEV2ZW50LmNsaWVudFkpO1xuICAgICAgICAgIGlmICghY2FyZXRQb3NpdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmVkaXRvci5nZXRMZW5ndGgoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdmFyIGxlYXZlcyA9IGdldExlYWZOb2RlcyhlZGl0b3JDb250YWluZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgncWwtZWRpdG9yJylbMF0pO1xuICAgICAgICAgIHZhciBvcEluZGV4ID0gbGVhdmVzLmluZGV4T2YoY2FyZXRQb3NpdGlvbi5ub2RlKTtcbiAgICAgICAgICB2YXIgY29udGVudHMgPSBzY29wZS5lZGl0b3IuZ2V0Q29udGVudHMoKTtcbiAgICAgICAgICBjb250ZW50cy5vcHMgPSBjb250ZW50cy5vcHMuc2xpY2UoMCwgb3BJbmRleCk7XG4gICAgICAgICAgcmV0dXJuIGNvbnRlbnRzLmxlbmd0aCgpICsgY2FyZXRQb3NpdGlvbi5vZmZzZXQ7XG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIFBvc3QgaW1hZ2UgZGF0YSB0byBhbiBBUEkgZW5kcG9pbnQgdGhhdCByZXR1cm5zIGFuIGltYWdlIFVSTCwgdGhlblxuICAgICAgICAvLyBhZGRpbmcgaXQgdG8gdGhlIGVkaXRvciAocmVwbGFjaW5nIHRoZSBnaXZlbiBjaGFyYWN0ZXIgcmFuZ2UpXG4gICAgICAgIGZ1bmN0aW9uIHVwbG9hZEltYWdlKGZpbGUsIHJhbmdlLCBlKSB7XG4gICAgICAgICAgdmFyIHVwbG9hZEFQSUVuZHBvaW50ID0gJy9vcmNoZXN0cmEvYXBpL2ludGVyZmFjZS91cGxvYWRfaW1hZ2UvJztcbiAgICAgICAgICB2YXIgc3VwcG9ydGVkVHlwZXMgPSBbJ2ltYWdlL2pwZWcnLCAnaW1hZ2UvcG5nJywgJ2ltYWdlL2dpZiddO1xuXG4gICAgICAgICAgaWYgKHN1cHBvcnRlZFR5cGVzLmluZGV4T2YoZmlsZS50eXBlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIGFsZXJ0KCdGaWxlcyB0eXBlICcgKyBmaWxlLnR5cGUgKyAnIG5vdCBzdXBwb3J0ZWQuJyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfSBlbHNlIGlmIChlKSB7XG4gICAgICAgICAgICAvLyBDYW5jZWwgZGVmYXVsdCBicm93c2VyIGFjdGlvbiBvbmx5IGlmIGZpbGUgaXMgYWN0dWFsbHkgYW4gaW1hZ2VcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBJZiBub3RoaW5nIGlzIHNlbGVjdGVkIGluIHRoZSBlZGl0b3IsIGFwcGVuZCB0aGUgaW1hZ2UgdG8gaXRzIGVuZFxuICAgICAgICAgIGlmIChyYW5nZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgdmFyIGVuZEluZGV4ID0gc2NvcGUuZWRpdG9yLmdldExlbmd0aCgpO1xuICAgICAgICAgICAgcmFuZ2UgPSB7XG4gICAgICAgICAgICAgICdzdGFydCc6IGVuZEluZGV4LFxuICAgICAgICAgICAgICAnZW5kJzogZW5kSW5kZXhcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHZhciByYXdEYXRhID0gZS50YXJnZXQucmVzdWx0O1xuICAgICAgICAgICAgLy8gUmVtb3ZlIHByZXBlbmRlZCBpbWFnZSB0eXBlIGZyb20gZGF0YSBzdHJpbmdcbiAgICAgICAgICAgIHZhciBpbWFnZURhdGEgPSByYXdEYXRhLnN1YnN0cmluZyhyYXdEYXRhLmluZGV4T2YoXCIsXCIpICsgMSwgcmF3RGF0YS5sZW5ndGgpO1xuXG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGF0YSBzaXplIG9mIGI2NC1lbmNvZGVkIHN0cmluZ1xuICAgICAgICAgICAgdmFyIGltYWdlU2l6ZSA9IGltYWdlRGF0YS5sZW5ndGggKiAzIC8gNDtcblxuICAgICAgICAgICAgaWYgKGltYWdlU2l6ZSA+IHNjb3BlLnVwbG9hZExpbWl0TWIgKiBNYXRoLnBvdygxMCwgNikpIHtcbiAgICAgICAgICAgICAgYWxlcnQoJ0ZpbGVzIGxhcmdlciB0aGFuICcgKyBzY29wZS51cGxvYWRMaW1pdE1iICsgJ01CIGNhbm5vdCBiZSB1cGxvYWRlZCcpO1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBQb3N0IGltYWdlIGRhdGEgdG8gQVBJOyByZXNwb25zZSBzaG91bGQgY29udGFpbiB0aGUgdXBsb2FkZWQgaW1hZ2UgdXJsXG4gICAgICAgICAgICAkaHR0cC5wb3N0KHVwbG9hZEFQSUVuZHBvaW50LCB7XG4gICAgICAgICAgICAgICAgJ2ltYWdlX2RhdGEnOiBpbWFnZURhdGEsXG4gICAgICAgICAgICAgICAgJ2ltYWdlX3R5cGUnOiBmaWxlLnR5cGUsXG4gICAgICAgICAgICAgICAgJ3ByZWZpeCc6IHNjb3BlLmltYWdlUHJlZml4XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykge1xuICAgICAgICAgICAgICAgIC8vIFJlcGxhY2Ugc2VsZWN0ZWQgcmFuZ2Ugd2l0aCBuZXcgaW1hZ2VcbiAgICAgICAgICAgICAgICBzY29wZS5lZGl0b3IuZGVsZXRlVGV4dChyYW5nZSk7XG4gICAgICAgICAgICAgICAgc2NvcGUuZWRpdG9yLmluc2VydEVtYmVkKHJhbmdlLnN0YXJ0LCAnaW1hZ2UnLCByZXNwb25zZS5kYXRhLnVybCwgJ3VzZXInKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHRlbXBsYXRlVXJsOiAnL3N0YXRpYy9vcmNoZXN0cmEvY29tbW9uL2NvbXBvbmVudHMvcXVpbGwvcGFydGlhbHMvcXVpbGwuaHRtbCdcbiAgICB9O1xuICB9XG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

!function(){"use strict";var serviceModule=angular.module("orchestra.project_management.services");serviceModule.factory("dataService",["$rootScope","$location","orchestraApi",function($rootScope,$location,orchestraApi){var _meta,_now=new Date;return{setup:function(projectId){_meta={tasks:{}},this.projectId=projectId},updateData:function(cb){var dataService=this;orchestraApi.projectInformation(this.projectId).then(function(response){dataService.setData(response.data),"Aborted"===dataService.data.project.status?(alert("Project is aborted."),$location.path("/")):($rootScope.$broadcast("orchestra:projectManagement:dataUpdate"),cb&&cb())},function(response){var errorMessage="Error updating data.";400===response.status&&(errorMessage=response.data.message),alert(errorMessage)})},setData:function(data){this.data=data;var steps={};this.data.steps.forEach(function(step){steps[step.slug]=step}),this.data.steps=steps;for(var step_slug in this.data.tasks){var task=this.data.tasks[step_slug];task.is_human=this.data.steps[task.step_slug].is_human,task.assignments.forEach(function(assignment){assignment.task=task,assignment.iterations.forEach(function(iteration,i){iteration.assignment=assignment})})}var dataService=this;this.timeSortedSlugs=Object.keys(this.data.tasks).sort(function(a,b){var previousTask=dataService.data.tasks[a],nextTask=dataService.data.tasks[b];return d3.ascending(new Date(previousTask.start_datetime),new Date(nextTask.start_datetime))})},taskFromKey:function(key){return this.data.tasks[key]},keyFromTask:function(task){return task.step_slug},awaitingAssignment:function(task){var statuses=["Awaiting Processing","Pending Review"];return statuses.indexOf(task.status)>=0},inProgressAssignment:function(task){var statuses=["Processing","Post-review Processing","Reviewing"];return statuses.indexOf(task.status)>=0||this.awaitingAssignment(task)},taskMeta:function(taskKey,metaKey,value){var taskMeta=_meta.tasks[taskKey]||{};return void 0===value?taskMeta[metaKey]:(taskMeta[metaKey]=value,void(_meta.tasks[taskKey]=taskMeta))},taskEnd:function(task){if(this.awaitingAssignment(task))return _now.toString();var taskEnd=task.start_datetime;return task.assignments.forEach(function(assignment){if(assignment.iterations.length){var lastIteration=assignment.iterations[assignment.iterations.length-1];new Date(lastIteration.end_datetime)>new Date(taskEnd)&&(taskEnd=lastIteration.end_datetime)}}),taskEnd},assignmentFromKey:function(key){return this.taskFromKey(key.taskKey).assignments[key.assignmentIndex]},keyFromAssignment:function(assignment){var dataService=this;return{taskKey:dataService.keyFromTask(assignment.task),assignmentIndex:dataService.indexFromAssignment(assignment)}},indexFromAssignment:function(assignment){return assignment.task.assignments.indexOf(assignment)},iterationFromKey:function(key){return this.assignmentFromKey(key.assignmentKey).iterations[key.iterationIndex]},keyFromIteration:function(iteration){var dataService=this;return{assignmentKey:dataService.keyFromAssignment(iteration.assignment),iterationIndex:iteration.assignment.iterations.indexOf(iteration)}}}}])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvZGF0YV9zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbInNlcnZpY2VNb2R1bGUiLCJhbmd1bGFyIiwibW9kdWxlIiwiZmFjdG9yeSIsIiRyb290U2NvcGUiLCIkbG9jYXRpb24iLCJvcmNoZXN0cmFBcGkiLCJfbWV0YSIsIl9ub3ciLCJEYXRlIiwic2V0dXAiLCJwcm9qZWN0SWQiLCJ0YXNrcyIsInRoaXMiLCJ1cGRhdGVEYXRhIiwiY2IiLCJkYXRhU2VydmljZSIsInByb2plY3RJbmZvcm1hdGlvbiIsInRoZW4iLCJyZXNwb25zZSIsInNldERhdGEiLCJkYXRhIiwicHJvamVjdCIsInN0YXR1cyIsImFsZXJ0IiwicGF0aCIsIiRicm9hZGNhc3QiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwic3RlcHMiLCJmb3JFYWNoIiwic3RlcCIsInNsdWciLCJzdGVwX3NsdWciLCJ0YXNrIiwiaXNfaHVtYW4iLCJhc3NpZ25tZW50cyIsImFzc2lnbm1lbnQiLCJpdGVyYXRpb25zIiwiaXRlcmF0aW9uIiwiaSIsInRpbWVTb3J0ZWRTbHVncyIsIk9iamVjdCIsImtleXMiLCJzb3J0IiwiYSIsImIiLCJwcmV2aW91c1Rhc2siLCJuZXh0VGFzayIsImQzIiwiYXNjZW5kaW5nIiwic3RhcnRfZGF0ZXRpbWUiLCJ0YXNrRnJvbUtleSIsImtleSIsImtleUZyb21UYXNrIiwiYXdhaXRpbmdBc3NpZ25tZW50Iiwic3RhdHVzZXMiLCJpbmRleE9mIiwiaW5Qcm9ncmVzc0Fzc2lnbm1lbnQiLCJ0YXNrTWV0YSIsInRhc2tLZXkiLCJtZXRhS2V5IiwidmFsdWUiLCJ1bmRlZmluZWQiLCJ0YXNrRW5kIiwidG9TdHJpbmciLCJsZW5ndGgiLCJsYXN0SXRlcmF0aW9uIiwiZW5kX2RhdGV0aW1lIiwiYXNzaWdubWVudEZyb21LZXkiLCJhc3NpZ25tZW50SW5kZXgiLCJrZXlGcm9tQXNzaWdubWVudCIsImluZGV4RnJvbUFzc2lnbm1lbnQiLCJpdGVyYXRpb25Gcm9tS2V5IiwiYXNzaWdubWVudEtleSIsIml0ZXJhdGlvbkluZGV4Iiwia2V5RnJvbUl0ZXJhdGlvbiJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQUVBLElBQUlBLGVBQWdCQyxRQUFRQyxPQUFPLHdDQUVuQ0YsZUFBY0csUUFBUSxlQUFBLGFBQUEsWUFBQSxlQUFlLFNBQVNDLFdBQVlDLFVBQVdDLGNBS25FLEdBQUlDLE9BQ0FDLEtBQU8sR0FBSUMsS0FFZixRQUNFQyxNQUFPLFNBQVNDLFdBQ2RKLE9BQ0VLLFVBRUZDLEtBQUtGLFVBQVlBLFdBRW5CRyxXQUFZLFNBQVNDLElBSW5CLEdBQUlDLGFBQWNILElBQ2xCUCxjQUFhVyxtQkFBbUJKLEtBQUtGLFdBQ2xDTyxLQUFLLFNBQVNDLFVBQ2JILFlBQVlJLFFBQVFELFNBQVNFLE1BQ1csWUFBcENMLFlBQVlLLEtBQUtDLFFBQVFDLFFBQzNCQyxNQUFNLHVCQUNObkIsVUFBVW9CLEtBQUssT0FFZnJCLFdBQVdzQixXQUFXLDBDQUNsQlgsSUFDRkEsT0FHSCxTQUFTSSxVQUNWLEdBQUlRLGNBQWUsc0JBQ0ssT0FBcEJSLFNBQVNJLFNBQ1hJLGFBQWVSLFNBQVNFLEtBQUtPLFNBRS9CSixNQUFNRyxpQkFHWlAsUUFBUyxTQUFTQyxNQUloQlIsS0FBS1EsS0FBT0EsSUFFWixJQUFJUSxTQUNKaEIsTUFBS1EsS0FBS1EsTUFBTUMsUUFBUSxTQUFTQyxNQUMvQkYsTUFBTUUsS0FBS0MsTUFBUUQsT0FHckJsQixLQUFLUSxLQUFLUSxNQUFRQSxLQUlsQixLQUFLLEdBQUlJLGFBQWFwQixNQUFLUSxLQUFLVCxNQUFPLENBQ3JDLEdBQUlzQixNQUFPckIsS0FBS1EsS0FBS1QsTUFBTXFCLFVBQzNCQyxNQUFLQyxTQUFXdEIsS0FBS1EsS0FBS1EsTUFBTUssS0FBS0QsV0FBV0UsU0FDaERELEtBQUtFLFlBQVlOLFFBQVEsU0FBU08sWUFDaENBLFdBQVdILEtBQU9BLEtBQ2xCRyxXQUFXQyxXQUFXUixRQUFRLFNBQVNTLFVBQVdDLEdBQ2hERCxVQUFVRixXQUFhQSxlQUs3QixHQUFJckIsYUFBY0gsSUFDbEJBLE1BQUs0QixnQkFBa0JDLE9BQU9DLEtBQUs5QixLQUFLUSxLQUFLVCxPQUFPZ0MsS0FBSyxTQUFTQyxFQUFHQyxHQUNuRSxHQUFJQyxjQUFlL0IsWUFBWUssS0FBS1QsTUFBTWlDLEdBQ3RDRyxTQUFXaEMsWUFBWUssS0FBS1QsTUFBTWtDLEVBQ3RDLE9BQU9HLElBQUdDLFVBQVUsR0FBSXpDLE1BQUtzQyxhQUFhSSxnQkFDeEMsR0FBSTFDLE1BQUt1QyxTQUFTRyxvQkFHeEJDLFlBQWEsU0FBU0MsS0FJcEIsTUFBT3hDLE1BQUtRLEtBQUtULE1BQU15QyxNQUV6QkMsWUFBYSxTQUFTcEIsTUFJcEIsTUFBT0EsTUFBS0QsV0FFZHNCLG1CQUFvQixTQUFTckIsTUFJM0IsR0FBSXNCLFdBQVksc0JBQXVCLGlCQUN2QyxPQUFPQSxVQUFTQyxRQUFRdkIsS0FBS1gsU0FBVyxHQUUxQ21DLHFCQUFzQixTQUFTeEIsTUFJN0IsR0FBSXNCLFdBQVksYUFBYyx5QkFBMEIsWUFDeEQsT0FBT0EsVUFBU0MsUUFBUXZCLEtBQUtYLFNBQVcsR0FBS1YsS0FBSzBDLG1CQUFtQnJCLE9BRXZFeUIsU0FBVSxTQUFTQyxRQUFTQyxRQUFTQyxPQU1uQyxHQUFJSCxVQUFXcEQsTUFBTUssTUFBTWdELFlBQzNCLE9BQWNHLFVBQVZELE1BSUtILFNBQVNFLFVBSGhCRixTQUFTRSxTQUFXQyxXQUNwQnZELE1BQU1LLE1BQU1nRCxTQUFXRCxZQUszQkssUUFBUyxTQUFTOUIsTUFJaEIsR0FBSXJCLEtBQUswQyxtQkFBbUJyQixNQUMxQixNQUFPMUIsTUFBS3lELFVBRWQsSUFBSUQsU0FBVTlCLEtBQUtpQixjQVNuQixPQVJBakIsTUFBS0UsWUFBWU4sUUFBUSxTQUFTTyxZQUNoQyxHQUFJQSxXQUFXQyxXQUFXNEIsT0FBUSxDQUNoQyxHQUFJQyxlQUFnQjlCLFdBQVdDLFdBQVdELFdBQVdDLFdBQVc0QixPQUFTLEVBQ3JFLElBQUl6RCxNQUFLMEQsY0FBY0MsY0FBZ0IsR0FBSTNELE1BQUt1RCxXQUNsREEsUUFBVUcsY0FBY0MsaUJBSXZCSixTQUdUSyxrQkFBbUIsU0FBU2hCLEtBSTFCLE1BQU94QyxNQUFLdUMsWUFBWUMsSUFBSU8sU0FDekJ4QixZQUFZaUIsSUFBSWlCLGtCQUVyQkMsa0JBQW1CLFNBQVNsQyxZQUkxQixHQUFJckIsYUFBY0gsSUFDbEIsUUFDRStDLFFBQVc1QyxZQUFZc0MsWUFBWWpCLFdBQVdILE1BQzlDb0MsZ0JBQW1CdEQsWUFBWXdELG9CQUFvQm5DLGNBR3ZEbUMsb0JBQXFCLFNBQVNuQyxZQUk1QixNQUFPQSxZQUFXSCxLQUFLRSxZQUFZcUIsUUFBUXBCLGFBRzdDb0MsaUJBQWtCLFNBQVNwQixLQUl6QixNQUFPeEMsTUFBS3dELGtCQUFrQmhCLElBQUlxQixlQUFlcEMsV0FBV2UsSUFBSXNCLGlCQUVsRUMsaUJBQWtCLFNBQVNyQyxXQUl6QixHQUFJdkIsYUFBY0gsSUFDbEIsUUFDRTZELGNBQWlCMUQsWUFBWXVELGtCQUFrQmhDLFVBQVVGLFlBQ3pEc0MsZUFBa0JwQyxVQUFVRixXQUFXQyxXQUFXbUIsUUFBUWxCIiwiZmlsZSI6Im9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvZGF0YV9zZXJ2aWNlLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIHZhciBzZXJ2aWNlTW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ29yY2hlc3RyYS5wcm9qZWN0X21hbmFnZW1lbnQuc2VydmljZXMnKTtcblxuICBzZXJ2aWNlTW9kdWxlLmZhY3RvcnkoJ2RhdGFTZXJ2aWNlJywgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGxvY2F0aW9uLCBvcmNoZXN0cmFBcGkpIHtcbiAgICAvKipcbiAgICAgKiBTZXJ2aWNlIHRvIHNoYXJlIGFuZCBtYW5pcHVsYXRlIHByb2plY3QgbWFuYWdlbWVudCBkYXRhIGFjcm9zc1xuICAgICAqIHZpc3VhbGl6YXRpb24gY29tcG9uZW50cy5cbiAgICAgKi9cbiAgICB2YXIgX21ldGE7XG4gICAgdmFyIF9ub3cgPSBuZXcgRGF0ZSgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNldHVwOiBmdW5jdGlvbihwcm9qZWN0SWQpIHtcbiAgICAgICAgX21ldGEgPSB7XG4gICAgICAgICAgJ3Rhc2tzJzoge31cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5wcm9qZWN0SWQgPSBwcm9qZWN0SWQ7XG4gICAgICB9LFxuICAgICAgdXBkYXRlRGF0YTogZnVuY3Rpb24oY2IpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHJpZXZlcyBsYXRlc3QgcHJvamVjdCBkYXRhIGZyb20gT3JjaGVzdHJhLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIGRhdGFTZXJ2aWNlID0gdGhpcztcbiAgICAgICAgb3JjaGVzdHJhQXBpLnByb2plY3RJbmZvcm1hdGlvbih0aGlzLnByb2plY3RJZClcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgZGF0YVNlcnZpY2Uuc2V0RGF0YShyZXNwb25zZS5kYXRhKTtcbiAgICAgICAgICAgIGlmIChkYXRhU2VydmljZS5kYXRhLnByb2plY3Quc3RhdHVzID09PSAnQWJvcnRlZCcpIHtcbiAgICAgICAgICAgICAgYWxlcnQoJ1Byb2plY3QgaXMgYWJvcnRlZC4nKTtcbiAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoJy8nKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnb3JjaGVzdHJhOnByb2plY3RNYW5hZ2VtZW50OmRhdGFVcGRhdGUnKTtcbiAgICAgICAgICAgICAgaWYgKGNiKSB7XG4gICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICB2YXIgZXJyb3JNZXNzYWdlID0gJ0Vycm9yIHVwZGF0aW5nIGRhdGEuJztcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMCkge1xuICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSByZXNwb25zZS5kYXRhLm1lc3NhZ2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhbGVydChlcnJvck1lc3NhZ2UpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIHNldERhdGE6IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFByZXBhcmVzIHJhdyBwcm9qZWN0IGRhdGEgZm9yIHZpc3VhbGl6YXRpb24uXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xuXG4gICAgICAgIHZhciBzdGVwcyA9IHt9O1xuICAgICAgICB0aGlzLmRhdGEuc3RlcHMuZm9yRWFjaChmdW5jdGlvbihzdGVwKSB7XG4gICAgICAgICAgc3RlcHNbc3RlcC5zbHVnXSA9IHN0ZXA7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZGF0YS5zdGVwcyA9IHN0ZXBzO1xuXG4gICAgICAgICAvKmpzaGludCAtVzA4MyAqL1xuICAgICAgICAvLyBIaWRlIGVycm9yIGZvciBjcmVhdGluZyBhIGZ1bmN0aW9uIGluIGEgbG9vcFxuICAgICAgICBmb3IgKHZhciBzdGVwX3NsdWcgaW4gdGhpcy5kYXRhLnRhc2tzKSB7XG4gICAgICAgICAgdmFyIHRhc2sgPSB0aGlzLmRhdGEudGFza3Nbc3RlcF9zbHVnXTtcbiAgICAgICAgICB0YXNrLmlzX2h1bWFuID0gdGhpcy5kYXRhLnN0ZXBzW3Rhc2suc3RlcF9zbHVnXS5pc19odW1hbjtcbiAgICAgICAgICB0YXNrLmFzc2lnbm1lbnRzLmZvckVhY2goZnVuY3Rpb24oYXNzaWdubWVudCkge1xuICAgICAgICAgICAgYXNzaWdubWVudC50YXNrID0gdGFzaztcbiAgICAgICAgICAgIGFzc2lnbm1lbnQuaXRlcmF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZXJhdGlvbiwgaSkge1xuICAgICAgICAgICAgICBpdGVyYXRpb24uYXNzaWdubWVudCA9IGFzc2lnbm1lbnQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBkYXRhU2VydmljZSA9IHRoaXM7XG4gICAgICAgIHRoaXMudGltZVNvcnRlZFNsdWdzID0gT2JqZWN0LmtleXModGhpcy5kYXRhLnRhc2tzKS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtcbiAgICAgICAgICB2YXIgcHJldmlvdXNUYXNrID0gZGF0YVNlcnZpY2UuZGF0YS50YXNrc1thXTtcbiAgICAgICAgICB2YXIgbmV4dFRhc2sgPSBkYXRhU2VydmljZS5kYXRhLnRhc2tzW2JdO1xuICAgICAgICAgIHJldHVybiBkMy5hc2NlbmRpbmcobmV3IERhdGUocHJldmlvdXNUYXNrLnN0YXJ0X2RhdGV0aW1lKSxcbiAgICAgICAgICAgIG5ldyBEYXRlKG5leHRUYXNrLnN0YXJ0X2RhdGV0aW1lKSk7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIHRhc2tGcm9tS2V5OiBmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGhlIHRhc2sgZm9yIGEgZ2l2ZW4ga2V5LlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS50YXNrc1trZXldO1xuICAgICAgfSxcbiAgICAgIGtleUZyb21UYXNrOiBmdW5jdGlvbih0YXNrKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZXR1cm5zIHRoZSBrZXkgZm9yIGEgZ2l2ZW4gdGFzay5cbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiB0YXNrLnN0ZXBfc2x1ZztcbiAgICAgIH0sXG4gICAgICBhd2FpdGluZ0Fzc2lnbm1lbnQ6IGZ1bmN0aW9uKHRhc2spIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIERldGVybWluZXMgd2hldGhlciB0YXNrIGNhbiBiZSBnaXZlbiBhIG5ldyBhc3NpZ25tZW50LlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHN0YXR1c2VzID0gWydBd2FpdGluZyBQcm9jZXNzaW5nJywgJ1BlbmRpbmcgUmV2aWV3J107XG4gICAgICAgIHJldHVybiBzdGF0dXNlcy5pbmRleE9mKHRhc2suc3RhdHVzKSA+PSAwO1xuICAgICAgfSxcbiAgICAgIGluUHJvZ3Jlc3NBc3NpZ25tZW50OiBmdW5jdGlvbih0YXNrKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGFzayBoYXMgYSBjdXJyZW50bHktcHJvY2Vzc2luZyBhc3NpZ25tZW50LlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHN0YXR1c2VzID0gWydQcm9jZXNzaW5nJywgJ1Bvc3QtcmV2aWV3IFByb2Nlc3NpbmcnLCAnUmV2aWV3aW5nJ107XG4gICAgICAgIHJldHVybiBzdGF0dXNlcy5pbmRleE9mKHRhc2suc3RhdHVzKSA+PSAwIHx8IHRoaXMuYXdhaXRpbmdBc3NpZ25tZW50KHRhc2spO1xuICAgICAgfSxcbiAgICAgIHRhc2tNZXRhOiBmdW5jdGlvbih0YXNrS2V5LCBtZXRhS2V5LCB2YWx1ZSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogU3RvcmVzIGFuZCByZWFkcyBrZXllZCB0YXNrIG1ldGFkYXRhLiBTaW5jZSB3ZSB1cGRhdGUgZGF0YSBmcm9tIHRoZVxuICAgICAgICAgKiBzZXJ2ZXIsIHdlIHN0b3JlIHRhc2sgdmlzdWFsaXphdGlvbiBkYXRhIHNlcGFyYXRlbHkgc28gaXQncyBub3RcbiAgICAgICAgICogb3ZlcndyaXR0ZW4uXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgdGFza01ldGEgPSBfbWV0YS50YXNrc1t0YXNrS2V5XSB8fCB7fTtcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0YXNrTWV0YVttZXRhS2V5XSA9IHZhbHVlO1xuICAgICAgICAgIF9tZXRhLnRhc2tzW3Rhc2tLZXldID0gdGFza01ldGE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRhc2tNZXRhW21ldGFLZXldO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgdGFza0VuZDogZnVuY3Rpb24odGFzaykge1xuICAgICAgICAvKipcbiAgICAgICAgICogQ2FsY3VsYXRlcyB0aGUgZW5kIHRpbWUgZm9yIGEgZ2l2ZW4gdGFzay5cbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLmF3YWl0aW5nQXNzaWdubWVudCh0YXNrKSkge1xuICAgICAgICAgIHJldHVybiBfbm93LnRvU3RyaW5nKCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHRhc2tFbmQgPSB0YXNrLnN0YXJ0X2RhdGV0aW1lO1xuICAgICAgICB0YXNrLmFzc2lnbm1lbnRzLmZvckVhY2goZnVuY3Rpb24oYXNzaWdubWVudCkge1xuICAgICAgICAgIGlmIChhc3NpZ25tZW50Lml0ZXJhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgbGFzdEl0ZXJhdGlvbiA9IGFzc2lnbm1lbnQuaXRlcmF0aW9uc1thc3NpZ25tZW50Lml0ZXJhdGlvbnMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBpZiAobmV3IERhdGUobGFzdEl0ZXJhdGlvbi5lbmRfZGF0ZXRpbWUpID4gbmV3IERhdGUodGFza0VuZCkpIHtcbiAgICAgICAgICAgICAgdGFza0VuZCA9IGxhc3RJdGVyYXRpb24uZW5kX2RhdGV0aW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0YXNrRW5kO1xuICAgICAgfSxcblxuICAgICAgYXNzaWdubWVudEZyb21LZXk6IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0dXJucyB0aGUgYXNzaWdubWVudCBmb3IgYSBnaXZlbiBrZXkuXG4gICAgICAgICAqL1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrRnJvbUtleShrZXkudGFza0tleSlcbiAgICAgICAgICAuYXNzaWdubWVudHNba2V5LmFzc2lnbm1lbnRJbmRleF07XG4gICAgICB9LFxuICAgICAga2V5RnJvbUFzc2lnbm1lbnQ6IGZ1bmN0aW9uKGFzc2lnbm1lbnQpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGhlIGtleSBmb3IgYSBnaXZlbiBhc3NpZ25tZW50LlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIGRhdGFTZXJ2aWNlID0gdGhpcztcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAndGFza0tleSc6IGRhdGFTZXJ2aWNlLmtleUZyb21UYXNrKGFzc2lnbm1lbnQudGFzayksXG4gICAgICAgICAgJ2Fzc2lnbm1lbnRJbmRleCc6IGRhdGFTZXJ2aWNlLmluZGV4RnJvbUFzc2lnbm1lbnQoYXNzaWdubWVudClcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgICBpbmRleEZyb21Bc3NpZ25tZW50OiBmdW5jdGlvbihhc3NpZ25tZW50KSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZXR1cm5zIHRoZSBhc3NpZ25tZW50IGNvdW50ZXIgZm9yIGEgZ2l2ZW4gYXNzaWdubWVudC5cbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiBhc3NpZ25tZW50LnRhc2suYXNzaWdubWVudHMuaW5kZXhPZihhc3NpZ25tZW50KTtcbiAgICAgIH0sXG5cbiAgICAgIGl0ZXJhdGlvbkZyb21LZXk6IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0dXJucyB0aGUgaXRlcmF0aW9uIGZvciB0aGUgZ2l2ZW4ga2V5LlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIHRoaXMuYXNzaWdubWVudEZyb21LZXkoa2V5LmFzc2lnbm1lbnRLZXkpLml0ZXJhdGlvbnNba2V5Lml0ZXJhdGlvbkluZGV4XTtcbiAgICAgIH0sXG4gICAgICBrZXlGcm9tSXRlcmF0aW9uOiBmdW5jdGlvbihpdGVyYXRpb24pIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGhlIGtleSBmb3IgYSBnaXZlbiBpdGVyYXRpb24uXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgZGF0YVNlcnZpY2UgPSB0aGlzO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICdhc3NpZ25tZW50S2V5JzogZGF0YVNlcnZpY2Uua2V5RnJvbUFzc2lnbm1lbnQoaXRlcmF0aW9uLmFzc2lnbm1lbnQpLFxuICAgICAgICAgICdpdGVyYXRpb25JbmRleCc6IGl0ZXJhdGlvbi5hc3NpZ25tZW50Lml0ZXJhdGlvbnMuaW5kZXhPZihpdGVyYXRpb24pXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfTtcbiAgfSk7XG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

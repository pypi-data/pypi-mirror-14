!function(){"use strict";var serviceModule=angular.module("orchestra.project_management.services");serviceModule.factory("tasksVis",["$modal","dataService","orchestraApi","visUtils","assignmentsVis","crosshair","axis",function($modal,dataService,orchestraApi,visUtils,assignmentsVis,crosshair,axis){var _humanizeAudit=function(audit){var humanAudit={step:audit.task.step_slug,change:audit.change,assignments:{}};return audit.assignments.forEach(function(assignmentAudit){humanAudit.assignments[assignmentAudit.assignment.worker.username]={change:assignmentAudit.change,snapshots:assignmentAudit.snapshots}}),humanAudit},_hasOneClassFrom=function(target,classes){for(var cls,i=0;i<classes.length&&!(cls=target.classed(classes[i]));i++);return cls};return{reverting:!1,draw:function(){var tasksVis=this,taskViews=visUtils.parentContainer.selectAll(".task-view").data(dataService.timeSortedSlugs,function(slug){return slug});taskViews.exit().remove();var taskViewsEnter=taskViews.enter().append("div").attr("class","task-view"),taskSvgsEnter=taskViewsEnter.append("svg").attr("class","task-svg").style("margin-left",visUtils.params.marginLeft+"px");taskViews.selectAll(".task-svg").attr("width",visUtils.getSvgWidth()),taskViews.style("width",visUtils.getSvgWidth()+visUtils.params.marginLeft+"px");var tasksEnter=taskSvgsEnter.append("g").attr("class","task");taskViews.selectAll(".task").transition().attr({transform:function(taskKey){var task=dataService.taskFromKey(taskKey);return visUtils.translateString(axis.getOffset(task.start_datetime),visUtils.params.lanePadding.top)}}),tasksVis.drawRevertFlags(),assignmentsVis.draw();tasksEnter.append("rect").attr({"class":"task-rect",height:visUtils.params.barHeight,"fill-opacity":0,stroke:"black"});taskViews.selectAll(".task-rect").transition().attr("width",function(slug){var task=dataService.taskFromKey(slug);return axis.getOffset(dataService.taskEnd(task))-axis.getOffset(task.start_datetime)}).each(function(slug){dataService.taskFromKey(slug);tasksVis.expand(d3.select(tasksVis.parentNode))}),taskViews.on("click",function(taskKey){var task=dataService.taskFromKey(taskKey),target=d3.select(d3.event.target),classes=["task-view","task-svg","task-rect"];if(_hasOneClassFrom(target,classes)){task=dataService.taskFromKey(taskKey);var expandAssignments=dataService.taskMeta(taskKey,"expandAssignments");dataService.taskMeta(taskKey,"expandAssignments",!expandAssignments),tasksVis.distribute()}}),this.drawMeta(),this.drawBackgrounds(),tasksVis.distribute()},drawMeta:function(){var tasksVis=this,taskNames=d3.select(".task-names").selectAll(".task-name").data(dataService.timeSortedSlugs,function(slug){return slug});taskNames.exit().remove();var taskNamesEnter=taskNames.enter().append("div").attr("class","task-name");taskNamesEnter.append("span").attr("class","step-slug");var taskActionWrappers=taskNamesEnter.append("div").attr("class","task-action-wrapper"),actions=taskNames.selectAll(".task-action-wrapper").selectAll(".skip-task").data(function(taskKey){return"Complete"!=dataService.taskFromKey(taskKey).status?[taskKey]:[]});actions.exit().remove(),actions.enter().append("button").attr("class","skip-task task-action btn btn-danger btn-xs").text("Skip task").on("click",function(taskKey){tasksVis.completeAndSkipTask(dataService.taskFromKey(taskKey))}),taskActionWrappers.append("a").attr({href:function(taskKey){return dataService.taskFromKey(taskKey).admin_url},target:"_blank","class":"task-action"}).append("button").attr("class","btn btn-default btn-xs").text("View in admin"),taskNamesEnter.append("span").attr("class","step-status"),taskNames.selectAll(".step-slug").text(function(slug){var task=dataService.taskFromKey(slug);return task.step_slug}),taskNames.selectAll(".step-status").text(function(slug){var task=dataService.taskFromKey(slug);return task.status})},drawBackgrounds:function(){d3.selectAll(".task-name").style("background-color",function(slug,i,j){return i%2===0?"#eee":"white"}),visUtils.parentContainer.selectAll(".task-view").style("background-color",function(slug,i){return i%2===0?"#eee":"white"})},drawRevertFlags:function(){var tasksVis=this,tasks=visUtils.parentContainer.selectAll(".task"),revertGroups=tasks.selectAll(".revert-group").data(function(slug){var task=dataService.taskFromKey(slug),datetimes=[];return task.assignments.forEach(function(assignment){assignment.iterations&&assignment.iterations.forEach(function(iteration){datetimes.push({datetime:new Date(iteration.start_datetime),taskKey:task.step_slug})})}),dataService.inProgressAssignment(task)||datetimes.push({datetime:new Date(dataService.taskEnd(task)),taskKey:task.step_slug}),datetimes},function(datetime){return datetime.datetime});revertGroups.exit().remove();var revertGroupsEnter=revertGroups.enter().append("g").attr("class","revert-group");revertGroupsEnter.append("line").attr({"class":"revert-line",stroke:"rgb(0, 121, 191)"}),revertGroupsEnter.append("path").attr({d:"M0,0 V4 L-2,2 Z",fill:"rgb(0, 121, 191)",transform:visUtils.translateString(0,-visUtils.params.lanePadding.top/2)+" scale(3, 3)"}).style("cursor","pointer").on("mouseenter",function(datetimeInfo){tasksVis.reverting||(crosshair.move(datetimeInfo.datetime),crosshair.show())}).on("mouseleave",function(datetimeInfo){tasksVis.reverting||crosshair.hide()}).on("click",function(datetimeInfo){var taskId=dataService.taskFromKey(datetimeInfo.taskKey).id;tasksVis.revertTask(taskId,datetimeInfo.datetime)}),revertGroups.transition().attr({transform:function(datetimeInfo){var taskStartDatetime=dataService.taskFromKey(datetimeInfo.taskKey).start_datetime;return visUtils.translateString(axis.timeScale(datetimeInfo.datetime)-axis.getOffset(taskStartDatetime),0)}}),revertGroups.selectAll(".revert-line").transition().attr({y1:-visUtils.params.lanePadding.top/2,y2:function(datetimeInfo){var taskKey=datetimeInfo.taskKey,task=dataService.taskFromKey(taskKey);return dataService.taskMeta(taskKey,"expandAssignments")?(task.assignments.length+1)*visUtils.params.barHeight+1:visUtils.params.barHeight+1}})},expand:function(){var taskViews=d3.selectAll(".task-view");taskViews.selectAll(".assignments").transition().attr("transform",function(taskKey){var expand=dataService.taskMeta(taskKey,"expandAssignments");visUtils.translateString(0,expand?visUtils.params.barHeight:0)}),taskViews.selectAll(".assignment").transition().attr({transform:function(assignmentKey,i){var assignment=dataService.assignmentFromKey(assignmentKey),taskKey=dataService.keyFromTask(assignment.task),expand=dataService.taskMeta(taskKey,"expandAssignments");return visUtils.translateString(0,expand?visUtils.params.barHeight*(i+1):0)}}),taskViews.selectAll(".assignment-meta").transition().style({position:"absolute",top:function(assignmentKey,i){var assignment=dataService.assignmentFromKey(assignmentKey),taskKey=dataService.keyFromTask(assignment.task),expand=dataService.taskMeta(taskKey,"expandAssignments");return expand?visUtils.params.barHeight*(i+1)+visUtils.params.lanePadding.top+4+"px":visUtils.params.lanePadding.top+"px"},right:function(assignmentKey){var assignment=dataService.assignmentFromKey(assignmentKey);return visUtils.getSvgWidth()-axis.getOffset(assignment.task.start_datetime)+10+"px"},display:function(assignmentKey,i){var assignment=dataService.assignmentFromKey(assignmentKey),taskKey=dataService.keyFromTask(assignment.task),expand=dataService.taskMeta(taskKey,"expandAssignments");return expand?"inherit":"none"}}),taskViews.selectAll(".active-assignment").attr("display",function(assignmentKey){var assignment=dataService.assignmentFromKey(assignmentKey),taskKey=dataService.keyFromTask(assignment.task),expand=dataService.taskMeta(taskKey,"expandAssignments");return expand?"inherit":"none"})},distribute:function(){visUtils.parentContainer.selectAll(".task-svg").transition().attr({height:function(taskKey){var task=dataService.taskFromKey(taskKey);return visUtils.getTaskHeight(task)}});var taskNamesWrapper=d3.selectAll(".task-names").style("margin-top",visUtils.params.scaleHeight+"px");taskNamesWrapper.selectAll(".task-name").transition().style({height:function(slug,i){var task=dataService.taskFromKey(slug);return visUtils.getTaskHeight(task)+"px"},"padding-top":visUtils.params.lanePadding.top/2+"px"});this.drawRevertFlags(),this.expand()},completeAndSkipTask:function(task){confirm("Are you sure you want to skip this task and mark it as complete? This might leave the project in a corrupted/unrecoverable state.")&&orchestraApi.completeAndSkipTask(task).then(function(){dataService.updateData()},function(response){var errorMessage="Error skipping task.";400===response.status&&(errorMessage=response.data.message),alert(errorMessage)})},revertTask:function(taskId,datetime){var tasksVis=this;tasksVis.reverting||(tasksVis.reverting=!0,orchestraApi.revertTask(taskId,datetime,!0).then(function(response){var modalInstance=$modal.open({templateUrl:"/static/orchestra/project_management/partials/revert_modal.html",controller:["$scope",function($scope){$scope.audit=_humanizeAudit(response.data),$scope.cancel=modalInstance.close,$scope.confirmRevert=function(){orchestraApi.revertTask(taskId,datetime,!1).then(function(){dataService.updateData()},function(response){var errorMessage="Could not revert task.";400===response.status&&(errorMessage=response.data.message),alert(errorMessage)})["finally"](function(){modalInstance.close()})}}]});modalInstance.result["finally"](function(){tasksVis.reverting=!1,crosshair.hide()})},function(response){var errorMessage="Could not generate revert information.";400===response.status&&(errorMessage=response.data.message),alert(errorMessage)}))}}}])}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYS9wcm9qZWN0X21hbmFnZW1lbnQvanMvdGFza3NWaXMuanMiXSwibmFtZXMiOlsic2VydmljZU1vZHVsZSIsImFuZ3VsYXIiLCJtb2R1bGUiLCJmYWN0b3J5IiwiJG1vZGFsIiwiZGF0YVNlcnZpY2UiLCJvcmNoZXN0cmFBcGkiLCJ2aXNVdGlscyIsImFzc2lnbm1lbnRzVmlzIiwiY3Jvc3NoYWlyIiwiYXhpcyIsIl9odW1hbml6ZUF1ZGl0IiwiYXVkaXQiLCJodW1hbkF1ZGl0Iiwic3RlcCIsInRhc2siLCJzdGVwX3NsdWciLCJjaGFuZ2UiLCJhc3NpZ25tZW50cyIsImZvckVhY2giLCJhc3NpZ25tZW50QXVkaXQiLCJhc3NpZ25tZW50Iiwid29ya2VyIiwidXNlcm5hbWUiLCJzbmFwc2hvdHMiLCJfaGFzT25lQ2xhc3NGcm9tIiwidGFyZ2V0IiwiY2xhc3NlcyIsImNscyIsImkiLCJsZW5ndGgiLCJjbGFzc2VkIiwicmV2ZXJ0aW5nIiwiZHJhdyIsInRhc2tzVmlzIiwidGhpcyIsInRhc2tWaWV3cyIsInBhcmVudENvbnRhaW5lciIsInNlbGVjdEFsbCIsImRhdGEiLCJ0aW1lU29ydGVkU2x1Z3MiLCJzbHVnIiwiZXhpdCIsInJlbW92ZSIsInRhc2tWaWV3c0VudGVyIiwiZW50ZXIiLCJhcHBlbmQiLCJhdHRyIiwidGFza1N2Z3NFbnRlciIsInN0eWxlIiwicGFyYW1zIiwibWFyZ2luTGVmdCIsImdldFN2Z1dpZHRoIiwidGFza3NFbnRlciIsInRyYW5zaXRpb24iLCJ0cmFuc2Zvcm0iLCJ0YXNrS2V5IiwidGFza0Zyb21LZXkiLCJ0cmFuc2xhdGVTdHJpbmciLCJnZXRPZmZzZXQiLCJzdGFydF9kYXRldGltZSIsImxhbmVQYWRkaW5nIiwidG9wIiwiZHJhd1JldmVydEZsYWdzIiwiY2xhc3MiLCJoZWlnaHQiLCJiYXJIZWlnaHQiLCJmaWxsLW9wYWNpdHkiLCJzdHJva2UiLCJ0YXNrRW5kIiwiZWFjaCIsImV4cGFuZCIsImQzIiwic2VsZWN0IiwicGFyZW50Tm9kZSIsIm9uIiwiZXZlbnQiLCJleHBhbmRBc3NpZ25tZW50cyIsInRhc2tNZXRhIiwiZGlzdHJpYnV0ZSIsImRyYXdNZXRhIiwiZHJhd0JhY2tncm91bmRzIiwidGFza05hbWVzIiwidGFza05hbWVzRW50ZXIiLCJ0YXNrQWN0aW9uV3JhcHBlcnMiLCJhY3Rpb25zIiwic3RhdHVzIiwidGV4dCIsImNvbXBsZXRlQW5kU2tpcFRhc2siLCJocmVmIiwiYWRtaW5fdXJsIiwiaiIsInRhc2tzIiwicmV2ZXJ0R3JvdXBzIiwiZGF0ZXRpbWVzIiwiaXRlcmF0aW9ucyIsIml0ZXJhdGlvbiIsInB1c2giLCJkYXRldGltZSIsIkRhdGUiLCJpblByb2dyZXNzQXNzaWdubWVudCIsInJldmVydEdyb3Vwc0VudGVyIiwiZCIsImZpbGwiLCJkYXRldGltZUluZm8iLCJtb3ZlIiwic2hvdyIsImhpZGUiLCJ0YXNrSWQiLCJpZCIsInJldmVydFRhc2siLCJ0YXNrU3RhcnREYXRldGltZSIsInRpbWVTY2FsZSIsInkxIiwieTIiLCJhc3NpZ25tZW50S2V5IiwiYXNzaWdubWVudEZyb21LZXkiLCJrZXlGcm9tVGFzayIsInBvc2l0aW9uIiwicmlnaHQiLCJkaXNwbGF5IiwiZ2V0VGFza0hlaWdodCIsInRhc2tOYW1lc1dyYXBwZXIiLCJzY2FsZUhlaWdodCIsInBhZGRpbmctdG9wIiwiY29uZmlybSIsInRoZW4iLCJ1cGRhdGVEYXRhIiwicmVzcG9uc2UiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwiYWxlcnQiLCJtb2RhbEluc3RhbmNlIiwib3BlbiIsInRlbXBsYXRlVXJsIiwiY29udHJvbGxlciIsIiRzY29wZSIsImNhbmNlbCIsImNsb3NlIiwiY29uZmlybVJldmVydCIsInJlc3VsdCJdLCJtYXBwaW5ncyI6IkNBQUEsV0FDRSxZQUVBLElBQUlBLGVBQWdCQyxRQUFRQyxPQUFPLHdDQUVuQ0YsZUFBY0csUUFBUSxZQUFBLFNBQUEsY0FBQSxlQUFBLFdBQUEsaUJBQUEsWUFBQSxPQUFZLFNB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cEJELFNBQVMxQyxTQUNYMkMsYUFBZUQsU0FBU3pGLEtBQUsyRixTQUUvQkMsTUFBTUYiLCJmaWxlIjoib3JjaGVzdHJhL3Byb2plY3RfbWFuYWdlbWVudC9qcy90YXNrc1Zpcy5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICB2YXIgc2VydmljZU1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKCdvcmNoZXN0cmEucHJvamVjdF9tYW5hZ2VtZW50LnNlcnZpY2VzJyk7XG5cbiAgc2VydmljZU1vZHVsZS5mYWN0b3J5KCd0YXNrc1ZpcycsIGZ1bmN0aW9uKCRtb2RhbCwgZGF0YVNlcnZpY2UsIG9yY2hlc3RyYUFwaSxcbiAgICB2aXNVdGlscywgYXNzaWdubWVudHNWaXMsIGNyb3NzaGFpciwgYXhpcykge1xuICAgIC8qKlxuICAgICAqIFNlcnZpY2UgdG8gbW9kdWxhcml6ZSB0YXNrIHZpc3VhbGl6YXRpb24gYW5kIG1hbmlwdWxhdGlvbiB3aXRoaW5cbiAgICAgKiB0aGUgcHJvamVjdCBtYW5hZ2VtZW50IHZpZXcuXG4gICAgICovXG4gICAgdmFyIHRhc2tzVmlzO1xuXG4gICAgdmFyIF9odW1hbml6ZUF1ZGl0ID0gZnVuY3Rpb24oYXVkaXQpIHtcbiAgICAgIC8qKlxuICAgICAgICogU2VsZWN0aXZlbHkgcmVuZGVyIGEgcmV2ZXJ0IGF1ZGl0IGluIGEgaHVtYW4tcmVhZGFibGUgd2F5LlxuICAgICAgICovXG4gICAgICB2YXIgaHVtYW5BdWRpdCA9IHtcbiAgICAgICAgJ3N0ZXAnOiBhdWRpdC50YXNrLnN0ZXBfc2x1ZyxcbiAgICAgICAgJ2NoYW5nZSc6IGF1ZGl0LmNoYW5nZSxcbiAgICAgICAgJ2Fzc2lnbm1lbnRzJzoge30sXG4gICAgICB9O1xuICAgICAgYXVkaXQuYXNzaWdubWVudHMuZm9yRWFjaChmdW5jdGlvbihhc3NpZ25tZW50QXVkaXQpIHtcbiAgICAgICAgaHVtYW5BdWRpdC5hc3NpZ25tZW50c1thc3NpZ25tZW50QXVkaXQuYXNzaWdubWVudC53b3JrZXIudXNlcm5hbWVdID0ge1xuICAgICAgICAgICdjaGFuZ2UnOiBhc3NpZ25tZW50QXVkaXQuY2hhbmdlLFxuICAgICAgICAgICdzbmFwc2hvdHMnOiBhc3NpZ25tZW50QXVkaXQuc25hcHNob3RzXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBodW1hbkF1ZGl0O1xuICAgIH07XG5cbiAgICB2YXIgX2hhc09uZUNsYXNzRnJvbSA9IGZ1bmN0aW9uKHRhcmdldCwgY2xhc3Nlcykge1xuICAgICAgLyoqXG4gICAgICAgKiBEZXRlcm1pbmUgaWYgYSBkMyBzZWxlY3Rpb24gaGFzIGF0IGxlYXN0IG9uZSBjbGFzcyBmcm9tIGEgZ2l2ZW4gbGlzdC5cbiAgICAgICAqL1xuICAgICAgdmFyIGNscztcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjbHMgPSB0YXJnZXQuY2xhc3NlZChjbGFzc2VzW2ldKTtcbiAgICAgICAgaWYgKGNscykge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gY2xzO1xuICAgIH07XG5cblxuICAgIHJldHVybiB7XG4gICAgICByZXZlcnRpbmc6IGZhbHNlLFxuICAgICAgZHJhdzogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEcmF3cy91cGRhdGVzIHRhc2tzIHdpdGhpbiBwcm9qZWN0IG1hbmFnZW1lbnQgdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrc1ZpcyA9IHRoaXM7XG4gICAgICAgIHZhciB0YXNrVmlld3MgPSB2aXNVdGlscy5wYXJlbnRDb250YWluZXIuc2VsZWN0QWxsKCcudGFzay12aWV3JylcbiAgICAgICAgICAuZGF0YShkYXRhU2VydmljZS50aW1lU29ydGVkU2x1Z3MsIGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICAgIHJldHVybiBzbHVnO1xuICAgICAgICAgIH0pO1xuICAgICAgICB0YXNrVmlld3MuZXhpdCgpLnJlbW92ZSgpO1xuICAgICAgICB2YXIgdGFza1ZpZXdzRW50ZXIgPSB0YXNrVmlld3MuZW50ZXIoKS5hcHBlbmQoJ2RpdicpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3Rhc2stdmlldycpO1xuXG4gICAgICAgIHZhciB0YXNrU3Znc0VudGVyID0gdGFza1ZpZXdzRW50ZXIuYXBwZW5kKCdzdmcnKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICd0YXNrLXN2ZycpXG4gICAgICAgICAgLnN0eWxlKCdtYXJnaW4tbGVmdCcsIHZpc1V0aWxzLnBhcmFtcy5tYXJnaW5MZWZ0ICsgJ3B4Jyk7XG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLnRhc2stc3ZnJykuYXR0cignd2lkdGgnLCB2aXNVdGlscy5nZXRTdmdXaWR0aCgpKTtcbiAgICAgICAgdGFza1ZpZXdzLnN0eWxlKCd3aWR0aCcsIHZpc1V0aWxzLmdldFN2Z1dpZHRoKCkgKyB2aXNVdGlscy5wYXJhbXMubWFyZ2luTGVmdCArICdweCcpO1xuXG4gICAgICAgIHZhciB0YXNrc0VudGVyID0gdGFza1N2Z3NFbnRlci5hcHBlbmQoJ2cnKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICd0YXNrJyk7XG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLnRhc2snKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuYXR0cih7XG4gICAgICAgICAgICAndHJhbnNmb3JtJzogZnVuY3Rpb24odGFza0tleSkge1xuICAgICAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpO1xuICAgICAgICAgICAgICByZXR1cm4gdmlzVXRpbHMudHJhbnNsYXRlU3RyaW5nKGF4aXMuZ2V0T2Zmc2V0KHRhc2suc3RhcnRfZGF0ZXRpbWUpLCB2aXNVdGlscy5wYXJhbXMubGFuZVBhZGRpbmcudG9wKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza3NWaXMuZHJhd1JldmVydEZsYWdzKCk7XG5cbiAgICAgICAgYXNzaWdubWVudHNWaXMuZHJhdygpO1xuXG4gICAgICAgIHZhciB0YXNrUmVjdCA9IHRhc2tzRW50ZXIuYXBwZW5kKCdyZWN0JylcbiAgICAgICAgICAuYXR0cih7XG4gICAgICAgICAgICAnY2xhc3MnOiAndGFzay1yZWN0JyxcbiAgICAgICAgICAgICdoZWlnaHQnOiB2aXNVdGlscy5wYXJhbXMuYmFySGVpZ2h0LFxuICAgICAgICAgICAgJ2ZpbGwtb3BhY2l0eSc6IDAsXG4gICAgICAgICAgICAnc3Ryb2tlJzogJ2JsYWNrJyxcbiAgICAgICAgICB9KTtcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcudGFzay1yZWN0JylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoJ3dpZHRoJywgZnVuY3Rpb24oc2x1Zykge1xuICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICAgIHJldHVybiBheGlzLmdldE9mZnNldChkYXRhU2VydmljZS50YXNrRW5kKHRhc2spKSAtIGF4aXMuZ2V0T2Zmc2V0KHRhc2suc3RhcnRfZGF0ZXRpbWUpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmVhY2goZnVuY3Rpb24oc2x1Zykge1xuICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICAgIHRhc2tzVmlzLmV4cGFuZChkMy5zZWxlY3QodGFza3NWaXMucGFyZW50Tm9kZSkpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2tWaWV3cy5vbignY2xpY2snLCBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleSh0YXNrS2V5KTtcbiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZDMuc2VsZWN0KGQzLmV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgdmFyIGNsYXNzZXMgPSBbJ3Rhc2stdmlldycsICd0YXNrLXN2ZycsICd0YXNrLXJlY3QnXTtcbiAgICAgICAgICBpZiAoIV9oYXNPbmVDbGFzc0Zyb20odGFyZ2V0LCBjbGFzc2VzKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSk7XG4gICAgICAgICAgdmFyIGV4cGFuZEFzc2lnbm1lbnRzID0gZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJyk7XG4gICAgICAgICAgZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJywgIWV4cGFuZEFzc2lnbm1lbnRzKTtcbiAgICAgICAgICB0YXNrc1Zpcy5kaXN0cmlidXRlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZHJhd01ldGEoKTtcbiAgICAgICAgdGhpcy5kcmF3QmFja2dyb3VuZHMoKTtcbiAgICAgICAgdGFza3NWaXMuZGlzdHJpYnV0ZSgpO1xuICAgICAgfSxcbiAgICAgIGRyYXdNZXRhOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIERyYXdzIHRhc2sgc3RlcCBzbHVncywgc3RhdHVzZXMsIGFuZCBhY3Rpb24gYnV0dG9ucyB0byB0aGUgbGVmdCBvZlxuICAgICAgICAgKiB0aGUgbWFpbiBwcm9qZWN0IG1hbmFnZW1lbnQgdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrc1ZpcyA9IHRoaXM7XG4gICAgICAgIHZhciB0YXNrTmFtZXMgPSBkMy5zZWxlY3QoJy50YXNrLW5hbWVzJykuc2VsZWN0QWxsKCcudGFzay1uYW1lJylcbiAgICAgICAgICAuZGF0YShkYXRhU2VydmljZS50aW1lU29ydGVkU2x1Z3MsIGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICAgIHJldHVybiBzbHVnO1xuICAgICAgICAgIH0pO1xuICAgICAgICB0YXNrTmFtZXMuZXhpdCgpLnJlbW92ZSgpO1xuICAgICAgICB2YXIgdGFza05hbWVzRW50ZXIgPSB0YXNrTmFtZXMuZW50ZXIoKS5hcHBlbmQoJ2RpdicpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3Rhc2stbmFtZScpO1xuICAgICAgICB0YXNrTmFtZXNFbnRlci5hcHBlbmQoJ3NwYW4nKVxuICAgICAgICAgIC5hdHRyKCdjbGFzcycsICdzdGVwLXNsdWcnKTtcbiAgICAgICAgdmFyIHRhc2tBY3Rpb25XcmFwcGVycyA9IHRhc2tOYW1lc0VudGVyLmFwcGVuZCgnZGl2JykuYXR0cignY2xhc3MnLCAndGFzay1hY3Rpb24td3JhcHBlcicpO1xuICAgICAgICB2YXIgYWN0aW9ucyA9IHRhc2tOYW1lcy5zZWxlY3RBbGwoJy50YXNrLWFjdGlvbi13cmFwcGVyJykuc2VsZWN0QWxsKCcuc2tpcC10YXNrJylcbiAgICAgICAgICAuZGF0YShmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkodGFza0tleSkuc3RhdHVzICE9ICdDb21wbGV0ZScgPyBbdGFza0tleV0gOiBbXTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgYWN0aW9ucy5leGl0KCkucmVtb3ZlKCk7XG4gICAgICAgIGFjdGlvbnMuZW50ZXIoKS5hcHBlbmQoJ2J1dHRvbicpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3NraXAtdGFzayB0YXNrLWFjdGlvbiBidG4gYnRuLWRhbmdlciBidG4teHMnKVxuICAgICAgICAgIC50ZXh0KCdTa2lwIHRhc2snKVxuICAgICAgICAgIC5vbignY2xpY2snLCBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICB0YXNrc1Zpcy5jb21wbGV0ZUFuZFNraXBUYXNrKGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgdGFza0FjdGlvbldyYXBwZXJzLmFwcGVuZCgnYScpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2hyZWYnOiBmdW5jdGlvbih0YXNrS2V5KSB7XG4gICAgICAgICAgICAgIHJldHVybiBkYXRhU2VydmljZS50YXNrRnJvbUtleSh0YXNrS2V5KS5hZG1pbl91cmw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3RhcmdldCc6ICdfYmxhbmsnLFxuICAgICAgICAgICAgJ2NsYXNzJzogJ3Rhc2stYWN0aW9uJ1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmFwcGVuZCgnYnV0dG9uJylcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnYnRuIGJ0bi1kZWZhdWx0IGJ0bi14cycpXG4gICAgICAgICAgLnRleHQoJ1ZpZXcgaW4gYWRtaW4nKTtcblxuICAgICAgICB0YXNrTmFtZXNFbnRlci5hcHBlbmQoJ3NwYW4nKS5hdHRyKCdjbGFzcycsICdzdGVwLXN0YXR1cycpO1xuXG4gICAgICAgIHRhc2tOYW1lcy5zZWxlY3RBbGwoJy5zdGVwLXNsdWcnKS50ZXh0KGZ1bmN0aW9uKHNsdWcpIHtcbiAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHNsdWcpO1xuICAgICAgICAgIHJldHVybiB0YXNrLnN0ZXBfc2x1ZztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza05hbWVzLnNlbGVjdEFsbCgnLnN0ZXAtc3RhdHVzJykudGV4dChmdW5jdGlvbihzbHVnKSB7XG4gICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShzbHVnKTtcbiAgICAgICAgICByZXR1cm4gdGFzay5zdGF0dXM7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGRyYXdCYWNrZ3JvdW5kczogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZW5kZXJzIGVhY2ggdGFzayBcInN3aW0gbGFuZVwiIHdpdGggYW4gYWx0ZXJuYXRpbmcgY29sb3IuXG4gICAgICAgICAqL1xuICAgICAgICBkMy5zZWxlY3RBbGwoJy50YXNrLW5hbWUnKVxuICAgICAgICAgIC5zdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIGZ1bmN0aW9uKHNsdWcsIGksIGopIHtcbiAgICAgICAgICAgIHJldHVybiBpICUgMiA9PT0gMCA/ICcjZWVlJyA6ICd3aGl0ZSc7XG4gICAgICAgICAgfSk7XG4gICAgICAgIHZpc1V0aWxzLnBhcmVudENvbnRhaW5lci5zZWxlY3RBbGwoJy50YXNrLXZpZXcnKVxuICAgICAgICAgIC5zdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIGZ1bmN0aW9uKHNsdWcsIGkpIHtcbiAgICAgICAgICAgIHJldHVybiBpICUgMiA9PT0gMCA/ICcjZWVlJyA6ICd3aGl0ZSc7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgZHJhd1JldmVydEZsYWdzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIERyYXdzIHRoZSBmbGFncyBjb3JyZXNwb25kaW5nIHRvIHN1aXRhYmxlIHRhc2sgcmV2ZXJ0IHRpbWVzLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHRhc2tzVmlzID0gdGhpcztcbiAgICAgICAgdmFyIHRhc2tzID0gdmlzVXRpbHMucGFyZW50Q29udGFpbmVyLnNlbGVjdEFsbCgnLnRhc2snKTtcbiAgICAgICAgdmFyIHJldmVydEdyb3VwcyA9IHRhc2tzLnNlbGVjdEFsbCgnLnJldmVydC1ncm91cCcpLmRhdGEoZnVuY3Rpb24oc2x1Zykge1xuICAgICAgICAgIHZhciB0YXNrID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoc2x1Zyk7XG4gICAgICAgICAgdmFyIGRhdGV0aW1lcyA9IFtdO1xuICAgICAgICAgIHRhc2suYXNzaWdubWVudHMuZm9yRWFjaChmdW5jdGlvbihhc3NpZ25tZW50KSB7XG4gICAgICAgICAgICBpZiAoYXNzaWdubWVudC5pdGVyYXRpb25zKSB7XG4gICAgICAgICAgICAgIGFzc2lnbm1lbnQuaXRlcmF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGRhdGV0aW1lcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICdkYXRldGltZSc6IG5ldyBEYXRlKGl0ZXJhdGlvbi5zdGFydF9kYXRldGltZSksXG4gICAgICAgICAgICAgICAgICAndGFza0tleSc6IHRhc2suc3RlcF9zbHVnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGlmICghZGF0YVNlcnZpY2UuaW5Qcm9ncmVzc0Fzc2lnbm1lbnQodGFzaykpIHtcbiAgICAgICAgICAgIGRhdGV0aW1lcy5wdXNoKHtcbiAgICAgICAgICAgICAgJ2RhdGV0aW1lJzogbmV3IERhdGUoZGF0YVNlcnZpY2UudGFza0VuZCh0YXNrKSksXG4gICAgICAgICAgICAgICd0YXNrS2V5JzogdGFzay5zdGVwX3NsdWdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gZGF0ZXRpbWVzO1xuICAgICAgICB9LCBmdW5jdGlvbihkYXRldGltZSkge1xuICAgICAgICAgIHJldHVybiBkYXRldGltZS5kYXRldGltZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldmVydEdyb3Vwcy5leGl0KCkucmVtb3ZlKCk7XG4gICAgICAgIHZhciByZXZlcnRHcm91cHNFbnRlciA9IHJldmVydEdyb3Vwcy5lbnRlcigpLmFwcGVuZCgnZycpXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ3JldmVydC1ncm91cCcpO1xuXG4gICAgICAgIHJldmVydEdyb3Vwc0VudGVyLmFwcGVuZCgnbGluZScpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2NsYXNzJzogJ3JldmVydC1saW5lJyxcbiAgICAgICAgICAgICdzdHJva2UnOiAncmdiKDAsIDEyMSwgMTkxKScsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUmV2ZXJ0IGZsYWdzXG4gICAgICAgIHJldmVydEdyb3Vwc0VudGVyLmFwcGVuZCgncGF0aCcpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2QnOiAnTTAsMCBWNCBMLTIsMiBaJyxcbiAgICAgICAgICAgICdmaWxsJzogJ3JnYigwLCAxMjEsIDE5MSknLFxuICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IHZpc1V0aWxzLnRyYW5zbGF0ZVN0cmluZygwLCAtdmlzVXRpbHMucGFyYW1zLmxhbmVQYWRkaW5nLnRvcCAvIDIpICsgJyBzY2FsZSgzLCAzKScsXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuc3R5bGUoJ2N1cnNvcicsICdwb2ludGVyJylcbiAgICAgICAgICAub24oJ21vdXNlZW50ZXInLCBmdW5jdGlvbihkYXRldGltZUluZm8pIHtcbiAgICAgICAgICAgIGlmICghdGFza3NWaXMucmV2ZXJ0aW5nKSB7XG4gICAgICAgICAgICAgIGNyb3NzaGFpci5tb3ZlKGRhdGV0aW1lSW5mby5kYXRldGltZSk7XG4gICAgICAgICAgICAgIGNyb3NzaGFpci5zaG93KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICAub24oJ21vdXNlbGVhdmUnLCBmdW5jdGlvbihkYXRldGltZUluZm8pIHtcbiAgICAgICAgICAgIGlmICghdGFza3NWaXMucmV2ZXJ0aW5nKSB7XG4gICAgICAgICAgICAgIGNyb3NzaGFpci5oaWRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICAub24oJ2NsaWNrJywgZnVuY3Rpb24oZGF0ZXRpbWVJbmZvKSB7XG4gICAgICAgICAgICB2YXIgdGFza0lkID0gZGF0YVNlcnZpY2UudGFza0Zyb21LZXkoZGF0ZXRpbWVJbmZvLnRhc2tLZXkpLmlkO1xuICAgICAgICAgICAgdGFza3NWaXMucmV2ZXJ0VGFzayh0YXNrSWQsIGRhdGV0aW1lSW5mby5kYXRldGltZSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV2ZXJ0R3JvdXBzLnRyYW5zaXRpb24oKS5hdHRyKHtcbiAgICAgICAgICAndHJhbnNmb3JtJzogZnVuY3Rpb24oZGF0ZXRpbWVJbmZvKSB7XG4gICAgICAgICAgICB2YXIgdGFza1N0YXJ0RGF0ZXRpbWUgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleShkYXRldGltZUluZm8udGFza0tleSkuc3RhcnRfZGF0ZXRpbWU7XG4gICAgICAgICAgICByZXR1cm4gdmlzVXRpbHMudHJhbnNsYXRlU3RyaW5nKFxuICAgICAgICAgICAgICBheGlzLnRpbWVTY2FsZShkYXRldGltZUluZm8uZGF0ZXRpbWUpIC0gYXhpcy5nZXRPZmZzZXQodGFza1N0YXJ0RGF0ZXRpbWUpLCAwXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldmVydEdyb3Vwcy5zZWxlY3RBbGwoJy5yZXZlcnQtbGluZScpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5hdHRyKHtcbiAgICAgICAgICAgICd5MSc6IC12aXNVdGlscy5wYXJhbXMubGFuZVBhZGRpbmcudG9wIC8gMixcbiAgICAgICAgICAgICd5Mic6IGZ1bmN0aW9uKGRhdGV0aW1lSW5mbykge1xuICAgICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGV0aW1lSW5mby50YXNrS2V5O1xuICAgICAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHRhc2tLZXkpO1xuICAgICAgICAgICAgICBpZiAoZGF0YVNlcnZpY2UudGFza01ldGEodGFza0tleSwgJ2V4cGFuZEFzc2lnbm1lbnRzJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKHRhc2suYXNzaWdubWVudHMubGVuZ3RoICsgMSkgKiB2aXNVdGlscy5wYXJhbXMuYmFySGVpZ2h0ICsgMTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCArIDE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgZXhwYW5kOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRvZ2dsZXMgZXhwYW5zaW9uIG9mIHNlbGVjdGVkIHRhc2tzIHRvIHNob3cgbW9yZSBkZXRhaWxlZCBhc3NpZ25tZW50XG4gICAgICAgICAqIGRhdGEgYW5kIGFjdGlvbnMuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgdGFza1ZpZXdzID0gZDMuc2VsZWN0QWxsKCcudGFzay12aWV3Jyk7XG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLmFzc2lnbm1lbnRzJylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoJ3RyYW5zZm9ybScsIGZ1bmN0aW9uKHRhc2tLZXkpIHtcbiAgICAgICAgICAgIHZhciBleHBhbmQgPSBkYXRhU2VydmljZS50YXNrTWV0YSh0YXNrS2V5LCAnZXhwYW5kQXNzaWdubWVudHMnKTtcbiAgICAgICAgICAgIHZpc1V0aWxzLnRyYW5zbGF0ZVN0cmluZygwLCBleHBhbmQgPyB2aXNVdGlscy5wYXJhbXMuYmFySGVpZ2h0IDogMCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGFza1ZpZXdzLnNlbGVjdEFsbCgnLmFzc2lnbm1lbnQnKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuYXR0cih7XG4gICAgICAgICAgICAndHJhbnNmb3JtJzogZnVuY3Rpb24oYXNzaWdubWVudEtleSwgaSkge1xuICAgICAgICAgICAgICB2YXIgYXNzaWdubWVudCA9IGRhdGFTZXJ2aWNlLmFzc2lnbm1lbnRGcm9tS2V5KGFzc2lnbm1lbnRLZXkpO1xuICAgICAgICAgICAgICB2YXIgdGFza0tleSA9IGRhdGFTZXJ2aWNlLmtleUZyb21UYXNrKGFzc2lnbm1lbnQudGFzayk7XG4gICAgICAgICAgICAgIHZhciBleHBhbmQgPSBkYXRhU2VydmljZS50YXNrTWV0YSh0YXNrS2V5LCAnZXhwYW5kQXNzaWdubWVudHMnKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnRyYW5zbGF0ZVN0cmluZygwLCBleHBhbmQgPyAodmlzVXRpbHMucGFyYW1zLmJhckhlaWdodCAqIChpICsgMSkpIDogMCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRhc2tWaWV3cy5zZWxlY3RBbGwoJy5hc3NpZ25tZW50LW1ldGEnKVxuICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAuc3R5bGUoe1xuICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJyxcbiAgICAgICAgICAgICd0b3AnOiBmdW5jdGlvbihhc3NpZ25tZW50S2V5LCBpKSB7XG4gICAgICAgICAgICAgIHZhciBhc3NpZ25tZW50ID0gZGF0YVNlcnZpY2UuYXNzaWdubWVudEZyb21LZXkoYXNzaWdubWVudEtleSk7XG4gICAgICAgICAgICAgIHZhciB0YXNrS2V5ID0gZGF0YVNlcnZpY2Uua2V5RnJvbVRhc2soYXNzaWdubWVudC50YXNrKTtcbiAgICAgICAgICAgICAgdmFyIGV4cGFuZCA9IGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycpO1xuICAgICAgICAgICAgICBpZiAoZXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICh2aXNVdGlscy5wYXJhbXMuYmFySGVpZ2h0ICogKGkgKyAxKSArIHZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3AgKyA0KSArICdweCc7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLnBhcmFtcy5sYW5lUGFkZGluZy50b3AgKyAncHgnO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdyaWdodCc6IGZ1bmN0aW9uKGFzc2lnbm1lbnRLZXkpIHtcbiAgICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBkYXRhU2VydmljZS5hc3NpZ25tZW50RnJvbUtleShhc3NpZ25tZW50S2V5KTtcbiAgICAgICAgICAgICAgcmV0dXJuICh2aXNVdGlscy5nZXRTdmdXaWR0aCgpIC0gYXhpcy5nZXRPZmZzZXQoYXNzaWdubWVudC50YXNrLnN0YXJ0X2RhdGV0aW1lKSArIDEwKSArICdweCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2Rpc3BsYXknOiBmdW5jdGlvbihhc3NpZ25tZW50S2V5LCBpKSB7XG4gICAgICAgICAgICAgIHZhciBhc3NpZ25tZW50ID0gZGF0YVNlcnZpY2UuYXNzaWdubWVudEZyb21LZXkoYXNzaWdubWVudEtleSk7XG4gICAgICAgICAgICAgIHZhciB0YXNrS2V5ID0gZGF0YVNlcnZpY2Uua2V5RnJvbVRhc2soYXNzaWdubWVudC50YXNrKTtcbiAgICAgICAgICAgICAgdmFyIGV4cGFuZCA9IGRhdGFTZXJ2aWNlLnRhc2tNZXRhKHRhc2tLZXksICdleHBhbmRBc3NpZ25tZW50cycpO1xuICAgICAgICAgICAgICByZXR1cm4gZXhwYW5kID8gJ2luaGVyaXQnIDogJ25vbmUnO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICB0YXNrVmlld3Muc2VsZWN0QWxsKCcuYWN0aXZlLWFzc2lnbm1lbnQnKVxuICAgICAgICAgIC5hdHRyKCdkaXNwbGF5JywgZnVuY3Rpb24oYXNzaWdubWVudEtleSkge1xuICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBkYXRhU2VydmljZS5hc3NpZ25tZW50RnJvbUtleShhc3NpZ25tZW50S2V5KTtcbiAgICAgICAgICAgIHZhciB0YXNrS2V5ID0gZGF0YVNlcnZpY2Uua2V5RnJvbVRhc2soYXNzaWdubWVudC50YXNrKTtcbiAgICAgICAgICAgIHZhciBleHBhbmQgPSBkYXRhU2VydmljZS50YXNrTWV0YSh0YXNrS2V5LCAnZXhwYW5kQXNzaWdubWVudHMnKTtcbiAgICAgICAgICAgIHJldHVybiBleHBhbmQgPyAnaW5oZXJpdCcgOiAnbm9uZSc7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgZGlzdHJpYnV0ZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBWZXJ0aWNhbGx5IGRpc3RyaWJ1dGUgdGFzayB2aXN1YWxpemF0aW9ucyBpbnNpZGUgdGhlaXIgY29udGFpbmVyLlxuICAgICAgICAgKi9cbiAgICAgICAgdmlzVXRpbHMucGFyZW50Q29udGFpbmVyLnNlbGVjdEFsbCgnLnRhc2stc3ZnJylcbiAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgLmF0dHIoe1xuICAgICAgICAgICAgJ2hlaWdodCc6IGZ1bmN0aW9uKHRhc2tLZXkpIHtcbiAgICAgICAgICAgICAgdmFyIHRhc2sgPSBkYXRhU2VydmljZS50YXNrRnJvbUtleSh0YXNrS2V5KTtcbiAgICAgICAgICAgICAgcmV0dXJuIHZpc1V0aWxzLmdldFRhc2tIZWlnaHQodGFzayk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHZhciB0YXNrTmFtZXNXcmFwcGVyID0gZDMuc2VsZWN0QWxsKCcudGFzay1uYW1lcycpLnN0eWxlKCdtYXJnaW4tdG9wJywgdmlzVXRpbHMucGFyYW1zLnNjYWxlSGVpZ2h0ICsgJ3B4Jyk7XG4gICAgICAgIHZhciB0YXNrTmFtZXMgPSB0YXNrTmFtZXNXcmFwcGVyLnNlbGVjdEFsbCgnLnRhc2stbmFtZScpXG4gICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgIC5zdHlsZSh7XG4gICAgICAgICAgICAnaGVpZ2h0JzogZnVuY3Rpb24oc2x1ZywgaSkge1xuICAgICAgICAgICAgICB2YXIgdGFzayA9IGRhdGFTZXJ2aWNlLnRhc2tGcm9tS2V5KHNsdWcpO1xuICAgICAgICAgICAgICByZXR1cm4gdmlzVXRpbHMuZ2V0VGFza0hlaWdodCh0YXNrKSArICdweCc7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3BhZGRpbmctdG9wJzogdmlzVXRpbHMucGFyYW1zLmxhbmVQYWRkaW5nLnRvcCAvIDIgKyAncHgnXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5kcmF3UmV2ZXJ0RmxhZ3MoKTtcbiAgICAgICAgdGhpcy5leHBhbmQoKTtcbiAgICAgIH0sXG4gICAgICBjb21wbGV0ZUFuZFNraXBUYXNrOiBmdW5jdGlvbih0YXNrKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIYW5kbGVzIHRoZSBwcm9taXNlIHJldHVybmVkIGJ5IG9yY2hlc3RyYUFwaS5jb21wbGV0ZUFuZFNraXBUYXNrXG4gICAgICAgICAqIGluIHRoZSB2aXN1YWxpemF0aW9uLlxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKCFjb25maXJtKCdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gc2tpcCB0aGlzIHRhc2sgYW5kIG1hcmsgaXQgJyArXG4gICAgICAgICAgJ2FzIGNvbXBsZXRlPyBUaGlzIG1pZ2h0IGxlYXZlIHRoZSBwcm9qZWN0IGluIGEgJyArXG4gICAgICAgICAgJ2NvcnJ1cHRlZC91bnJlY292ZXJhYmxlIHN0YXRlLicpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIG9yY2hlc3RyYUFwaS5jb21wbGV0ZUFuZFNraXBUYXNrKHRhc2spXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBkYXRhU2VydmljZS51cGRhdGVEYXRhKCk7XG4gICAgICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSAnRXJyb3Igc2tpcHBpbmcgdGFzay4nO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAwKSB7XG4gICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlLmRhdGEubWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFsZXJ0KGVycm9yTWVzc2FnZSk7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgcmV2ZXJ0VGFzazogZnVuY3Rpb24odGFza0lkLCBkYXRldGltZSkge1xuICAgICAgICAvKipcbiAgICAgICAgICogRGlzcGxheXMgYSBtb2RhbCBjb250YWluaW5nIHRoZSBhdWRpdCB0cmFpbCBvZiBpdGVtcyB0byBiZSByZXZlcnRlZC5cbiAgICAgICAgICogSGFuZGxlcyB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBvcmNoZXN0cmFBcGkucmV2ZXJ0VGFzayBpbiB0aGVcbiAgICAgICAgICogdmlzdWFsaXphdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0YXNrc1ZpcyA9IHRoaXM7XG4gICAgICAgIGlmICh0YXNrc1Zpcy5yZXZlcnRpbmcpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGFza3NWaXMucmV2ZXJ0aW5nID0gdHJ1ZTtcbiAgICAgICAgb3JjaGVzdHJhQXBpLnJldmVydFRhc2sodGFza0lkLCBkYXRldGltZSwgdHJ1ZSlcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgdmFyIG1vZGFsSW5zdGFuY2UgPSAkbW9kYWwub3Blbih7XG4gICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnL3N0YXRpYy9vcmNoZXN0cmEvcHJvamVjdF9tYW5hZ2VtZW50L3BhcnRpYWxzL3JldmVydF9tb2RhbC5odG1sJyxcbiAgICAgICAgICAgICAgY29udHJvbGxlcjogZnVuY3Rpb24oJHNjb3BlKSB7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmF1ZGl0ID0gX2h1bWFuaXplQXVkaXQocmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmNhbmNlbCA9IG1vZGFsSW5zdGFuY2UuY2xvc2U7XG4gICAgICAgICAgICAgICAgJHNjb3BlLmNvbmZpcm1SZXZlcnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgIG9yY2hlc3RyYUFwaS5yZXZlcnRUYXNrKHRhc2tJZCwgZGF0ZXRpbWUsIGZhbHNlKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICBkYXRhU2VydmljZS51cGRhdGVEYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yTWVzc2FnZSA9ICdDb3VsZCBub3QgcmV2ZXJ0IHRhc2suJztcbiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlLmRhdGEubWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgYWxlcnQoZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmZpbmFsbHkoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbW9kYWxJbnN0YW5jZS5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbW9kYWxJbnN0YW5jZS5yZXN1bHQuZmluYWxseShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgdGFza3NWaXMucmV2ZXJ0aW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgIGNyb3NzaGFpci5oaWRlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgdmFyIGVycm9yTWVzc2FnZSA9ICdDb3VsZCBub3QgZ2VuZXJhdGUgcmV2ZXJ0IGluZm9ybWF0aW9uLic7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDApIHtcbiAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gcmVzcG9uc2UuZGF0YS5tZXNzYWdlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWxlcnQoZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfSk7XG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

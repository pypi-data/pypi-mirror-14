$(document).ready(function(){function t(t,e){var a=(new XMLSerializer).serializeToString(t),r=e.getContext("2d"),n=new Image;return n.src="data:image/svg+xml;base64,"+btoa(a),n.onload=function(){r.drawImage(n,0,0)},n}$(window).on("beforeunload",function(){$(window).scrollTop(0)}),$("#loading").fadeIn();var e,a,r,n,s,o,l,d,r,p=window.innerWidth,m=(window.innerHeight,.9*p),u=160,f=.8*u,g=20,v=45,h=17,b=colorbrewer.Set1[9],y=["#f0a3ff","#0075dc","#993f00","#4c005c","#191919","#005c31","#2bce48","#ffcc99","#808080","#94ffb5","#8f7c00","#9dcc00","#c20088","#003380","#ffa405","#ffa8bb","#426600","#ff0010","#5ef1f2","#00998f","#e0ff66","#740aff","#990000","#ffff80","#ffff00","#ff5005"],_=0,x=(new Array,$(window).width());$(window).resize(function(){$(this).width()!=x&&(x=$(this).width(),this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){$("#resize-warning-nav").show()},500))}),$("#resize-warning-exit").click(function(){$("#resize-warning-nav").hide()});var A="ws://"+location.host+"/pongsocket",j=new WebSocket(A);j.onmessage=function(t){var a=JSON.parse(t.data);if("pong-data"==a.type)for(r=a.pong,$("#loading").fadeIn(),_+=r.qmatrices.length,n=r.popNames,s=r.popSizes,r.colors.length>0?b=r.colors:r.K_max>9&&(b=y),e=new Array,i=0;i<r.qmatrices.length;i++)majorID=r.qmatrices[i].major_mode_runid,plot=d3.select("#visualization").append("svg").attr("width",m).attr("height",u+15).attr("class","majorSVG").attr("id","plot"+majorID),e.push(plot),S(majorID,"no",null,null);else if("q-matrix"==a.type){var o=a.minor,l=a.minorID,d=a.is_first;"no"==o?k(d3.select("#plot"+a.name),a.K,a.matrix2d,a.minor,l,d):k(d3.select("#plot"+a.name+"_minor"),a.K,a.matrix2d,a.minor,l,d)}};var S=function(t,e,a,r){j.send(JSON.stringify({type:"get-qmatrix",name:t,minor:e,minorID:a,is_first:r}))},k=function(t,e,a,i,p,u){if("yes"==i)var g=.85*f;else var g=f;var v=a.length,h=r.qmatrices[e-r.K_min].color_perm;"yes"==i?(minorWidth=.75*m,o=.84*minorWidth,d=0,translate=.08*minorWidth):(o=.84*m,translate=.08*m,d=0),l=o/v;var y=r.qmatrices[e-r.K_min],x=y.major_mode_runid,w=Object.keys(y.modes),A=w.indexOf(x);A>-1&&w.splice(A,1);var j=q(y,w);0!=w.length&&"no"==i&&(_+=w.length+1,B(e,j)),"no"==i?(O(t,e,y),C(t,e,x)):D(t,y,p,u);var S=15,k=t.append("g").attr("transform","translate("+translate+", "+S+")"),P=k.append("svg").attr("class","plotSVG").attr("width",o).attr("id","plotSVG_"+x),K=P.append("g").attr("class","clustergroup").attr("id","clusters_"+e),N=d3.scale.linear().range([0,o]).domain([0,v-1]),E=d3.scale.linear().range([0,g]).domain([0,1]);for(c=0;c<e;c++){var G=new Array;for(Y=0;v>Y;Y++)G.push([Y,a[Y][c]]);if("yes"==i)var W=p+"_minorCluster"+h[c].toString();else var W="cluster_"+e+"_"+(c+1).toString();var F=d3.svg.area().x(function(t){return N(t[0])}).y1(function(t){for(myy=t[1],clus=c+1;clus<e;clus++)myy+=a[t[0]][clus];return E(myy)}).y0(function(){return E(0)});K.append("svg:path").attr("class",W).attr("id","clusters_"+e+"_"+c).attr("d",F(G)).attr("stroke",b[h[c]]).attr("stroke-width",.3).attr("fill",b[h[c]])}var J=P.append("g").attr("class","pop");if("yes"==i)var R=P.append("g").attr("class","minorPop"+e);var X=d,Q=d,U=d;if(null!=s)for(var Y=0;Y<s.length;Y++){if(J.call(H),"no"==i)var Z=J.selectAll("rect").data(r.indiv_avg[x]).enter().append("rect").on("mouseover",H.show).on("mouseout",H.hide);else var Z=R.selectAll("rect").data(r.indiv_avg[p]).enter().append("rect").on("mouseover",I.show).on("mouseout",I.hide);d3.select("#vizButton").on("click",function(){var t=new Array;for(popNum=1;popNum<s.length+1;popNum++){var e=".pop"+popNum.toString();"rgba(0, 0, 0, 0)"==d3.selectAll(e).style("fill")&&t.push(e)}d3.selectAll(".modal-title-viz").html(function(){var e="<h2>Visualizing populations:  </h2>",a="";for(Y in t){var r=t[Y].indexOf("o"),i=t[Y].substring(r+2),s=n[i-1];a+=s+", "}return e+'<h3 style="color: rgb(70, 184, 218)">'+a.substring(0,a.length-2)+"</h3>"})}),d3.selectAll(".modes").on("click",function(){var t=this.id,e=t.split("-")[1];d3.selectAll(".minorPop"+e).call(I)}),Z.attr({"class":function(t,e){return"no"==i?"popNum pop"+(e+1):"minorPopNum minorPlot"+p},id:function(t,a){return"no"==i?"k"+e+"p"+(a+1):"minor_"+p+"_p"+(a+1)},x:function(t,e){var a=U;return U+=s[e]*l,a},y:0,width:function(t,e){return s[e]*l},height:g}),Z.style("fill","transparent"),Z.style("stroke","black"),X=Q,Q+=s[Y]*l}if(d3.select("#whiteout"+e).on("click",function(){for(Y in j)L(e,j[Y],h)}),d3.selectAll(".popNum").on("click",function(){var t=this.id,e=t.indexOf("p"),a=t.substring(e+1);if(d3.event.shiftKey)d3.selectAll(".pop"+a.toString()).style("fill","transparent");else{{d3.selectAll(".popNum").style("fill","grey").style("opacity","0.85")}d3.selectAll(".pop"+a.toString()).style("fill","transparent")}}),$(document).mouseup(function(t){var e=$(".popNum"),a=$(".buttonDiv"),r=$("#vizButton"),n=$(".modal-content");e.is(t.target)||a.is(t.target)||r.is(t.target)||0!==e.has(t.target).length||0!==a.has(t.target).length||0!==r.has(t.target).length||e.css("fill","transparent"),n.is(t.target)||0!==n.has(t.target).length||$(".close").click()}),"no"==i&&a[0].length==r.K_max){var te=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",m).attr("height",g+"px").append("g"),ee=z(te,"no",e),ae=d3.select("#visualization").select(".majorPopLabels");ae.attr("height",ee[0]).attr("width",ee[1])}if("yes"==i&&p==j[j.length-1]){var te=d3.select("#modal_body_"+e).append("svg").attr("class","minorPopLabels_"+e).attr("width",.75*m).attr("height",g+"px").append("g"),ee=z(te,"yes",e);M(e)}if(V(t,e,y,i,r.K_min),"no"==i)var re=y.major_mode_runid;if("yes"==i)var re=t[0][0].getAttribute("id").slice(4);$("#"+re+"_print").click(function(e){e.preventDefault(),T(y,i,t,re).print()}),_--,0===_&&$("#loading").delay(200).fadeOut()},z=function(t,e,a){{var r=translate,o=translate;translate}for(i in n){r=o,o+=s[i]*l;var d=r+.5*(o-r)-.5*g,c=h,p="translate("+d+","+c+")rotate("+v+")";popid="yes"==e?"minor_"+a+"_pop"+i:"major_pop"+i;{t.append("text").text(n[i]).attr("class","x-axis").attr("transform",p).style("font-size","12px").style("font-family","Helvetica, sans-serif").attr("id",popid)}}return"no"==e?P("major_pop","majorPopLabels"):void 0},P=function(t,e){return labelsvg=d3.select("."+e).select("g").node(),[labelsvg.getBBox().height+15,labelsvg.getBBox().width+labelsvg.getBBox().x+15]},B=function(t,e){var a=d3.select("body").append("div").attr("class","buttonDiv"),n=a.append("button").attr("class","modes btn btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+t.toString()).attr("id","button-"+t);n.style("position","absolute").style("top",129+(u+20)*(t-r.K_min)+98+"px").style("left",(translate+.84*m+20).toString()+"px"),n.html('<i class="fa fa-plus"></i> <span style="font-weight:bold; font-size:125%;">'+e.length+"</span>"),N(t,e,n,a,!1)},N=function(t,e,n,s,o){{var l=s.append("div").attr("class","modal fade").attr("id",function(){return 0==o?"modal-"+t:"modal-viz"}).attr("role","dialog"),c=l.append("div").attr("class","modal-dialog"),p=c.append("div").attr("class","modal-content").attr("id","modal-content-"+t).style("width",(.75*m+80).toString()+"px").style("left",(d+10).toString()+"px"),f=p.append("div").attr("class","modal-header").attr("id",function(){return 0==o?"title"+t:"titleViz"});f.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").text("x"),f.append("h2").attr("class",function(){return 0==o?"modal-title":"modal-title-viz"}).html(function(){return 0==o?"Clustering modes, K="+t:void 0})}if(a=new Array,0==o){var g=p.append("div").attr("class","modal-header").attr("id","modal_header2_"+t),v=g.append("label").attr("class","checkbox-inline");v.append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+t),v.style("position","relative").style("top","4px");var h=(g.append("text").attr("class","checkbox-caption").text("\nCheck to highlight multimodality: "),r.qmatrices[t-r.K_min].major_mode_runid);plot=d3.select("#modal_header2_"+t).append("svg").attr("width",.75*m).attr("height",.95*u).attr("class","minorSVG-"+t).attr("id","plot"+h+"_minor"),a.push(plot),S(h,"yes",h,"yes")}p.append("div").attr("class","modal-body").attr("id",function(){return 0==o?"modal_body_"+t:"modal_body_viz"});if(0==o)for(i=0;i<e.length;i++){var b=e[i];plot=d3.select("#modal_body_"+t).append("svg").attr("width",.75*m).attr("height",.95*u).attr("class","minorSVG-"+t).attr("id","plot"+b+"_minor"),a.push(plot),S(b,"yes",b,"no")}},O=function(t,e,a){var r=a.total_runs,n=a.major_mode_runid,i=a.modes[n].runs_represented.length,s=.5*f+.5*g;label=t.append("text").text("K = "+e.toString()),label.attr("class","label").style("font","bold 20px Helvetica, sans-serif"),label.attr("x",0).attr("y",s),runs=t.append("text").text(i+"/"+r+" runs").attr("id","major_bigstring"),runs.attr("x",0).attr("y",s+25),runs.style("font","12px Helvetica, sans-serif");var o=document.getElementById("major_bigstring").getBBox(),l=o.width;l>translate&&(translate=l+5),avg_sim=a.modes[n].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg pairwise similarity: "+avg_sim.toString().substring(0,5)),sim.attr("x",translate).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Helvetica, sans-serif"))},D=function(t,e,a,r){var n=e.total_runs,i=e.modes[a].runs_represented.length,s=.5*f*.85+.5*g;return"yes"==r&&(major=t.append("text").text("major mode"),major.attr("class","majorMinorLabel").attr("id","minor_bigstring"),major.attr("x",0).attr("y",s-38-15),major.style("font","bold 14px Helvetica, sans-serif")),83.609>translate&&(translate=88.609),label=t.append("text").text(a),label.attr("class","label"),label.attr("x",0).attr("y",s-26),label.style("font","20px Helvetica, sans-serif"),rep=t.append("text").text("represents"),rep.attr("x",0).attr("y",s+14-26),rep.style("font","12px Helvetica, sans-serif"),runs=t.append("text").text(i+"/"+n+" runs"),runs.attr("class","minorRun"),runs.attr("x",0).attr("y",s+30-26),runs.style("font","12px Helvetica, sans-serif"),avg_sim=e.modes[a].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg pairwise similarity:"+avg_sim.toString().substring(0,5)),sim.attr("class","avg_sim"),sim.attr("x",translate).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Helvetica, sans-serif")),0},q=function(t,e){var a={};for(var r in e){var n=e[r],i=t.modes[n].runs_represented.length;a[n]=i}var s=Object.keys(a).map(function(t){return[t,a[t]]});s.sort(function(t,e){return e[1]-t[1]});var o=new Array;for(var r in s)o.push(s[r][0]);return o},L=function(t,e,a){var n=r.qmatrices[t-r.K_min].modes[e];if(null!=n.gray_indices){var s=n.gray_indices;for(i in n.gray_indices){var o=a[s[i]],l="."+e+"_minorCluster"+o.toString(),d=d3.select("#modal_body_"+t).select(".downloadModalPDF");"white"!=d3.selectAll(l).attr("fill")?(d3.selectAll(l).attr("fill","white").attr("stroke","white"),d.classed("btn btn-primary",!0).text("Print highlighting multimodality at K="+t)):(d3.selectAll(l).attr("fill",b[a[s[i]]]).attr("stroke",b[a[s[i]]]),d.classed("btn-primary",!1).text("Print all modes at K="+t))}}},C=function(t,e){var a=Math.round(1e3*r.qmatrices[e-r.K_min].avg_sim_bt_modes)/1e3;null!=a&&(simMode=d3.select("#title"+e).append("h4").text("\nAvg pairwise similarity among modes = "+a))},H=d3.tip().direction("s").attr("class","d3-tip").offset(function(){var t=d3.transform(d3.select(this.parentNode.parentNode.parentNode).attr("transform"));return[t.translate[1],0]}).html(function(t,e){var a=t.length,i=r.qmatrices[a-r.K_min].color_perm,o='<div class="text-center"><strong>'+n[e]+"</strong><br>"+s[e]+" samples</div><br>";o+="<div><ul>";for(var l=[],d=0;a>d;d++)l.push({datum:t[d],color:b[i[d]]});return l.sort(function(t,e){return t.datum>e.datum?-1:t.datum==e.datum?0:1}),l.forEach(function(t){var e=Math.round(1e3*t.datum)/10,a=t.color;e>=.5&&(o+='<i class="fa fa-circle" style="color: '+a+' "></i>',o+="&nbsp;<strong> "+e+"%</strong></li><br>")}),o+="</ul></div>"}),I=d3.tip().direction("e").attr("class","d3-minorTip").offset(function(t){var e=t.length,a=d3.select("#modal-content-"+e).style("width"),r=a.substring(0,a.length-2),n=this.getBBox().x,i=this.getBBox().width,s=n+i,o=r-s;return[0,o-30]}).html(function(t,e){var a=t.length,i=r.qmatrices[a-r.K_min].color_perm,o='<div class="text-center"><strong>'+n[e]+"</strong><br>"+s[e]+" samples</div><br>";o+="<div><ul>";for(var l=[],d=0;a>d;d++)l.push({datum:t[d],color:b[i[d]]});return l.sort(function(t,e){return t.datum>e.datum?-1:t.datum==e.datum?0:1}),l.forEach(function(t){var e=Math.round(1e3*t.datum)/10,a=t.color;e>=.5&&(o+='<i class="fa fa-circle" style="color: '+a+' "></i>',o+="&nbsp;<strong> "+e+"%</strong></li><br>")}),o+="</ul></div>"});$(document).on("click","#downloadPDF",function(){E("no").print()}),$(document).on("click",".downloadModalPDF",function(){K=$(this)[0].id,E(K).print()});var M=function(t){{var e=d3.select("#modal_body_"+t).append("div").attr("class","modal-body");e.append("div").attr("class","row").append("div").attr("class","text-center").append("button").attr("type","submit").attr("class","btn btn-default downloadModalPDF").attr("id",t).text("Print all modes at K="+t)}},V=function(t,e,a,r,n){if("no"==r)var i=d3.select("body").append("div").attr("class","pbDiv"),s=a.major_mode_runid+"_print";if("yes"==r)var i=d3.select("#modal_body_"+e).append("div").attr("class","pbDiv"),s=t[0][0].getAttribute("id").slice(4)+"_print",o=t[0][0].getAttribute("id").slice(4).slice(0,t[0][0].getAttribute("id").slice(4).indexOf("_minor")),l=Object.keys(a.modes),d=q(a,l),c=d.indexOf(o);var p=i.append("a").attr("id",s).append("span").attr("class","glyphicon glyphicon-print");"no"==r&&p.attr("id","print-major-"+e),"yes"==r&&p.attr("id","print-minor-"+o),"no"==r&&(p.attr("title","Print K="+e+" barplot"),i.style("position","absolute").style("top",1.131*u*(e-n+1)+85+"px").style("left","48px")),"yes"==r&&(p.attr("title","Print "+o+" barplot"),i.style("position","absolute").style("left","48px"),0==c?i.style("top",.95*u*-1+108.8-15+"px"):i.style("top",(.95*u+5)*c+5-30+"px"))},T=function(e,a,r,n){var i=d3.select("#plot"+n).node(),s=n.slice(1,n.indexOf("r"));if("no"==a)var o=d3.select(".majorPopLabels").node();if("yes"==a){var o=d3.select(".minorPopLabels_"+s).node(),l=o.getAttribute("height"),d=o.getAttribute("width"),c=P("minor_"+s+"_pop","minorPopLabels_"+s);o.setAttribute("height",c[0]),o.setAttribute("width",c[1])}var p=document.createElement("canvas"),m=t(i,p),u=t(o,p),f=window.open();return"yes"==a&&(o.setAttribute("height",l),o.setAttribute("width",d)),f.document.body.appendChild(m),f.document.body.appendChild(u),f},E=function(e){var a=document.createElement("canvas");if("no"==e)var r=document.getElementsByClassName("majorSVG"),n=d3.select(".majorPopLabels").node();else{var r=document.getElementsByClassName("minorSVG-"+e),n=d3.select(".minorPopLabels_"+e).node(),i=n.getAttribute("height"),s=n.getAttribute("width"),o=P("minor_"+e+"_pop","minorPopLabels_"+e);n.setAttribute("height",o[0]),n.setAttribute("width",o[1])}new Object;w=window.open();for(var l=0;l<r.length;l++){var d=t(r[l],a);w.document.body.appendChild(d)}return labs=t(n,a),w.document.body.appendChild(labs),"no"!=e&&(n.setAttribute("height",i),n.setAttribute("width",s)),w}});
/*!
  * Copyright 2014,  Digital Reasoning
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *
*/

define(["jquery","knockout","ladda","bootbox","utils/formula-versions","models/formula-version","fuelux","select2"],function(e,t,n,r,i,s){"use strict";return function(){var o=this;o.breadcrumbs=[{active:!1,title:"Stacks",href:"/stacks/"},{active:!0,title:"New"}],o.blueprintSelector=e("#stackBlueprint"),window.stackdio.blueprintId&&o.blueprintSelector.append('<option value="'+window.stackdio.blueprintId+'" title="'+window.stackdio.blueprintText+'">'+window.stackdio.blueprintText+"</option>"),o.blueprintSelector.select2({ajax:{url:"/api/blueprints/",dataType:"json",delay:100,data:function(e){return{q:e.term}},processResults:function(e){return e.results.forEach(function(e){e.text=e.title}),e},cache:!0},theme:"bootstrap",placeholder:"Select a blueprint...",templateResult:function(e){return e.loading?e.text:e.title+"  --  "+e.description},minimumInputLength:0}),o.selectBlueprint=function(t){function u(t){e.ajax({method:"GET",url:t}).done(function(e){r.push.apply(r,e.results.map(function(e){return new s(e,o)})),e.next===null?(o.formulaVersions(r),o.formulas?o.createSelectors():i.getAllFormulas(function(e){o.formulas=e,o.createSelectors()})):u(e.next)})}o.createUsers(t.create_users),o.blueprintId(t.id);var n=["blueprint","title","description","create_users","namespace","properties"];o.removeErrors(n),e.ajax({method:"GET",url:t.properties}).done(function(e){o.properties(e)});var r=[];u(t.formula_versions)},o.blueprintSelector.on("select2:select",function(e){var t=e.params.data;o.selectBlueprint(t)}),o.blueprintId=t.observable(),o.title=t.observable(),o.description=t.observable(),o.createUsers=t.observable(),o.namespace=t.observable(),o.properties=t.observable({}),o.formulaVersions=t.observableArray([]),o.formulas=null,o.versionsReady=t.observable(),o.validProperties=!0,o.createButton=null,o.propertiesJSON=t.pureComputed({read:function(){return t.toJSON(o.properties(),null,3)},write:function(e){try{o.properties(JSON.parse(e)),o.validProperties=!0}catch(t){o.validProperties=!1}}}),o.subscription=null,o.reset=function(){o.subscription&&o.subscription.dispose();var t=e(".checkbox-custom");o.subscription=o.createUsers.subscribe(function(e){e?t.checkbox("check"):t.checkbox("uncheck")}),o.blueprintId(null),o.title(""),o.description(""),o.createUsers(!1),o.namespace(""),o.properties({}),o.formulaVersions([]),o.versionsReady(!1),window.stackdio.blueprintId&&(o.blueprintSelector.val(window.stackdio.blueprintId).trigger("change"),e.ajax({method:"GET",url:"/api/blueprints/"+window.stackdio.blueprintId+"/"}).done(function(e){o.selectBlueprint(e)}))},o.createSelectors=function(){var e=[];o.formulaVersions().forEach(function(t){i.createVersionSelector(t,o.formulas)||e.push(t)}),e.forEach(function(e){o.formulaVersions.remove(e)}),o.versionsReady(!0)},o.removeErrors=function(t){t.forEach(function(t){var n=e("#"+t);n.removeClass("has-error");var r=n.find(".help-block");r.remove()})},o.getVersionsData=function(){return o.formulaVersions().map(function(e){return{formula:e.formula(),version:e.version()}})},o.createStack=function(){var t=["blueprint","title","description","create_users","namespace","properties"];o.removeErrors(t);if(!o.validProperties){var i=e("#properties");i.addClass("has-error"),i.append('<span class="help-block">Invalid JSON.</span>');return}var s=n.create(document.querySelector("#create-button"));s.start(),e.ajax({method:"POST",url:"/api/stacks/",data:JSON.stringify({blueprint:o.blueprintId(),title:o.title(),description:o.description(),create_users:o.createUsers(),namespace:o.namespace(),properties:o.properties(),formula_versions:o.getVersionsData()})}).always(function(){s.stop()}).done(function(){window.location="/stacks/"}).fail(function(n){var i="";try{var s=JSON.parse(n.responseText);for(var o in s)if(s.hasOwnProperty(o))if(t.indexOf(o)>=0){var u=e("#"+o);u.addClass("has-error"),s[o].forEach(function(e){u.append('<span class="help-block">'+e+"</span>")})}else if(o==="non_field_errors")s[o].forEach(function(t){if(t.indexOf("title")>=0){var n=e("#title");n.addClass("has-error"),n.append('<span class="help-block">A stack with this title already exists.</span>')}});else{var a=o.replace("_"," ");s[o].forEach(function(e){i+="<dt>"+a+"</dt><dd>"+e+"</dd>"})}i&&(i='<dl class="dl-horizontal">'+i+"</dl>")}catch(f){i="Oops... there was a server error.  This has been reported to your administrators."}i&&r.alert({title:"Error creating stack",message:i})})},o.reset()}});
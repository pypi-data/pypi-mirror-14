

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ZTPServer VM on EOS in a L3WOM &mdash; ZTPServer 1.3.2 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="ZTPServer 1.3.2 documentation" href="../../index.html"/>
        <link rel="up" title="Run ZTPServer as a VM on EOS" href="../ztpsVMonEOS.html"/>
        <link rel="next" title="Tips and tricks" href="../../tips.html"/>
        <link rel="prev" title="ZTPServer VM on EOS in a L2WOM" href="l2wom.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> ZTPServer</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#ztp-intro">ZTP Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#server">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#client">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#ztp-client-server-message-flows">ZTP Client-Server Message Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#topology-validation">Topology Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#operational-modes">Operational modes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#installation-options">Installation Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#upgrading">Upgrading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#additional-services">Additional services</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../startup.html">Startup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../startup.html#apache-mod-wsgi">Apache (mod_wsgi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup.html#standalone-debug-server">Standalone debug server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#global-configuration-file">Global configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#bootstrap-configuration">Bootstrap configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-overview">Static provisioning - overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-startup-config">Static provisioning - startup_config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-definition">Static provisioning - definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-attributes">Static provisioning - attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-pattern">Static provisioning - pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-config-handler">Static provisioning - config-handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-log">Static provisioning - log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#dynamic-provisioning-overview">Dynamic provisioning - overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#dynamic-provisioning-neighbordb">Dynamic provisioning - neighbordb</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#definitions">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#actions">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#plugins-for-allocating-resources">Plugins for allocating resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#config-handlers">Config-handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#other-files">Other files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#global-configuration-file">Global configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#dynamic-neighbordb-or-pattern-file">Dynamic neighbordb or pattern file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#static-neighbordb-and-node-unique-id-pattern-file">Static neighbordb and /node/&lt;unique-id&gt;/pattern file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#sample-dynamic-definition-file">Sample dynamic definition file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#sample-templates">Sample templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#sample-resources">Sample resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#neighbordb-pattern-examples">Neighbordb pattern examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#more-examples">More examples</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../cookbook.html">ZTPServer Cookbook</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clientLogging.html">Client-Side Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serverLogging.html">Server-Side Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html">ZTPServer Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../runningZTPS.html">Running the ZTPServer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helloWorld.html">Hello World - A Simple Provisioning Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../staticNodes.html">Provision a Static Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamicNodes.html">Provision a Dynamic Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topologyValidation.html">Topology Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../definitions.html">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../actions.html">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resourcePools.html">Resource Pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../puppet.html">Puppet Agent - Bootstrap EOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ansible.html">Ansible - Bootstrap EOS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ztpsVMonEOS.html">Run ZTPServer as a VM on EOS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips and tricks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-update-my-local-copy-of-ztpserver-from-github">How do I update my local copy of ZTPServer from GitHub?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#my-server-keeps-failing-to-load-my-resource-files-whats-going-on">My server keeps failing to load my resource files. Whatâ€™s going on?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-validate-the-format-of-my-config-files">How do I validate the format of my config files?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-debug-the-ztp-server-provisioning-process">How do I debug the ZTP Server provisioning process?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-disable-enable-ztp-mode-on-a-switch">How do I disable / enable ZTP mode on a switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-can-i-test-ztpserver-without-having-to-reboot-the-switch-every-time">How can I test ZTPServer without having to reboot the switch every time?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#what-is-the-recommended-test-environment-for-ztpserver">What is the recommended test environment for ZTPServer?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-override-the-default-system-mac-in-veos">How do I override the default system-mac in vEOS?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-override-the-default-serial-number-or-system-mac-in-veos">How do I override the default serial number or system-mac in vEOS?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../internals.html">Internals</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../implementation.html">Implementation Details</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html">Client - Server API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html">Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary of terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#contact">Contact</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#known-caveats">Known caveats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#releases">Releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#roadmap-highlights">Roadmap highlights</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#tutorial">Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#other-resources">Other Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#basics">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#before-requesting-support">Before Requesting Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../license.html#third-party">Third party</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ZTPServer</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../cookbook.html">ZTPServer Cookbook</a> &raquo;</li>
      
          <li><a href="../ztpsVMonEOS.html">Run ZTPServer as a VM on EOS</a> &raquo;</li>
      
    <li>ZTPServer VM on EOS in a L3WOM</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/cookbook/ztpsVMonEOS/l3wom.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="ztpserver-vm-on-eos-in-a-l3wom">
<h1>ZTPServer VM on EOS in a L3WOM<a class="headerlink" href="#ztpserver-vm-on-eos-in-a-l3wom" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="files-needed">
<h2>Files Needed<a class="headerlink" href="#files-needed" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">ztps.vmdk</span></tt>     : the VM disk image for the ZTPServer VM</li>
<li><tt class="docutils literal"><span class="pre">startup-config</span></tt>: a text file (with no extension)</li>
<li><tt class="docutils literal"><span class="pre">ztps.sh</span></tt>       : a bash shell script</li>
<li><tt class="docutils literal"><span class="pre">ztps.xml</span></tt>      : an xml file</li>
<li><tt class="docutils literal"><span class="pre">dhcpd.conf</span></tt>    : a text file for Linux dhcpd configuration</li>
<li><tt class="docutils literal"><span class="pre">dhcpd.rpm</span></tt>     : a DHCP server RPM to be installed on EOS</li>
<li><tt class="docutils literal"><span class="pre">ztps_daemon</span></tt>   : a python script</li>
<li><tt class="docutils literal"><span class="pre">fullrecover</span></tt>   : an empty text file (with no extension)</li>
<li><tt class="docutils literal"><span class="pre">boot-config</span></tt>   : a text file (with no extension); contains a single line: <tt class="docutils literal"><span class="pre">SWI=flash:EOS.swi</span></tt></li>
<li><tt class="docutils literal"><span class="pre">boot-extention</span></tt>: a text file (with no extention); contains a single like: <tt class="docutils literal"><span class="pre">dhcpd.rpm</span></tt></li>
<li><tt class="docutils literal"><span class="pre">EOS.swi</span></tt>       : download an EOS image and rename it to <tt class="docutils literal"><span class="pre">EOS.swi</span></tt></li>
</ul>
</div>
<div class="section" id="ztps-vmdk">
<h2>ztps.vmdk<a class="headerlink" href="#ztps-vmdk" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="objective">
<h3>Objective<a class="headerlink" href="#objective" title="Permalink to this headline">Â¶</a></h3>
<p>I want to create a ZTPServer vmdk file to use on EOS.</p>
</div>
<div class="section" id="solution">
<h3>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">Â¶</a></h3>
<dl class="docutils">
<dt>The ZTPServer vmdk file can be created using either methods below:</dt>
<dd><ol class="first last arabic simple">
<li>Automatically Create a Full-Featured ZTPServer: <a class="reference external" href="https://github.com/arista-eosplus/packer-ZTPServer">https://github.com/arista-eosplus/packer-ZTPServer</a></li>
<li>Create your own VM and install ZTPServer as intructed in the &#8220;Installation&#8221; section</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="explanation">
<h3>Explanation<a class="headerlink" href="#explanation" title="Permalink to this headline">Â¶</a></h3>
<p>The turnkey solution detailed on the github will create a full featured ztps.vmdk by executing a single command.  The vmdk created using this method comes with certain parameters pre-defined (i.e. domain-name, root user credential, IP address, etc).  If desired, you can change these parameters by logging into the VM after it&#8217;s created.</p>
<p>The second method requires more manual work compare to the first method, but may be more suitable if you already have a VM build to your needs and simply want to add ZTPServer to it.</p>
</div>
</div>
<div class="section" id="startup-config">
<h2>startup-config<a class="headerlink" href="#startup-config" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="id1">
<h3>Objective<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h3>
<p>I need to prepare a startup-config for the first SPINE switch to enable ZTPServer.</p>
</div>
<div class="section" id="id2">
<h3>Solution<a class="headerlink" href="#id2" title="Permalink to this headline">Â¶</a></h3>
<p>Essential parts of the configuration:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">interface</span> <span class="pre">Loopback2</span></tt>         : need a loopback interface on the same subnet as the VM</li>
<li><tt class="docutils literal"><span class="pre">daemon</span> <span class="pre">ztps</span></tt>                 : used to run the <tt class="docutils literal"><span class="pre">ztps.daemon</span></tt> python script in the background</li>
<li><tt class="docutils literal"><span class="pre">event-handler</span> <span class="pre">ztps</span></tt>          : used to start the shell script <tt class="docutils literal"><span class="pre">ztps.sh</span></tt></li>
<li><tt class="docutils literal"><span class="pre">virtual-machine</span> <span class="pre">ztps</span></tt>        : used to start the ZTPServer VM on EOS</li>
<li><tt class="docutils literal"><span class="pre">management</span> <span class="pre">api</span> <span class="pre">http-commands</span></tt>: need to enable eAPI for <tt class="docutils literal"><span class="pre">daemon</span> <span class="pre">ztps</span></tt> to function</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span class="go">interface Loopback2</span>
<span class="go">  ip address 172.16.130.253/24</span>

<span class="go">daemon ztps</span>
<span class="go">  command /mnt/flash/ztps_daemon &amp;</span>

<span class="go">event-handler ztps</span>
<span class="go">  trigger on-boot</span>
<span class="go">  action bash /mnt/flash/ztps.sh &amp;</span>
<span class="go">  delay 300</span>

<span class="go">virtual-machine ztps</span>
<span class="go">  config-file flash:/ztps.xml</span>
<span class="go">  enable</span>

<span class="go">management api http-commands</span>
<span class="go">  protocol http localhost</span>
<span class="go">  no shutdown</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>Explanation<a class="headerlink" href="#id3" title="Permalink to this headline">Â¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">event-handler</span> <span class="pre">ztps</span></tt> is triggered on-boot to kickstart the shell script <tt class="docutils literal"><span class="pre">ztps.sh</span></tt>.  There is a delay of 300 seconds before the script will be executed, to make sure all the necessary systems are in place before we run the script.  For details of the script please see the <tt class="docutils literal"><span class="pre">ztps.sh</span></tt> section.</p>
<p>The <tt class="docutils literal"><span class="pre">management</span> <span class="pre">api</span> <span class="pre">http-commands</span></tt> section enables Arista eAPI on the host swithc; eAPI is leveraged by the <tt class="docutils literal"><span class="pre">ztps_daemon</span></tt>.  eAPI can be accessed remotely via http or https, or it can be accessed locally via http, or by binding to a UNIX socket (only available on 4.14.5F onward).  Since the daemon is a script that runs locally, we can either enalbe eAPI on the localhost via http (if you are running 4.14.5F or later), or we can just enable eAPI over https (this will require authentication).</p>
<p>The <tt class="docutils literal"><span class="pre">daemon</span> <span class="pre">ztps</span></tt> section runs a python script in the back ground as a daemon to restart DHCPD whenever an interface comes up.</p>
<p>For details of the shell script <tt class="docutils literal"><span class="pre">ztps.sh</span></tt> and the python script <tt class="docutils literal"><span class="pre">ztps_daemon</span></tt> please refer to the corresponding sectio below.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The loopback interface is only needed if you plan to bootstrap a L3 ECMP fabric without a management network.  In this scenario, the loopback address needs to be advertised in the ECMP routing protocol to enable connectivity for the downstream deviecs in the fabric.</p>
</div>
</div>
</div>
<div class="section" id="ztps-sh">
<h2>ztps.sh<a class="headerlink" href="#ztps-sh" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="id4">
<h3>Objective<a class="headerlink" href="#id4" title="Permalink to this headline">Â¶</a></h3>
<p>I want to create a shell script to set up all the necessary environment for ZTPServer when the switch boots up.</p>
</div>
<div class="section" id="id5">
<h3>Solution<a class="headerlink" href="#id5" title="Permalink to this headline">Â¶</a></h3>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span>!/bin/bash
<span class="gp">#</span> This script is used with the event-handler so that on-boot, we will create linux bridge,
<span class="gp">#</span><span class="nb">enable </span>ip.forwarding, restart the ZTPS VM, and start DHCPD
<span class="go">logger -t &quot;ZTPS&quot; -p local0.info &quot;Starting the process for ZTPS VM deployment&quot;</span>

<span class="gp">#</span> Create Linux Bridge
<span class="go">sudo brctl addbr br0</span>
<span class="go">sudo ifconfig br0 up</span>
<span class="go">sudo ifconfig br0 172.16.130.254/24</span>

<span class="go">logger -t &quot;ZTPS&quot; -p local0.info &quot;Linux Bridge created&quot;</span>

<span class="gp">#</span> Enable ip.forwarding
<span class="go">sudo sysctl net.ipv4.conf.all.forwarding=1</span>
<span class="go">sudo sysctl net.ipv4.ip_forward=1</span>

<span class="go">logger -t &quot;ZTPS&quot; -p local0.info &quot;ip.forwarding enabled&quot;</span>

<span class="gp">#</span> Move the DHCP server RPM to the appropriate folder on EOS <span class="k">for </span>installation
<span class="gp">#</span> Move the dhcpd.conf file to the appropriate folder
<span class="go">sudo cp /mnt/flash/dhcp-4.2.0-23.P2.fc14.i686.rpm /mnt/flash/.extensions/dhcpd.rpm</span>
<span class="go">sudo cp /mnt/flash/dhcpd.conf /etc/dhcp/</span>
<span class="go">sudo /usr/sbin/dhcpd</span>
<span class="go">sleep 5</span>

<span class="gp">#</span>make sure dhcpd is running before we <span class="k">continue</span>
<span class="go">ps aux | grep &quot;dhcpd&quot; | grep -v grep</span>
<span class="go">if [ $? -eq 0 ]</span>
<span class="go">then</span>
<span class="go">{</span>
<span class="go">logger -t &quot;ZTPS&quot; -p local0.info &quot;DHCPD is running. Restart ZTPS VM.&quot;</span>

<span class="gp">#</span>Now lets restart the  ZTPS VM
<span class="go">sudo echo -e &quot;enable\nconfigure terminal\nvirtual-machine ztps restart\n&quot; | FastCli -M -e -p 15</span>

<span class="go">logger -t &quot;ZTPS&quot; -p local0.info &quot;ZTPS VM restarted&quot;</span>

<span class="go">exit 0</span>
<span class="go">}</span>
<span class="go">else</span>
<span class="go">  logger -t &quot;ZTPS&quot; -p local0.info &quot;Looks like DHCPD didn&#39;t start. Lets sleep for a few seconds and try again&quot;</span>
<span class="go">  sleep 10</span>
<span class="go">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>Explanation<a class="headerlink" href="#id6" title="Permalink to this headline">Â¶</a></h3>
<p>In order to enable connectivity to the VM from both remotely and locally (from the host switch), a Linux bridge interface needs to be created and assigned an IP in the same subnet as the VM; Linux <tt class="docutils literal"><span class="pre">ip.forwarding</span></tt> also needs to be enabled in the kernel for the packets to be routed to the VM.</p>
<p>EOS does not come with dhcpd preinstalled, there a DHCP-Server RPM needs to be downloaded, installed and started.  Dowdload the RPM from <a class="reference external" href="https://docs.google.com/a/arista.com/document/d/1fmhvousmZYr8Sidiv9rBf_PZDT-65QX0um215s_9K0c/edit#">here</a> and rename it to <tt class="docutils literal"><span class="pre">dhcpd.rpm</span></tt>. The RPM needs to be moved to the <tt class="docutils literal"><span class="pre">/mnt/flash/.extension</span></tt> location, and a <tt class="docutils literal"><span class="pre">boot-extension</span></tt> file, with the RPM specified, needs to be present in <tt class="docutils literal"><span class="pre">/mnt/flash</span></tt> in order for the RPM to be installed persistently after a reboot.</p>
<p>The ZTPServer VM needs to be restarted after the switch boots up.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ZTPServer VM needs to have its default gateway pointed to the br0 interface IP address.</p>
</div>
</div>
</div>
<div class="section" id="ztps-xml">
<h2>ztps.xml<a class="headerlink" href="#ztps-xml" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="id7">
<h3>Objective<a class="headerlink" href="#id7" title="Permalink to this headline">Â¶</a></h3>
<p>I want to prepare a KVM custom xml file to enable a VM on EOS.</p>
</div>
<div class="section" id="id8">
<h3>Solution<a class="headerlink" href="#id8" title="Permalink to this headline">Â¶</a></h3>
<p>Key parts of the xml file to pay attention to:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">&lt;domain</span> <span class="pre">type='kvm'</span> <span class="pre">id='1'&gt;</span></tt>          : in case multiple VMs are running on the system, make sure the configured ID is unique</li>
<li><tt class="docutils literal"><span class="pre">&lt;driver</span> <span class="pre">name='qemu'</span> <span class="pre">type='vmdk'/&gt;</span></tt>   : make sure the type is <tt class="docutils literal"><span class="pre">vmdk</span></tt></li>
<li><tt class="docutils literal"><span class="pre">&lt;source</span> <span class="pre">file='/mnt/usb1/ztps.vmdk'/&gt;</span></tt>: make sure the path is correct</li>
<li><tt class="docutils literal"><span class="pre">&lt;mac</span> <span class="pre">address='08:00:27:85:0c:f8'/&gt;</span></tt>  : make sure this MAC matches the MAC address of the interface on the ZTPServer VM that you intend to use for connectivity</li>
<li><tt class="docutils literal"><span class="pre">&lt;target</span> <span class="pre">dev='vnet0'/&gt;</span></tt>               : make sure the target device type is <tt class="docutils literal"><span class="pre">vnet0</span></tt></li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span class="go">&lt;domain type=&#39;kvm&#39; id=&#39;1&#39;&gt;</span>
<span class="go">  &lt;name&gt;ztps&lt;/name&gt;</span>
<span class="go">  &lt;memory&gt;1048576&lt;/memory&gt;</span>
<span class="go">  &lt;currentMemory&gt;1048576&lt;/currentMemory&gt;</span>
<span class="go">  &lt;vcpu&gt;1&lt;/vcpu&gt;</span>
<span class="go">  &lt;os&gt;</span>
<span class="go">    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-1.4&#39;&gt;hvm&lt;/type&gt;</span>
<span class="go">    &lt;boot dev=&#39;hd&#39;/&gt;</span>
<span class="go">  &lt;/os&gt;</span>
<span class="go">  &lt;features&gt;</span>
<span class="go">    &lt;acpi/&gt;</span>
<span class="go">    &lt;apic/&gt;</span>
<span class="go">    &lt;pae/&gt;</span>
<span class="go">  &lt;/features&gt;</span>
<span class="go">  &lt;clock offset=&#39;utc&#39;/&gt;</span>
<span class="go">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span>
<span class="go">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span>
<span class="go">  &lt;on_crash&gt;restart&lt;/on_crash&gt;</span>
<span class="go">  &lt;devices&gt;</span>
<span class="go">    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;</span>
<span class="go">    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;</span>
<span class="go">      &lt;driver name=&#39;qemu&#39; type=&#39;vmdk&#39;/&gt;</span>
<span class="go">      &lt;source file=&#39;/mnt/usb1/ztps.vmdk&#39;/&gt;</span>
<span class="go">      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;</span>
<span class="go">      &lt;alias name=&#39;ide0-0-0&#39;/&gt;</span>
<span class="go">      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; unit=&#39;0&#39;/&gt;</span>
<span class="go">    &lt;/disk&gt;</span>
<span class="go">    &lt;controller type=&#39;ide&#39; index=&#39;0&#39;&gt;</span>
<span class="go">      &lt;alias name=&#39;ide0&#39;/&gt;</span>
<span class="go">      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x01&#39; function=&#39;0x1&#39;/&gt;</span>
<span class="go">    &lt;/controller&gt;</span>
<span class="go">    &lt;interface type=&#39;bridge&#39;&gt;</span>
<span class="go">      &lt;mac address=&#39;08:00:27:85:0c:f8&#39;/&gt;</span>
<span class="go">      &lt;source bridge=&#39;br0&#39;/&gt;</span>
<span class="go">      &lt;target dev=&#39;vnet0&#39;/&gt;</span>
<span class="go">      &lt;model type=&#39;e1000&#39;/&gt;</span>
<span class="go">      &lt;alias name=&#39;net0&#39;/&gt;</span>
<span class="go">      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x0&#39;/&gt;</span>
<span class="go">    &lt;/interface&gt;</span>
<span class="go">    &lt;serial type=&#39;pty&#39;&gt;</span>
<span class="go">      &lt;source path=&#39;/dev/pts/5&#39;/&gt;</span>
<span class="go">      &lt;target port=&#39;0&#39;/&gt;</span>
<span class="go">      &lt;alias name=&#39;serial0&#39;/&gt;</span>
<span class="go">    &lt;/serial&gt;</span>
<span class="go">    &lt;console type=&#39;pty&#39; tty=&#39;/dev/pts/5&#39;&gt;</span>
<span class="go">      &lt;source path=&#39;/dev/pts/5&#39;/&gt;</span>
<span class="go">      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;</span>
<span class="go">      &lt;alias name=&#39;serial0&#39;/&gt;</span>
<span class="go">    &lt;/console&gt;</span>
<span class="go">    &lt;input type=&#39;tablet&#39; bus=&#39;usb&#39;&gt;</span>
<span class="go">      &lt;alias name=&#39;input0&#39;/&gt;</span>
<span class="go">    &lt;/input&gt;</span>
<span class="go">    &lt;input type=&#39;mouse&#39; bus=&#39;ps2&#39;/&gt;</span>
<span class="go">    &lt;graphics type=&#39;vnc&#39; port=&#39;5900&#39; autoport=&#39;no&#39; listen=&#39;0.0.0.0&#39;/&gt;</span>
<span class="go">    &lt;video&gt;</span>
<span class="go">      &lt;model type=&#39;vga&#39; vram=&#39;8192&#39; heads=&#39;1&#39;/&gt;</span>
<span class="go">      &lt;alias name=&#39;video0&#39;/&gt;</span>
<span class="go">      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;</span>
<span class="go">    &lt;/video&gt;</span>
<span class="go">    &lt;memballoon model=&#39;virtio&#39;&gt;</span>
<span class="go">      &lt;alias name=&#39;balloon0&#39;/&gt;</span>
<span class="go">      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x05&#39; function=&#39;0x0&#39;/&gt;</span>
<span class="go">    &lt;/memballoon&gt;</span>
<span class="go">  &lt;/devices&gt;</span>
<span class="go">&lt;/domain&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3>Explanation<a class="headerlink" href="#id9" title="Permalink to this headline">Â¶</a></h3>
<p>The interface definition section defines how the interface(s) of the VM should be initialized.  Since the vmdk already has interfaces defined/initialized, we have to use the same MAC address in the KVM definition file.</p>
<p>The target device type should be vnet0 to enable connectivity to the VM from both remotely and locally from the host switch.  Another choice here is the macvtap device type but this type prohibits connectivity for any locally routed packets (i.e. when the routing action to the VM takes place on the host switch).</p>
</div>
</div>
<div class="section" id="dhcpd-conf">
<h2>dhcpd.conf<a class="headerlink" href="#dhcpd-conf" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="id10">
<h3>Objective<a class="headerlink" href="#id10" title="Permalink to this headline">Â¶</a></h3>
<p>I want to prepare a dhcpd.conf file for running DHCPD on EOS.</p>
</div>
<div class="section" id="id11">
<h3>Solution<a class="headerlink" href="#id11" title="Permalink to this headline">Â¶</a></h3>
<div class="highlight-console"><div class="highlight"><pre><span class="go">class &quot;ARISTA&quot; {</span>
<span class="go">  match if substring(option vendor-class-identifier, 0, 6) = &quot;Arista&quot;;</span>
<span class="go">  option bootfile-name &quot;http://172.16.130.10:8080/bootstrap&quot;;</span>
<span class="go">}</span>

<span class="gp">#</span> Example
<span class="go">subnet 10.1.1.0 netmask 255.255.255.252 {</span>
<span class="go">  option routers 10.1.1.1;</span>
<span class="go">  default-lease-time 86400;</span>
<span class="go">  max-lease-time 86400;</span>
<span class="go">  pool {</span>
<span class="go">        range 10.1.1.2 10.1.1.2;</span>
<span class="go">        allow members of &quot;ARISTA&quot;;</span>
<span class="go">  }</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>Explanation<a class="headerlink" href="#id12" title="Permalink to this headline">Â¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">class</span> <span class="pre">&quot;ARISTA&quot;</span></tt> section defines a match criteria so that any subnet defition that uses this class would only allocate IPs if the requestor is an Arista device.  This class also defines a bootstrap file that will be downloaded to the requestor.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The IP address and TCP port number defined for the bootfile needs to match the ZTPServer VM configuration.</p>
</div>
<p>The subnet section provides an example to show you how it can be defined.  If you are bootstrapping a L3 ECMP network without a management network, this section needs to be repeated for every p-to-p links connecting to every leaf switches.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ZTPServer VM also runs dhcpd, but in the scenario of L3 ECMP without a management network, we are unable to leverage that. This is because DHCP relay from the host switch to the VM is currently not supported in EOS.</p>
</div>
</div>
</div>
<div class="section" id="ztps-daemon">
<h2>ztps_daemon<a class="headerlink" href="#ztps-daemon" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="id13">
<h3>Objective<a class="headerlink" href="#id13" title="Permalink to this headline">Â¶</a></h3>
<p>I want to create a python script that restarts DHCPD whenever an interface comes up.</p>
</div>
<div class="section" id="id14">
<h3>Solution<a class="headerlink" href="#id14" title="Permalink to this headline">Â¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">jsonrpclib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c">#PROTO = &quot;https&quot;</span>
<span class="c">#USERNAME = &quot;admin&quot;</span>
<span class="c">#PASSWORD = &quot;admin&quot;</span>
<span class="c">#HOSTNAME = &quot;172.16.130.20&quot;</span>

<span class="k">class</span> <span class="nc">EapiClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Instantiate a Eapi connection client object</span>
<span class="sd">    for interacting with EAPI</span>
<span class="sd">  &#39;&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># For EOS 4.14.5F and later, you can enable locally run scripts without needing to authenticate</span>
    <span class="c"># If you are running earlier versions, just uncomment next line and also the CONSTANTS above</span>
    <span class="c">#switch_url = &#39;{}://{}:{}@{}/command-api&#39;.format(PROTO, USERNAME, PASSWORD, HOSTNAME)</span>
    <span class="n">switch_url</span> <span class="o">=</span> <span class="s">&#39;http://localhost:8080/command-api&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">jsonrpclib</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">switch_url</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">connected_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;show interfaces status connected&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">runCmds</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">cmd</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">connected_intfs</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;interfaceStatuses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">connected_intfs</span>

<span class="k">def</span> <span class="nf">restart_dhcpd</span><span class="p">(</span><span class="n">eapi</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Monitor the connected interfaces.</span>
<span class="sd">    If there are newly connected interface(s), restart dhcpd</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">connected_intfs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">new_connected_intfs</span> <span class="o">=</span> <span class="n">eapi</span><span class="o">.</span><span class="n">connected_interfaces</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">new_connected_intfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">intf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connected_intfs</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;sudo service dhcpd restart&#39;</span><span class="p">)</span>

    <span class="n">connected_intfs</span> <span class="o">=</span> <span class="n">new_connected_intfs</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">eapi</span> <span class="o">=</span> <span class="n">EapiClient</span><span class="p">()</span>
  <span class="n">restart_dhcpd</span><span class="p">(</span><span class="n">eapi</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="id15">
<h3>Explanation<a class="headerlink" href="#id15" title="Permalink to this headline">Â¶</a></h3>
<p>DHCPD only binds to interfaces that are UP when the process started.  Since we are running DHCPD directly on the SPINE switch, there is no gaurantee that the interfaces connected to the LEAFs are up when DHCPD started.  Therefore, we need to run a script/daemon in the background to continuously check the connected interface status, and if new interfaces came up, DHCPD would be restarted to bind to the newly connected interfaces.</p>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../tips.html" class="btn btn-neutral float-right" title="Tips and tricks"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="l2wom.html" class="btn btn-neutral" title="ZTPServer VM on EOS in a L2WOM"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Arista Networks.
      Last updated on Oct 13, 2015.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
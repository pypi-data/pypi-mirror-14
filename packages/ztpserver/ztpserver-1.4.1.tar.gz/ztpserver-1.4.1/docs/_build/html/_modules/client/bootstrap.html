

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>client.bootstrap &mdash; ZTPServer 1.3.2 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="ZTPServer 1.3.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> ZTPServer</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#ztp-intro">ZTP Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#server">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#client">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#ztp-client-server-message-flows">ZTP Client-Server Message Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#topology-validation">Topology Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview.html#operational-modes">Operational modes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#installation-options">Installation Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#upgrading">Upgrading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#additional-services">Additional services</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../startup.html">Startup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../startup.html#apache-mod-wsgi">Apache (mod_wsgi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup.html#standalone-debug-server">Standalone debug server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#global-configuration-file">Global configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#bootstrap-configuration">Bootstrap configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-overview">Static provisioning - overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-startup-config">Static provisioning - startup_config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-definition">Static provisioning - definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-attributes">Static provisioning - attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-pattern">Static provisioning - pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-config-handler">Static provisioning - config-handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#static-provisioning-log">Static provisioning - log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#dynamic-provisioning-overview">Dynamic provisioning - overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#dynamic-provisioning-neighbordb">Dynamic provisioning - neighbordb</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#definitions">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#actions">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#plugins-for-allocating-resources">Plugins for allocating resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#config-handlers">Config-handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#other-files">Other files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#global-configuration-file">Global configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#dynamic-neighbordb-or-pattern-file">Dynamic neighbordb or pattern file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#static-neighbordb-and-node-unique-id-pattern-file">Static neighbordb and /node/&lt;unique-id&gt;/pattern file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#sample-dynamic-definition-file">Sample dynamic definition file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#sample-templates">Sample templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#sample-resources">Sample resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#neighbordb-pattern-examples">Neighbordb pattern examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#more-examples">More examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook.html">ZTPServer Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/clientLogging.html">Client-Side Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/serverLogging.html">Server-Side Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/configuration.html">ZTPServer Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/runningZTPS.html">Running the ZTPServer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/helloWorld.html">Hello World - A Simple Provisioning Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/staticNodes.html">Provision a Static Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/dynamicNodes.html">Provision a Dynamic Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/topologyValidation.html">Topology Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/definitions.html">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/actions.html">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/resourcePools.html">Resource Pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/puppet.html">Puppet Agent - Bootstrap EOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/ansible.html">Ansible - Bootstrap EOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/ztpsVMonEOS.html">Run ZTPServer as a VM on EOS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips and tricks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-update-my-local-copy-of-ztpserver-from-github">How do I update my local copy of ZTPServer from GitHub?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#my-server-keeps-failing-to-load-my-resource-files-whats-going-on">My server keeps failing to load my resource files. Whatâ€™s going on?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-validate-the-format-of-my-config-files">How do I validate the format of my config files?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-debug-the-ztp-server-provisioning-process">How do I debug the ZTP Server provisioning process?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-disable-enable-ztp-mode-on-a-switch">How do I disable / enable ZTP mode on a switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-can-i-test-ztpserver-without-having-to-reboot-the-switch-every-time">How can I test ZTPServer without having to reboot the switch every time?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#what-is-the-recommended-test-environment-for-ztpserver">What is the recommended test environment for ZTPServer?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-override-the-default-system-mac-in-veos">How do I override the default system-mac in vEOS?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips.html#how-do-i-override-the-default-serial-number-or-system-mac-in-veos">How do I override the default serial number or system-mac in vEOS?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../internals.html">Internals</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../implementation.html">Implementation Details</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html">Client - Server API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html">Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary of terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#contact">Contact</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#known-caveats">Known caveats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#releases">Releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#roadmap-highlights">Roadmap highlights</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#tutorial">Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support.html#other-resources">Other Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#basics">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting.html#before-requesting-support">Before Requesting Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../license.html#third-party">Third party</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ZTPServer</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>client.bootstrap</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for client.bootstrap</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Copyright (c) 2015, Arista Networks, Inc.</span>
<span class="c"># All rights reserved.</span>
<span class="c">#</span>
<span class="c"># Redistribution and use in source and binary forms, with or without</span>
<span class="c"># modification, are permitted provided that the following conditions are</span>
<span class="c"># met:</span>
<span class="c">#  - Redistributions of source code must retain the above copyright notice,</span>
<span class="c"># this list of conditions and the following disclaimer.</span>
<span class="c">#  - Redistributions in binary form must reproduce the above copyright</span>
<span class="c"># notice, this list of conditions and the following disclaimer in the</span>
<span class="c"># documentation and/or other materials provided with the distribution.</span>
<span class="c">#  - Neither the name of Arista Networks nor the names of its</span>
<span class="c"># contributors may be used to endorse or promote products derived from</span>
<span class="c"># this software without specific prior written permission.</span>
<span class="c">#</span>
<span class="c"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c"># &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c"># LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="c"># A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL ARISTA NETWORKS</span>
<span class="c"># BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="c"># BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
<span class="c"># WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE</span>
<span class="c"># OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN</span>
<span class="c"># IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c">#</span>
<span class="c"># Bootstrap script</span>
<span class="c">#</span>
<span class="c">#    Written by:</span>
<span class="c">#       EOS+, Arista Networks</span>

<span class="c">#pylint: disable=W0703</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">jsonrpclib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sleekxmpp</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">grp</span>
<span class="kn">import</span> <span class="nn">crypt</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">urlparse</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="kn">import</span> <span class="n">SysLogHandler</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>              <span class="c">#pylint: disable=W0402</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlsplit</span><span class="p">,</span> <span class="n">urlunsplit</span>

<span class="c"># Server will replace this value with the correct IP address/hostname</span>
<span class="c"># before responding to the bootstrap request.</span>
<span class="n">SERVER</span> <span class="o">=</span> <span class="s">&#39;$SERVER&#39;</span>

<span class="n">LOGGING_FACILITY</span> <span class="o">=</span> <span class="s">&#39;ztpbootstrap&#39;</span>
<span class="n">SYSLOG</span> <span class="o">=</span> <span class="s">&#39;/dev/log&#39;</span>
<span class="n">DEFAULT_SYSLOG_PORT</span> <span class="o">=</span> <span class="mi">514</span>

<span class="n">CONTENT_TYPE_PYTHON</span> <span class="o">=</span> <span class="s">&#39;text/x-python&#39;</span>
<span class="n">CONTENT_TYPE_HTML</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
<span class="n">CONTENT_TYPE_OTHER</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
<span class="n">CONTENT_TYPE_JSON</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>

<span class="n">TEMP</span> <span class="o">=</span> <span class="s">&#39;/tmp&#39;</span>

<span class="n">COMMAND_API_SERVER</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
<span class="n">COMMAND_API_USERNAME</span> <span class="o">=</span> <span class="s">&#39;ztps&#39;</span>
<span class="n">COMMAND_API_PASSWORD</span> <span class="o">=</span> <span class="s">&#39;ztps-password&#39;</span>
<span class="n">COMMAND_API_PROTOCOL</span> <span class="o">=</span> <span class="s">&#39;http&#39;</span>

<span class="n">HTTP_STATUS_OK</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HTTP_STATUS_CREATED</span> <span class="o">=</span> <span class="mi">201</span>
<span class="n">HTTP_STATUS_BAD_REQUEST</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">HTTP_STATUS_NOT_FOUND</span> <span class="o">=</span> <span class="mi">404</span>
<span class="n">HTTP_STATUS_CONFLICT</span> <span class="o">=</span> <span class="mi">409</span>
<span class="n">HTTP_STATUS_INTERNAL_SERVER_ERROR</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">FLASH</span> <span class="o">=</span> <span class="s">&#39;/mnt/flash&#39;</span>

<span class="n">STARTUP_CONFIG</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/startup-config&#39;</span> <span class="o">%</span> <span class="n">FLASH</span>
<span class="n">RC_EOS</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/rc.eos&#39;</span> <span class="o">%</span> <span class="n">FLASH</span>

<span class="n">BOOT_EXTENSIONS</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/boot-extensions&#39;</span> <span class="o">%</span> <span class="n">FLASH</span>
<span class="n">BOOT_EXTENSIONS_FOLDER</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/.extensions&#39;</span> <span class="o">%</span> <span class="n">FLASH</span>

<span class="n">HTTP_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">FLASH_FILES</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">RESTORE_FACTORY_FLASH</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c">#pylint: disable=C0103</span>
<span class="n">syslog_manager</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">xmpp_client</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c">#pylint: enable=C0103</span>

<span class="c">#---------------------------------XMPP------------------------</span>
<span class="c"># Uncomment this section in order to enable XMPP debug logging</span>
<span class="c"># logging.basicConfig(level=logging.DEBUG,</span>
<span class="c">#                     format=&#39;%(levelname)-8s %(message)s&#39;)</span>

<span class="c"># You will also have to comment out the following lines:</span>
<span class="k">for</span> <span class="n">logger</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sleekxmpp.xmlstream.xmlstream&#39;</span><span class="p">,</span>
               <span class="s">&#39;sleekxmpp.basexmpp&#39;</span><span class="p">]:</span>
    <span class="n">xmpp_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">xmpp_log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>
<span class="c">#---------------------------------XMPP------------------------</span>

<span class="c">#---------------------------------SYSLOG----------------------</span>
<span class="c"># Comment out this section in order to enable syslog debug</span>
<span class="c"># logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">raiseExceptions</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c">#---------------------------------XMPP------------------------</span>

<span class="c"># ------------------Utilities---------------------------------</span>
<span class="k">def</span> <span class="nf">_exit</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="c">#pylint: disable=W0702</span>

    <span class="c"># Wait for XMPP messages to drain</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xmpp_client</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xmpp_client</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">RESTORE_FACTORY_FLASH</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">STARTUP_CONFIG</span><span class="p">,</span> <span class="n">RC_EOS</span><span class="p">,</span> <span class="n">BOOT_EXTENSIONS</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.ztp&#39;</span> <span class="o">%</span> <span class="n">path</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;Saving </span><span class="si">%s</span><span class="s"> as </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

            <span class="n">backup_path</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;Recovering </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">):</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.ztp&#39;</span> <span class="o">%</span> <span class="n">BOOT_EXTENSIONS_FOLDER</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Saving </span><span class="si">%s</span><span class="s"> as </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">dst</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">,</span>
                        <span class="s">&#39;</span><span class="si">%s</span><span class="s">.ztp&#39;</span> <span class="o">%</span> <span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">)</span>

        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span>
            <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Recovering </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_files_and_dirs</span><span class="p">(</span><span class="n">FLASH</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FLASH_FILES</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;Deleting </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="c"># already removed</span>
                        <span class="k">pass</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c">#pylint: disable=W0212</span>
    <span class="c"># Need to close background sleekxmpp threads as well</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

<span class="n">SYSTEM_ID</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">XMPP_MSG_TYPE</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">def</span> <span class="nf">log_xmpp</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">XMPP_MSG_TYPE</span> <span class="o">==</span> <span class="s">&#39;debug&#39;</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xmpp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">xmpp</span> <span class="o">=</span> <span class="n">log_xmpp</span><span class="p">()</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">xmpp_msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SYSTEM_ID</span> <span class="k">if</span> <span class="n">SYSTEM_ID</span> <span class="k">else</span> <span class="s">&#39;N/A&#39;</span><span class="p">,</span>
                                  <span class="n">timestamp</span><span class="p">,</span>
                                  <span class="s">&#39;ERROR: &#39;</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                                  <span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xmpp</span> <span class="ow">and</span> <span class="n">xmpp_client</span> <span class="ow">and</span> <span class="n">xmpp_client</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
        <span class="n">xmpp_client</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">xmpp_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">SYSTEM_ID</span><span class="p">:</span>
        <span class="n">syslog_msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SYSTEM_ID</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">syslog_msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;ERROR: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">syslog_msg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">syslog_msg</span>

    <span class="k">if</span> <span class="n">syslog_manager</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">syslog_manager</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">syslog_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">syslog_manager</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">syslog_msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">url_path_join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalize URL parts and join them with a slash.&quot;&quot;&quot;</span>
    <span class="c"># pylint: disable=W0142</span>
    <span class="n">schemes</span><span class="p">,</span> <span class="n">netlocs</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">fragments</span> <span class="o">=</span> \
        <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">))</span>
    <span class="n">scheme</span> <span class="o">=</span> <span class="n">get_first_token</span><span class="p">(</span><span class="n">schemes</span><span class="p">)</span>
    <span class="n">netloc</span> <span class="o">=</span> <span class="n">get_first_token</span><span class="p">(</span><span class="n">netlocs</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">get_first_token</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
    <span class="n">fragment</span> <span class="o">=</span> <span class="n">get_first_token</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urlunsplit</span><span class="p">((</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">))</span>

<span class="c">#pylint: disable=C0103</span>
<span class="n">_ntuple_diskusage</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;usage&#39;</span><span class="p">,</span> <span class="s">&#39;total used free&#39;</span><span class="p">)</span>
<span class="c">#pylint: enable=C0103</span>
<span class="k">def</span> <span class="nf">flash_usage</span><span class="p">():</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">FLASH</span><span class="p">)</span>
    <span class="n">free</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_bavail</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_frsize</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_blocks</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_frsize</span>
    <span class="n">used</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">f_blocks</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_bfree</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_frsize</span>
    <span class="k">return</span> <span class="n">_ntuple_diskusage</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">free</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">flash_snapshot</span><span class="p">():</span>
    <span class="c">#pylint: disable=W0603</span>
    <span class="k">global</span> <span class="n">FLASH_FILES</span>
    <span class="n">FLASH_FILES</span> <span class="o">=</span> <span class="n">all_files_and_dirs</span><span class="p">(</span><span class="n">FLASH</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">STARTUP_CONFIG</span><span class="p">,</span> <span class="n">RC_EOS</span><span class="p">,</span> <span class="n">BOOT_EXTENSIONS</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Backing up </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c"># Delete old folder in tmp</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Backing up </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">)</span>

        <span class="c"># Delete old folder in /tmp</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">BOOT_EXTENSIONS_FOLDER</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_first_token</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequence</span> <span class="k">if</span> <span class="n">x</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">all_files_and_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">top</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span>
<span class="c"># ------------------Utilities---------------------------------</span>


<span class="c"># ------------------4.12.x support----------------------------</span>
<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>      <span class="c">#pylint: disable=E1103</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Retrieving URL: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">HTTP_TIMEOUT</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c">#pylint: disable=C0103</span>
<span class="n">REQUESTS</span> <span class="o">=</span> <span class="s">&#39;requests-2.3.0&#39;</span>
<span class="n">REQUESTS_URL</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span> <span class="s">&#39;/files/lib/&#39;</span><span class="p">,</span> <span class="n">REQUESTS</span><span class="o">+</span><span class="s">&#39;.tar.gz&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">requests</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">requests_url</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.tar.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TEMP</span><span class="p">,</span> <span class="n">REQUESTS</span><span class="p">)</span>
    <span class="n">download_file</span><span class="p">(</span><span class="n">REQUESTS_URL</span><span class="p">,</span> <span class="n">requests_url</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;sudo tar -xzvf </span><span class="si">%s</span><span class="s"> -C /tmp;&#39;</span> \
          <span class="s">&#39;cd </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">;&#39;</span> \
          <span class="s">&#39;sudo python setup.py build;&#39;</span> \
          <span class="s">&#39;sudo python setup.py install&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">requests_url</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span> <span class="n">REQUESTS</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> returned </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">res</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">requests</span>
<span class="c">#pylint: enable=C0103</span>
<span class="c"># ------------------4.12.x support----------------------------</span>


<span class="k">class</span> <span class="nc">ZtpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ZtpActionError</span><span class="p">(</span><span class="n">ZtpError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ZtpUnexpectedServerResponseError</span><span class="p">(</span><span class="n">ZtpError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Attributes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">special_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_attr</span> <span class="o">=</span> <span class="n">local_attr</span> <span class="k">if</span> <span class="n">local_attr</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_attr</span> <span class="o">=</span> <span class="n">special_attr</span> <span class="k">if</span> <span class="n">special_attr</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_attr</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_attr</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_attr</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_attr</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_attr</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_attr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_attr</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
     <span class="c">#pylint: disable=R0201</span>

    <span class="sd">&#39;&#39;&#39;Node object which can be used by actions via:</span>
<span class="sd">           attributes.get(&#39;NODE&#39;)</span>

<span class="sd">    Attributes:</span>
<span class="sd">      client (jsonrpclib.Server): jsonrpclib connect to Command API engine</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_</span> <span class="o">=</span> <span class="n">server</span>

        <span class="n">Node</span><span class="o">.</span><span class="n">_enable_api</span><span class="p">()</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">/command-api&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COMMAND_API_PROTOCOL</span><span class="p">,</span>
                                             <span class="n">COMMAND_API_USERNAME</span><span class="p">,</span>
                                             <span class="n">COMMAND_API_PASSWORD</span><span class="p">,</span>
                                             <span class="n">COMMAND_API_SERVER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">jsonrpclib</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_enable_cmds</span><span class="p">([])</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;unable to enable eAPI&#39;</span><span class="p">)</span>

        <span class="c"># Workaround for BUG89374</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disable_copp</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">jsonrpclib</span><span class="o">.</span><span class="n">jsonrpc</span><span class="o">.</span><span class="n">ProtocolError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;WARNING: unable to disable COPP: </span><span class="si">%s</span><span class="s"> &#39;</span>
                <span class="s">&#39;(platform/EOS version might not support this feature)&#39;</span> <span class="o">%</span>
                <span class="n">err</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">SYSTEM_ID</span>                    <span class="c">#pylint: disable=W0603</span>
        <span class="n">SYSTEM_ID</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">api_enable_cmds</span><span class="p">([</span><span class="s">&#39;show version&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;serialNumber&#39;</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_cli_enable_cmd</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">cli_cmd</span><span class="p">):</span>
        <span class="n">bash_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;FastCli&#39;</span><span class="p">,</span> <span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;15&#39;</span><span class="p">,</span> <span class="s">&#39;-A&#39;</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cli_cmd</span><span class="p">]</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">bash_cmd</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>      <span class="c">#pylint: disable=E1101</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_cli_config_cmds</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">cmds</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_cli_enable_cmd</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;configure&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmds</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_enable_api</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_cli_config_cmds</span><span class="p">([</span><span class="s">&#39;username </span><span class="si">%s</span><span class="s"> secret </span><span class="si">%s</span><span class="s"> privilege 15&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">COMMAND_API_USERNAME</span><span class="p">,</span>
                               <span class="n">COMMAND_API_PASSWORD</span><span class="p">),</span>
                              <span class="s">&#39;management api http-commands&#39;</span><span class="p">,</span>
                              <span class="s">&#39;no protocol https&#39;</span><span class="p">,</span>
                              <span class="s">&#39;protocol </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">COMMAND_API_PROTOCOL</span><span class="p">,</span>
                              <span class="s">&#39;no shutdown&#39;</span><span class="p">])</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_cli_enable_cmd</span><span class="p">(</span><span class="s">&#39;show management api http-commands |&#39;</span>
                                        <span class="s">&#39; grep running&#39;</span><span class="p">)</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">and</span> <span class="n">retries</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Waiting for CommandAPI to be enabled...&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">retries</span> <span class="o">=</span> <span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_cli_enable_cmd</span><span class="p">(</span>
                <span class="s">&#39;show management api http-commands | grep running&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_disable_copp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># COPP does not apply to vEOS or EOS-4.11.x and earlier</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">()[</span><span class="s">&#39;model&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;vEOS&#39;</span> <span class="ow">and</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">()[</span><span class="s">&#39;version&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">()[</span><span class="s">&#39;version&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_config_cmds</span><span class="p">([</span><span class="s">&#39;control-plane&#39;</span><span class="p">,</span>
                                  <span class="s">&#39;no service-policy input copp-system-policy&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_has_rc_eos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">RC_EOS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_append_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.bash_cmds"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.bash_cmds">[docs]</a>    <span class="k">def</span> <span class="nf">bash_cmds</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">cmds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Executes bash commands in order - stops on first failure.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmds: list of bash commands</span>

<span class="sd">        Returns:</span>
<span class="sd">            cmd:  first failing command (None otherwise)</span>
<span class="sd">            code: exit code for first failing command (None otherwise)</span>
<span class="sd">            out:  stdout for first failing command (None otherwise)</span>
<span class="sd">            err:  stderr for first failing command (None otherwise)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">bash_cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">bash_cmd</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
                                    <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>         <span class="c">#pylint: disable=E1101</span>
            <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">or</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">bash_cmd</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">out</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.substitute"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.substitute">[docs]</a>    <span class="k">def</span> <span class="nf">substitute</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">substitutions</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Perform variable substitution on a config template.</span>

<span class="sd">        Args:</span>
<span class="sd">            template (string): EOS configuration template</span>
<span class="sd">            substitutions (dict): set of substitutions for the template</span>
<span class="sd">            strict (bool, optional): If true, method will raise Exception</span>
<span class="sd">                                     when template variables are missing</span>
<span class="sd">                                     from &#39;substitutions&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: template string with variable substitution</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">substitutions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">substitutions</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unable to perform variable substitution - &#39;</span>
                            <span class="s">&#39;</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> missing from list of substitutions&#39;</span> <span class="o">%</span>
                            <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.api_enable_cmds"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.api_enable_cmds">[docs]</a>    <span class="k">def</span> <span class="nf">api_enable_cmds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">text_format</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run CLI commands via Command API, starting from enable mode.</span>

<span class="sd">        Commands are ran in order.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmds (list): List of CLI commands.</span>
<span class="sd">            text_format (bool, optional): If true, Command API request will run</span>
<span class="sd">                                          in text mode (instead of JSON).</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of Command API results corresponding to the</span>
<span class="sd">                  input commands.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">req_format</span> <span class="o">=</span> <span class="s">&#39;text&#39;</span> <span class="k">if</span> <span class="n">text_format</span> <span class="k">else</span> <span class="s">&#39;json&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">runCmds</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;enable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">req_format</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c"># EOS-4.14.5+: persistent connection might be have been closed</span>
            <span class="c"># on timeout - should recover on first retry</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>      <span class="c"># Broken PIPE</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">runCmds</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;enable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">req_format</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span>

        <span class="k">if</span> <span class="n">text_format</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</div>
<div class="viewcode-block" id="Node.api_config_cmds"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.api_config_cmds">[docs]</a>    <span class="k">def</span> <span class="nf">api_config_cmds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run CLI commands via Command API, starting from config mode.</span>

<span class="sd">        Commands are ran in order.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmds (list): List of CLI commands.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of Command API results corresponding to the</span>
<span class="sd">                  input commands.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_enable_cmds</span><span class="p">([</span><span class="s">&#39;configure&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmds</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
</div>
<div class="viewcode-block" id="Node.system"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.system">[docs]</a>    <span class="k">def</span> <span class="nf">system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get system information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: System information</span>

<span class="sd">            Format::</span>

<span class="sd">                {&#39;model&#39;:        &lt;MODEL&gt;,</span>
<span class="sd">                 &#39;version&#39;:      &lt;EOS_VERSION&gt;,</span>
<span class="sd">                 &#39;systemmac&#39;:    &lt;SYSTEM_MAC&gt;,</span>
<span class="sd">                 &#39;serialnumber&#39;: &lt;SERIAL_NUMBER&gt;}</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_enable_cmds</span><span class="p">([</span><span class="s">&#39;show version&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">result</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;modelName&#39;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;systemmac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;systemMacAddress&#39;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;serialnumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;serialNumber&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Node.neighbors"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.neighbors">[docs]</a>    <span class="k">def</span> <span class="nf">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get neighbors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: LLDP neighbor</span>

<span class="sd">            Format::</span>

<span class="sd">                {&#39;neighbors&#39;: {&lt;LOCAL_PORT&gt;:</span>
<span class="sd">                 [{&#39;device&#39;: &lt;REMOTE_DEVICE&gt;,</span>
<span class="sd">                   &#39;port&#39;: &lt;REMOTE_PORT&gt;}, ...],</span>
<span class="sd">                ...}}</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_enable_cmds</span><span class="p">([</span><span class="s">&#39;show lldp neighbors&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;neighbors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;lldpNeighbors&#39;</span><span class="p">]:</span>
            <span class="n">neighbor</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">neighbor</span><span class="p">[</span><span class="s">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s">&#39;neighborDevice&#39;</span><span class="p">]</span>
            <span class="n">neighbor</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s">&#39;neighborPort&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;neighbors&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">&#39;neighbors&#39;</span><span class="p">][</span><span class="n">entry</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">neighbor</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s">&#39;neighbors&#39;</span><span class="p">][</span><span class="n">entry</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">neighbor</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Node.details"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.details">[docs]</a>    <span class="k">def</span> <span class="nf">details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: System details</span>

<span class="sd">            Format::</span>

<span class="sd">                {&#39;model&#39;:        &lt;MODEL&gt;,</span>
<span class="sd">                 &#39;version&#39;:      &lt;EOS_VERSION&gt;,</span>
<span class="sd">                 &#39;systemmac&#39;:    &lt;SYSTEM_MAC&gt;,</span>
<span class="sd">                 &#39;serialnumber&#39;: &lt;SERIAL_NUMBER&gt;,</span>
<span class="sd">                 &#39;neighbors&#39;:    &lt;NEIGHBORS&gt;        # see neighbors()</span>
<span class="sd">                }</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Node.has_startup_config"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.has_startup_config">[docs]</a>    <span class="k">def</span> <span class="nf">has_startup_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check whether startup-config is configured or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True is startup-config is configured; false otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">STARTUP_CONFIG</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="nb">open</span><span class="p">(</span><span class="n">STARTUP_CONFIG</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Node.append_startup_config_lines"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.append_startup_config_lines">[docs]</a>    <span class="k">def</span> <span class="nf">append_startup_config_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add lines to startup-config.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines (list): List of CLI commands</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_lines</span><span class="p">(</span><span class="n">STARTUP_CONFIG</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.append_rc_eos_lines"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.append_rc_eos_lines">[docs]</a>    <span class="k">def</span> <span class="nf">append_rc_eos_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add lines to rc.eos.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines (list): List of bash commands</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_rc_eos</span><span class="p">():</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;#!/bin/bash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_lines</span><span class="p">(</span><span class="n">RC_EOS</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.log_msg"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.log_msg">[docs]</a>    <span class="k">def</span> <span class="nf">log_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Log message via configured syslog/XMPP.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (string): Message</span>
<span class="sd">            error (bool, optional): True if msg is an error; false otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.rc_eos"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.rc_eos">[docs]</a>    <span class="k">def</span> <span class="nf">rc_eos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get rc.eos path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: rc.eos path</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">RC_EOS</span>
</div>
<div class="viewcode-block" id="Node.flash"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.flash">[docs]</a>    <span class="k">def</span> <span class="nf">flash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get flash path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: flash path</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">FLASH</span>
</div>
<div class="viewcode-block" id="Node.startup_config"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.startup_config">[docs]</a>    <span class="k">def</span> <span class="nf">startup_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get startup-config path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: startup-config path</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">STARTUP_CONFIG</span>
</div>
<div class="viewcode-block" id="Node.retrieve_url"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.retrieve_url">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Download resource from server.</span>

<span class="sd">        If &#39;path&#39; is somewhere on flash and &#39;url&#39; points back to</span>
<span class="sd">        SERVER, then the client will request the metadata for</span>
<span class="sd">        the resource from the server (in order to check whether there</span>
<span class="sd">        is enogh disk space available). If &#39;url&#39; points to a different</span>
<span class="sd">        server, then the &#39;content-length&#39; header will be used for the</span>
<span class="sd">        disk space checks.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ZtpError: resource cannot be retrieved:</span>
<span class="sd">                - metadata cannot be retrieved from server OR</span>
<span class="sd">                - metadata is inconsistent with request OR</span>
<span class="sd">                - disk space on flash is insufficient OR</span>
<span class="sd">                - file cannot be written to disk</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: startup-config path</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Node.create_user"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.create_user">[docs]</a>    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s">&#39;/persist/local/&#39;</span><span class="p">,</span>
                    <span class="n">ssh_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a local user on the bootstrapped node. If &#39;ssh_keys&#39; are</span>
<span class="sd">        provided, they will be copied to $HOME/.ssh/authorized_keys. Also,</span>
<span class="sd">        rc.eos will be modified to add this user on every boot. If the user</span>
<span class="sd">        provided already exists, the function will continue and install the</span>
<span class="sd">        ssh_keys (if necessary). The $HOME/.ssh directory will be assigned</span>
<span class="sd">        0700 permissions and the $HOME/.ssh/authorized_keys file will be</span>
<span class="sd">        assigned 0600 permissions in accord with SSH best practices.</span>

<span class="sd">        Args:</span>
<span class="sd">         - user: the username</span>
<span class="sd">         - group: the group assigned to the user</span>
<span class="sd">         - passwd: cleartext password</span>
<span class="sd">         - root: the path where the user&#39;s home directory will reside</span>
<span class="sd">         - ssh_keys: (optional) public keys that will be copied to</span>
<span class="sd">           ~$HOME/.ssh/authorized_keys</span>

<span class="sd">        Raises:</span>
<span class="sd">            ZtpError</span>
<span class="sd">            - missing argument: user, group, passwd</span>
<span class="sd">            - useradd fails, return the error</span>
<span class="sd">            - ssh_keys cannot be written to &#39;authorized_keys&#39;</span>
<span class="sd">            - files cannot change ownership or permissions</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if user created; False if otherwise</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;A user must be provided for create_user()&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;A group must be provided for create_user()&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">passwd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;A passwd must be provided for create_user()&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="s">&#39;/persist/local/&#39;</span>

        <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">ssh_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s">&#39;.ssh&#39;</span><span class="p">)</span>
        <span class="n">auth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">,</span> <span class="s">&#39;authorized_keys&#39;</span><span class="p">)</span>

        <span class="c"># Encrypt password</span>
        <span class="n">enc_passwd</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">.</span><span class="n">crypt</span><span class="p">(</span><span class="n">passwd</span><span class="p">,</span> <span class="s">&quot;22&quot;</span><span class="p">)</span>

        <span class="n">add_cmd</span> <span class="o">=</span> <span class="s">&#39;sudo useradd -p </span><span class="si">%s</span><span class="s"> -d </span><span class="si">%s</span><span class="s"> -G </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">enc_passwd</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span>
                                                         <span class="n">group</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

        <span class="c"># Create user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">add_cmd</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
                                    <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>       <span class="c">#pylint: disable=E1101</span>

            <span class="k">if</span> <span class="n">return_code</span> <span class="ow">or</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">return_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_msg</span><span class="p">(</span><span class="s">&#39;User already exists - continuing. (</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">)&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">return_code</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;Failed to add user.(</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">)&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">return_code</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

        <span class="c"># Get User ID and Group ID for chown</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>

        <span class="c"># Write keys if provided</span>
        <span class="k">if</span> <span class="n">ssh_keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">home</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>

            <span class="n">auth_keys</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">auth_path</span><span class="p">,</span> <span class="s">&#39;ab+&#39;</span><span class="p">)</span>
            <span class="n">auth_keys</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ssh_keys</span><span class="p">)</span>
            <span class="n">auth_keys</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">auth_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">auth_path</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_rc_eos_lines</span><span class="p">([</span><span class="n">add_cmd</span><span class="p">])</span>

        <span class="k">return</span>

</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.server_address"><a class="viewcode-back" href="../../client.html#client.bootstrap.Node.server_address">[docs]</a>    <span class="k">def</span> <span class="nf">server_address</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get ZTP Server URL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: ZTP Server URL.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">SERVER</span>

</div></div>
<span class="k">class</span> <span class="nc">SyslogManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;ztpbootstrap&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;ZTPS - </span><span class="si">%(levelname)s</span><span class="s">: &#39;</span>
                                           <span class="s">&#39;</span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># syslog to localhost enabled by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_syslog_handler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="s">&#39;DEBUG&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;SyslogManager: unknown logging level (</span><span class="si">%s</span><span class="s">) - using &#39;</span>
                <span class="s">&#39;log.DEFAULT instead&#39;</span> <span class="o">%</span> <span class="n">level</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_syslog_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;SyslogManager: adding localhost handler&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_handler</span><span class="p">(</span><span class="n">SysLogHandler</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">SYSLOG</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_file_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;SyslogManager: adding file handler (</span><span class="si">%s</span><span class="s"> - level:</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_handler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_remote_syslog_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;SyslogManager: adding remote handler (</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> - level:</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_handler</span><span class="p">(</span><span class="n">SysLogHandler</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)),</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler_config</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">handler_config</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^file:(.+)&#39;</span><span class="p">,</span>
                             <span class="n">entry</span><span class="p">[</span><span class="s">&#39;destination&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_file_handler</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span> <span class="mi">0</span> <span class="p">],</span>
                                       <span class="n">entry</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^(.+):(.+)&#39;</span><span class="p">,</span>
                                 <span class="n">entry</span><span class="p">[</span><span class="s">&#39;destination&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_remote_syslog_handler</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span> <span class="mi">0</span> <span class="p">],</span>
                                                    <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span> <span class="mi">1</span> <span class="p">]),</span>
                                                    <span class="n">entry</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_remote_syslog_handler</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s">&#39;destination&#39;</span><span class="p">],</span>
                                                    <span class="n">DEFAULT_SYSLOG_PORT</span><span class="p">,</span>
                                                    <span class="n">entry</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_http_request</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">request_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">request_files</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>   <span class="c">#pylint: disable=E1103</span>
            <span class="n">full_url</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full_url</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;get&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;GET </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">full_url</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">full_url</span><span class="p">,</span>
                                        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span>
                                        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                        <span class="n">files</span><span class="o">=</span><span class="n">request_files</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="n">HTTP_TIMEOUT</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;post&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;POST </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">full_url</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">full_url</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span>
                                         <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                         <span class="n">files</span><span class="o">=</span><span class="n">request_files</span><span class="p">,</span>
                                         <span class="n">timeout</span><span class="o">=</span><span class="n">HTTP_TIMEOUT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;Unknown method </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;server connection error&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_get_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="c"># resource or action</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Server response to GET request: status=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_file_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FLASH</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;attempting to save file to </span><span class="si">%s</span><span class="s">, but cannot&#39;</span>
                               <span class="s">&#39;retrieve content metadata&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s">&#39;content-length&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-length&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">SERVER</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;&quot;content-length&quot; for </span><span class="si">%s</span><span class="s"> does not match &#39;</span>
                                   <span class="s">&#39;metadata: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">))</span>

            <span class="n">usage</span> <span class="o">=</span> <span class="n">flash_usage</span><span class="p">()</span>

            <span class="n">free_space</span> <span class="o">=</span> <span class="n">usage</span><span class="o">.</span><span class="n">free</span>
            <span class="n">potential_used_space</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">usage</span><span class="o">.</span><span class="n">used</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">free_space</span> <span class="o">+=</span> <span class="n">size</span>
                <span class="n">potential_used_space</span> <span class="o">-=</span> <span class="n">size</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">free_space</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;not enough memory on flash for saving </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s"> &#39;</span>
                               <span class="s">&#39;(free: </span><span class="si">%s</span><span class="s"> bytes, required: </span><span class="si">%s</span><span class="s"> bytes)&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">free_space</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">potential_used_space</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">usage</span><span class="o">.</span><span class="n">total</span><span class="p">):</span>
                <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">usage</span><span class="o">.</span><span class="n">used</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">usage</span><span class="o">.</span><span class="n">total</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;WARNING: flash disk usage will exceeed </span><span class="si">%s%%</span><span class="s"> after &#39;</span>
                    <span class="s">&#39;saving </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Writing </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="c"># Save contents to file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;unable to write </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

        <span class="c"># Set permissions</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mo">0777</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_request</span><span class="p">(</span><span class="s">&#39;bootstrap/config&#39;</span><span class="p">,</span>
                                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Server response to GET config: contents=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HTTP_STATUS_OK</span> <span class="ow">or</span>
           <span class="n">content</span> <span class="o">!=</span> <span class="n">CONTENT_TYPE_JSON</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                <span class="s">&#39;unexpected reponse from server (status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_JSON</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_request</span><span class="p">(</span><span class="s">&#39;nodes&#39;</span><span class="p">,</span>
                                    <span class="n">method</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">,</span>
                                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                    <span class="n">payload</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="s">&#39;location&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">headers</span> \
            <span class="k">else</span> <span class="bp">None</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Server response to POST nodes: status=</span><span class="si">%s</span><span class="s">, location=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">location</span><span class="p">))</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">HTTP_STATUS_CREATED</span><span class="p">,</span>
                          <span class="n">HTTP_STATUS_BAD_REQUEST</span><span class="p">,</span>
                          <span class="n">HTTP_STATUS_CONFLICT</span><span class="p">]</span> <span class="ow">or</span>
           <span class="n">content</span> <span class="o">!=</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                <span class="s">&#39;unexpected reponse from server (status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_BAD_REQUEST</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;node not found on server (status=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_request</span><span class="p">(</span><span class="n">location</span><span class="p">,</span>
                                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTP_STATUS_OK</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Server response to GET definition: status=</span><span class="si">%s</span><span class="s">, contents=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Server response to GET definition: status=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_OK</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_JSON</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_BAD_REQUEST</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                <span class="s">&#39;unexpected reponse from server (status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_BAD_REQUEST</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;server-side topology check failed (status=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                           <span class="n">status</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">action_response</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_request</span><span class="p">(</span><span class="s">&#39;actions/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_OK</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_PYTHON</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                <span class="s">&#39;unexpected reponse from server (status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;action not found on server (status=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMP</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_contents</span><span class="p">(</span><span class="n">action_response</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>   <span class="c">#pylint: disable=E1103</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span> <span class="s">&#39;/meta&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;meta&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">aux</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Server response to GET meta: contents=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_OK</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_JSON</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_INTERNAL_SERVER_ERROR</span> <span class="ow">and</span>
                 <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                <span class="s">&#39;unexpected reponse from server (status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;metadata not found on server (status=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                           <span class="n">status</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_INTERNAL_SERVER_ERROR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span>
                <span class="s">&#39;unable to retrieve metadata from server (status=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                <span class="n">status</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>     <span class="c">#pylint: disable=E1103</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url_path_join</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">SERVER</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_OK</span> <span class="ow">and</span>
                     <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_OTHER</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span> <span class="ow">and</span>
                     <span class="n">content</span> <span class="o">==</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                    <span class="s">&#39;unexpected reponse from server for </span><span class="si">%s</span><span class="s"> &#39;</span>
                    <span class="s">&#39;(status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_OK</span> <span class="ow">or</span>
                    <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ZtpUnexpectedServerResponseError</span><span class="p">(</span>
                    <span class="s">&#39;unexpected reponse from server for </span><span class="si">%s</span><span class="s"> &#39;</span>
                    <span class="s">&#39;(status=</span><span class="si">%s</span><span class="s">; content-type=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTP_STATUS_NOT_FOUND</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;resource </span><span class="si">%s</span><span class="s"> not found on server (status=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_contents</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">XmppClient</span><span class="p">(</span><span class="n">sleekxmpp</span><span class="o">.</span><span class="n">ClientXMPP</span><span class="p">):</span>
    <span class="c">#pylint: disable=W0613, R0904, R0201, R0924</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">rooms</span><span class="p">,</span>
                 <span class="n">nick</span><span class="p">,</span> <span class="n">xmpp_server</span><span class="p">,</span> <span class="n">xmpp_port</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_jid</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sleekxmpp</span><span class="o">.</span><span class="n">ClientXMPP</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_jid</span><span class="p">,</span>
                                          <span class="n">password</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sleekxmpp</span><span class="o">.</span><span class="n">jid</span><span class="o">.</span><span class="n">InvalidJID</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Unable to connect XMPP client because of invalid jid: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_jid</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_nick</span> <span class="o">=</span>  <span class="n">nick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_rooms</span> <span class="o">=</span> <span class="n">rooms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_rooms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">room</span> <span class="ow">in</span> <span class="n">rooms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_rooms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">@conference.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">domain</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="s">&#39;session_start&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_connected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="s">&#39;connect&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_connected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_disconnected</span><span class="p">)</span>

        <span class="c"># Multi-User Chat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="s">&#39;xep_0045&#39;</span><span class="p">)</span>
        <span class="c"># XMPP Ping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="s">&#39;xep_0199&#39;</span><span class="p">)</span>
        <span class="c"># Service Discovery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="s">&#39;xep_0030&#39;</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="s">&#39;XmppClient connecting to server...&#39;</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xmpp_server</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">xmpp_server</span><span class="p">,</span> <span class="n">xmpp_port</span><span class="p">),</span> <span class="n">reattempt</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reattempt</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="n">retries</span><span class="p">:</span>
            <span class="c"># Wait to connect</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_session_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;XmppClient: Session connected (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_jid</span><span class="p">,</span>
            <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_presence</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_roster</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Joining rooms</span>
        <span class="k">for</span> <span class="n">room</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_rooms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plugin</span><span class="p">[</span><span class="s">&#39;xep_0045&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">joinMUC</span><span class="p">(</span><span class="n">room</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_nick</span><span class="p">,</span>
                                            <span class="n">wait</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;XmppClient: Joined room </span><span class="si">%s</span><span class="s"> as </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_nick</span><span class="p">),</span>
                <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_session_disconnected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;XmppClient: Session disconnected (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_jid</span><span class="p">,</span>
            <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">room</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmpp_rooms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">mto</span><span class="o">=</span><span class="n">room</span><span class="p">,</span>
                              <span class="n">mbody</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                              <span class="n">mtype</span><span class="o">=</span><span class="s">&#39;groupchat&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">xmpp_client</span>                      <span class="c">#pylint: disable=W0603</span>

    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Applying server config&#39;</span><span class="p">)</span>


    <span class="c"># XMPP not configured yet</span>
    <span class="n">xmpp_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;xmpp&#39;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">global</span> <span class="n">XMPP_MSG_TYPE</span>                        <span class="c">#pylint: disable=W0603</span>
    <span class="n">XMPP_MSG_TYPE</span> <span class="o">=</span> <span class="n">xmpp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;msg_type&#39;</span><span class="p">,</span> <span class="s">&#39;debug&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">XMPP_MSG_TYPE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&#39;info&#39;</span><span class="p">]:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;XMPP configuration failed because of unexpected </span><span class="se">\&#39;</span><span class="s">msg_type</span><span class="se">\&#39;</span><span class="s">: &#39;</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s"> not in [</span><span class="se">\&#39;</span><span class="s">debug</span><span class="se">\&#39;</span><span class="s">, </span><span class="se">\&#39;</span><span class="s">info</span><span class="se">\&#39;</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="n">XMPP_MSG_TYPE</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xmpp_config</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Configuring XMPP&#39;</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">xmpp_config</span> <span class="ow">and</span>
                <span class="s">&#39;domain&#39;</span> <span class="ow">in</span> <span class="n">xmpp_config</span> <span class="ow">and</span>
                <span class="s">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">xmpp_config</span> <span class="ow">and</span>
                <span class="s">&#39;rooms&#39;</span> <span class="ow">in</span> <span class="n">xmpp_config</span> <span class="ow">and</span>
                <span class="n">xmpp_config</span><span class="p">[</span><span class="s">&#39;rooms&#39;</span><span class="p">]):</span>
                <span class="n">nick</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">system</span><span class="p">()[</span><span class="s">&#39;serialnumber&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nick</span><span class="p">:</span>
                    <span class="c"># vEOS might not have a serial number configured</span>
                    <span class="n">nick</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">system</span><span class="p">()[</span><span class="s">&#39;systemmac&#39;</span><span class="p">]</span>
                <span class="n">xmpp_client</span> <span class="o">=</span> <span class="n">XmppClient</span><span class="p">(</span><span class="n">xmpp_config</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
                                         <span class="n">xmpp_config</span><span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">],</span>
                                         <span class="n">xmpp_config</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span>
                                         <span class="n">xmpp_config</span><span class="p">[</span><span class="s">&#39;rooms&#39;</span><span class="p">],</span>
                                         <span class="n">nick</span><span class="p">,</span>
                                         <span class="n">xmpp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                         <span class="n">xmpp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;port&#39;</span><span class="p">,</span> <span class="mi">5222</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># XMPP not configured yet</span>
                <span class="n">log</span><span class="p">(</span><span class="s">&#39;XMPP configuration failed because server response &#39;</span>
                    <span class="s">&#39;is missing config details&#39;</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;No XMPP configuration received from server&#39;</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">log_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logging&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">log_config</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Configuring syslog&#39;</span><span class="p">)</span>
        <span class="n">syslog_manager</span><span class="o">.</span><span class="n">add_handlers</span><span class="p">(</span><span class="n">log_config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;No XMPP configuration received from server&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">execute_action</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">action_details</span><span class="p">,</span> <span class="n">special_attr</span><span class="p">):</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">action_details</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;description&#39;</span><span class="ow">in</span> <span class="n">action_details</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">action_details</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Downloading action </span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">description</span><span class="p">))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Executing action </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;onstart&#39;</span> <span class="ow">in</span> <span class="n">action_details</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Action </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">action_details</span><span class="p">[</span><span class="s">&#39;onstart&#39;</span><span class="p">]),</span>
            <span class="n">xmpp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_source</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">local_attr</span> <span class="o">=</span> <span class="n">action_details</span><span class="p">[</span><span class="s">&#39;attributes&#39;</span><span class="p">]</span> \
                     <span class="k">if</span> <span class="s">&#39;attributes&#39;</span> <span class="ow">in</span> <span class="n">action_details</span> \
                     <span class="k">else</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">Attributes</span><span class="p">(</span><span class="n">local_attr</span><span class="p">,</span> <span class="n">special_attr</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZtpActionError</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Action executed succesfully (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;onsuccess&#39;</span> <span class="ow">in</span> <span class="n">action_details</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Action </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">action_details</span><span class="p">[</span><span class="s">&#39;onsuccess&#39;</span><span class="p">]),</span>
                <span class="n">xmpp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>                  <span class="c">#pylint: disable=W0703</span>
        <span class="k">if</span> <span class="s">&#39;onfailure&#39;</span> <span class="ow">in</span> <span class="n">action_details</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&#39;Action </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">action_details</span><span class="p">[</span><span class="s">&#39;onfailure&#39;</span><span class="p">]),</span>
                <span class="n">xmpp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ZtpActionError</span><span class="p">(</span><span class="s">&#39;executing action failed (</span><span class="si">%s</span><span class="s">): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c">#pylint: disable=W0603,R0912,R0915</span>
    <span class="k">global</span> <span class="n">syslog_manager</span><span class="p">,</span> <span class="n">RESTORE_FACTORY_FLASH</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="s">&#39;bootstrap [options]&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--no-flash-factory-restore&#39;</span><span class="p">,</span> <span class="s">&#39;-n&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Do NOT restore flash config to factory default&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">RESTORE_FACTORY_FLASH</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_flash_factory_restore</span>

    <span class="n">flash_snapshot</span><span class="p">()</span>

    <span class="n">syslog_manager</span> <span class="o">=</span> <span class="n">SyslogManager</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">()</span>

    <span class="c"># Retrieve and apply logging/XMPP configuration from server</span>
    <span class="c"># XMPP not configured yet</span>
    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Retrieving config from server&#39;</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>

    <span class="c"># Creating node</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>

    <span class="c"># XMPP not configured yet</span>
    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Config retrieved from server&#39;</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">apply_config</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">node</span><span class="p">)</span>

    <span class="c"># Checking node on server</span>
    <span class="c"># XMPP not configured yet</span>
    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Collecting node information&#39;</span><span class="p">,</span> <span class="n">xmpp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">post_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">details</span><span class="p">())</span>

    <span class="c"># Get definition</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">definition</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">get_definition</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="c"># Execute actions</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">if</span> <span class="s">&#39;actions&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">actions</span><span class="se">\&#39;</span><span class="s"> section missing from definition&#39;</span><span class="p">)</span>

    <span class="n">definition_name</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Applying definition </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">definition_name</span><span class="p">)</span>

    <span class="n">special_attr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">special_attr</span><span class="p">[</span><span class="s">&#39;NODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">for</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">[</span><span class="s">&#39;actions&#39;</span><span class="p">]:</span>
        <span class="n">execute_action</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">special_attr</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="s">&#39;Definition </span><span class="si">%s</span><span class="s"> applied successfully&#39;</span> <span class="o">%</span> <span class="n">definition_name</span><span class="p">)</span>

    <span class="c"># Check for startup-config</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">has_startup_config</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ZtpError</span><span class="p">(</span><span class="s">&#39;startup configuration is missing at the end of the &#39;</span>
                       <span class="s">&#39;bootstrap process&#39;</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="s">&#39;ZTP bootstrap completed successfully!&#39;</span><span class="p">)</span>

    <span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">ZtpError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;&#39;&#39;Bootstrap process failed:</span>
<span class="s">   </span><span class="si">%s</span><span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span>
            <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;Bootstrap process keyboard-interrupted&#39;</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">log</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&#39;&#39;&#39;Bootstrap process failed because of unknown exception:</span>
<span class="s">   </span><span class="si">%s</span><span class="s">&#39;&#39;&#39;</span> <span class="o">%</span>
            <span class="n">exception</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">log</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Arista Networks.
      Last updated on Oct 13, 2015.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>